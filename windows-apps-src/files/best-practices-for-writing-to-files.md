---
title: ファイルに書き込むためのベスト プラクティス
description: FileIO と PathIO クラスのメソッドを記述するさまざまなファイルを使用するためのベスト プラクティスについて説明します。
ms.date: 02/06/2019
ms.topic: article
keywords: Windows 10, UWP
ms.localizationpriority: medium
ms.openlocfilehash: f8bed97e060015f92ff95c9f7d797bbcb83db431
ms.sourcegitcommit: 079801609165bc7eb69670d771a05bffe236d483
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/27/2019
ms.locfileid: "9115709"
---
# <a name="best-practices-for-writing-to-files"></a><span data-ttu-id="4bf42-104">ファイルに書き込むためのベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="4bf42-104">Best practices for writing to files</span></span>

**<span data-ttu-id="4bf42-105">重要な API</span><span class="sxs-lookup"><span data-stu-id="4bf42-105">Important APIs</span></span>**

* [**<span data-ttu-id="4bf42-106">FileIO クラス</span><span class="sxs-lookup"><span data-stu-id="4bf42-106">FileIO class</span></span>**](https://docs.microsoft.com/uwp/api/Windows.Storage.FileIO)
* [**<span data-ttu-id="4bf42-107">PathIO クラス</span><span class="sxs-lookup"><span data-stu-id="4bf42-107">PathIO class</span></span>**](https://docs.microsoft.com/uwp/api/windows.storage.pathio)

<span data-ttu-id="4bf42-108">[**FileIO**](https://docs.microsoft.com/uwp/api/Windows.Storage.FileIO)と[**PathIO**](https://docs.microsoft.com/uwp/api/windows.storage.pathio)クラスの**書き込み**メソッドを使用して、ファイル システムの I/O 操作を実行する場合、一般的な問題のセットに開発者が実行場合があります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-108">Developers sometimes run into a set of common problems when using the **Write** methods of the [**FileIO**](https://docs.microsoft.com/uwp/api/Windows.Storage.FileIO) and [**PathIO**](https://docs.microsoft.com/uwp/api/windows.storage.pathio) classes to perform file system I/O operations.</span></span> <span data-ttu-id="4bf42-109">たとえば、一般的な問題は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="4bf42-109">For example, common problems include:</span></span>

<span data-ttu-id="4bf42-110">• ファイルには、•、アプリは、メソッドのいずれかを呼び出すときに例外を受け取る部分的に書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-110">•   A file is partially written •   The app receives an exception when calling one of the methods.</span></span> <span data-ttu-id="4bf42-111">• の背後にある操作のままにします。ターゲット ファイル名のようなファイル名を持つ TMP ファイルを削除します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-111">•   The operations leave behind .TMP files  with a file name similar to the target file name.</span></span>

<span data-ttu-id="4bf42-112">[**FileIO**](https://docs.microsoft.com/uwp/api/Windows.Storage.FileIO)と[**PathIO**](https://docs.microsoft.com/uwp/api/windows.storage.pathio)クラスの**記述**方法を以下に示します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-112">The **Write** methods of the [**FileIO**](https://docs.microsoft.com/uwp/api/Windows.Storage.FileIO) and [**PathIO**](https://docs.microsoft.com/uwp/api/windows.storage.pathio) classes include the following:</span></span>

* **<span data-ttu-id="4bf42-113">WriteBufferAsync</span><span class="sxs-lookup"><span data-stu-id="4bf42-113">WriteBufferAsync</span></span>**
* **<span data-ttu-id="4bf42-114">WriteBytesAsync</span><span class="sxs-lookup"><span data-stu-id="4bf42-114">WriteBytesAsync</span></span>**
* **<span data-ttu-id="4bf42-115">WriteLinesAsync</span><span class="sxs-lookup"><span data-stu-id="4bf42-115">WriteLinesAsync</span></span>**
* **<span data-ttu-id="4bf42-116">WriteTextAsync</span><span class="sxs-lookup"><span data-stu-id="4bf42-116">WriteTextAsync</span></span>**

 <span data-ttu-id="4bf42-117">この記事では、それらを使用する方法とタイミングは開発者のこれらのメソッドのしくみの詳細をより深く理解を提供します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-117">This article provides details about how these methods work so developers understand better when and how to use them.</span></span> <span data-ttu-id="4bf42-118">この記事では、ガイドラインを提供し、すべての考えられるファイル I/O の問題のソリューションを提供しません。</span><span class="sxs-lookup"><span data-stu-id="4bf42-118">This article provides guidelines and does not attempt to provide a solution for all possible file I/O problems.</span></span> 

> [!NOTE]
> <span data-ttu-id="4bf42-119">この記事では、例やディスカッションで**FileIO**方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-119">This article focuses on the **FileIO** methods in examples and discussions.</span></span> <span data-ttu-id="4bf42-120">ただし、 **PathIO**メソッドと同様のパターンに従うし、この記事のガイダンスのほとんどはこれらのメソッドにも適用されます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-120">However, the **PathIO** methods follow a similar pattern and most of the guidance in this article applies to those methods too.</span></span> 

## <a name="conveience-vs-control"></a><span data-ttu-id="4bf42-121">コントロールと Conveience</span><span class="sxs-lookup"><span data-stu-id="4bf42-121">Conveience vs. control</span></span>

<span data-ttu-id="4bf42-122">[**StorageFile**](https://docs.microsoft.com/uwp/api/windows.storage.storagefile)オブジェクトは、Win32 のネイティブのプログラミング モデルのようなファイル ハンドルではありません。</span><span class="sxs-lookup"><span data-stu-id="4bf42-122">A [**StorageFile**](https://docs.microsoft.com/uwp/api/windows.storage.storagefile) object is not a file handle like the native Win32 programming model.</span></span> <span data-ttu-id="4bf42-123">代わりに、 [**StorageFile**](https://docs.microsoft.com/uwp/api/windows.storage.storagefile)は、その内容を操作するメソッドを持つファイルの表現です。</span><span class="sxs-lookup"><span data-stu-id="4bf42-123">Instead, a [**StorageFile**](https://docs.microsoft.com/uwp/api/windows.storage.storagefile) is a representation of a file with methods to manipulate its contents.</span></span>

<span data-ttu-id="4bf42-124">**StorageFile**と I/O を実行する場合は、この概念を理解すると便利です。</span><span class="sxs-lookup"><span data-stu-id="4bf42-124">Understanding this concept is useful when performing I/O with a **StorageFile**.</span></span> <span data-ttu-id="4bf42-125">たとえば、[ファイルへの書き込み](quickstart-reading-and-writing-files.md#writing-to-a-file)] セクションでは、ファイルへの書き込みを 3 つの方法が表示されます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-125">For example, the [Writing to a file](quickstart-reading-and-writing-files.md#writing-to-a-file) section presents three ways to write to a file:</span></span>

* <span data-ttu-id="4bf42-126">[**FileIO.WriteTextAsync**](https://docs.microsoft.com/uwp/api/windows.storage.fileio.writetextasync)メソッドを使用します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-126">Using the [**FileIO.WriteTextAsync**](https://docs.microsoft.com/uwp/api/windows.storage.fileio.writetextasync) method.</span></span>
* <span data-ttu-id="4bf42-127">バッファーを作成し、し[**FileIO.WriteBufferAsync**](https://docs.microsoft.com/en-us/uwp/api/windows.storage.fileio.writebufferasync)メソッドを呼び出すことです。</span><span class="sxs-lookup"><span data-stu-id="4bf42-127">By creating a buffer and then calling the [**FileIO.WriteBufferAsync**](https://docs.microsoft.com/en-us/uwp/api/windows.storage.fileio.writebufferasync) method.</span></span>
* <span data-ttu-id="4bf42-128">ストリームを使用して、4 つのステップ モデルには:</span><span class="sxs-lookup"><span data-stu-id="4bf42-128">The four-step model using a stream:</span></span>
  1. <span data-ttu-id="4bf42-129">[開いている](https://docs.microsoft.com/uwp/api/windows.storage.storagefile.openasync)ファイル ストリームを取得します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-129">[Open](https://docs.microsoft.com/uwp/api/windows.storage.storagefile.openasync) the file to get a stream.</span></span>
  2. <span data-ttu-id="4bf42-130">[取得する](https://docs.microsoft.com/uwp/api/windows.storage.streams.irandomaccessstream.getoutputstreamat)出力ストリームをします。</span><span class="sxs-lookup"><span data-stu-id="4bf42-130">[Get](https://docs.microsoft.com/uwp/api/windows.storage.streams.irandomaccessstream.getoutputstreamat) an output stream.</span></span>
  3. <span data-ttu-id="4bf42-131">[**DataWriter**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datawriter)オブジェクトを作成し、対応する**書き込み**メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-131">Create a [**DataWriter**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datawriter) object and call the corresponding **Write** method.</span></span>
  4. <span data-ttu-id="4bf42-132">[コミット](https://docs.microsoft.com/uwp/api/windows.storage.streams.datawriter.storeasync)データ ライターと、出力ストリーム[をフラッシュ](https://docs.microsoft.com/uwp/api/windows.storage.streams.ioutputstream.flushasync)のデータ。</span><span class="sxs-lookup"><span data-stu-id="4bf42-132">[Commit](https://docs.microsoft.com/uwp/api/windows.storage.streams.datawriter.storeasync) the data in the data writer and [flush](https://docs.microsoft.com/uwp/api/windows.storage.streams.ioutputstream.flushasync) the output stream.</span></span>

<span data-ttu-id="4bf42-133">最初の 2 つのシナリオは、アプリで最もよく使用されるものです。</span><span class="sxs-lookup"><span data-stu-id="4bf42-133">The first two scenarios are the ones most commonly used by apps.</span></span> <span data-ttu-id="4bf42-134">1 つの操作でファイルへの書き込みが容易コードおよび管理するになり、また、アプリの責任ファイル I/O の複雑さの多くを扱うから削除します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-134">Writing to the file in a single operation is easier to code and maintain, and it also removes the responsibility of the app from dealing with many of the complexities of file I/O.</span></span> <span data-ttu-id="4bf42-135">ただし、この利便性はコストがかかる: 制御操作全体や特定の時点でのエラーをキャッチする機能が失われる。</span><span class="sxs-lookup"><span data-stu-id="4bf42-135">However, this convenience comes at a cost: the loss of control over the entire operation and the ability to catch errors at specific points.</span></span>

## <a name="the-transactional-model"></a><span data-ttu-id="4bf42-136">トランザクションのモデル</span><span class="sxs-lookup"><span data-stu-id="4bf42-136">The transactional model</span></span>

<span data-ttu-id="4bf42-137">[**FileIO**](https://docs.microsoft.com/uwp/api/Windows.Storage.FileIO)と[**PathIO**](https://docs.microsoft.com/uwp/api/windows.storage.pathio)クラスの**書き込み**メソッドは、追加のレイヤーを上記で説明した 3 つ目の書き込みモデルでの手順をラップします。</span><span class="sxs-lookup"><span data-stu-id="4bf42-137">The **Write** methods of the [**FileIO**](https://docs.microsoft.com/uwp/api/Windows.Storage.FileIO) and [**PathIO**](https://docs.microsoft.com/uwp/api/windows.storage.pathio) classes wrap the steps on the third write model described above, with an added layer.</span></span> <span data-ttu-id="4bf42-138">このレイヤーは、記憶域のトランザクションでカプセル化されます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-138">This layer is encapsulated in a storage transaction.</span></span>

<span data-ttu-id="4bf42-139">データの書き込み中に問題が発生する場合に備えて、元のファイルの整合性の保護、**書き込み**メソッドは[**OpenTransactedWriteAsync**](https://docs.microsoft.com/uwp/api/windows.storage.storagefile.opentransactedwriteasync)を使用してファイルを開くことによってトランザクション モデルを使用します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-139">To protect the integrity of the original file in case something goes wrong while writing the data, the **Write** methods use a transactional model by opening the file using [**OpenTransactedWriteAsync**](https://docs.microsoft.com/uwp/api/windows.storage.storagefile.opentransactedwriteasync).</span></span> <span data-ttu-id="4bf42-140">このプロセスは、 [**StorageStreamTransaction**](https://docs.microsoft.com/uwp/api/windows.storage.storagestreamtransaction)オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-140">This process creates a [**StorageStreamTransaction**](https://docs.microsoft.com/uwp/api/windows.storage.storagestreamtransaction) object.</span></span> <span data-ttu-id="4bf42-141">このトランザクション オブジェクトが作成されたら、Api は、[ファイルへのアクセス](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/FileAccess)のサンプルや[**StorageStreamTransaction**](https://docs.microsoft.com/uwp/api/windows.storage.storagestreamtransaction) 」の記事のコード例を次の同様の方法データを書き込みます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-141">After this transaction object is created, the APIs write the data following a similar fashion to the [File Access](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/FileAccess) sample or the code example in the [**StorageStreamTransaction**](https://docs.microsoft.com/uwp/api/windows.storage.storagestreamtransaction) article.</span></span>

<span data-ttu-id="4bf42-142">次の図は、基になるタスクによって実行される、成功の書き込み操作で**WriteTextAsync**メソッドです。</span><span class="sxs-lookup"><span data-stu-id="4bf42-142">The following diagram illustrates the underlying tasks performed by the the **WriteTextAsync** method in a successful write operation.</span></span> <span data-ttu-id="4bf42-143">次の図は、操作の簡素化されたビューを提供します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-143">This illustration provides a simplified view of the operation.</span></span> <span data-ttu-id="4bf42-144">たとえば、異なるスレッドでテキストのエンコードと非同期の完了などの手順をスキップします。</span><span class="sxs-lookup"><span data-stu-id="4bf42-144">For example, it skips steps such as text encoding and async completion on different threads.</span></span>

![ファイルへの書き込みの UWP API の呼び出しのシーケンス図](images/file-write-call-sequence.svg)

<span data-ttu-id="4bf42-146">ストリームを使用して、複雑な 4 つのステップ モデルではなく、 [**FileIO**](https://docs.microsoft.com/uwp/api/Windows.Storage.FileIO)と[**PathIO**](https://docs.microsoft.com/uwp/api/windows.storage.pathio)クラスの**書き込み**メソッドを使用する利点は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="4bf42-146">The advantages of using the **Write** methods of the [**FileIO**](https://docs.microsoft.com/uwp/api/Windows.Storage.FileIO) and [**PathIO**](https://docs.microsoft.com/uwp/api/windows.storage.pathio) classes instead of the more complex four-step model using a stream are:</span></span>

* <span data-ttu-id="4bf42-147">中間すべての手順をエラーを含むを処理する 1 つの API の呼び出しです。</span><span class="sxs-lookup"><span data-stu-id="4bf42-147">One API call to handle all the intermediate steps, including errors.</span></span>
* <span data-ttu-id="4bf42-148">問題が発生した場合、元のファイルが保持されます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-148">The original file is kept if something goes wrong.</span></span>
* <span data-ttu-id="4bf42-149">システムの状態は、可能な限りクリーンアップを保持するしようとしています。</span><span class="sxs-lookup"><span data-stu-id="4bf42-149">The system state will try to be kept as clean as possible.</span></span>

<span data-ttu-id="4bf42-150">ただし、すぎると考えられる中間障害点では、障害が発生した可能性が高くがあります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-150">However, with so many possible intermediate points of failure, there’s an increased chance of failure.</span></span> <span data-ttu-id="4bf42-151">エラーが発生した場合は、プロセスが失敗した場所がわかりにくい場合があります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-151">When an error occurs it may be difficult to understand where the process failed.</span></span> <span data-ttu-id="4bf42-152">次のセクションでは、いくつかの**書き込み**メソッドを使用する場合に発生し、可能な解決策を提供する可能性がありますエラーを示します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-152">The following sections present some of the failures you might encounter when using the **Write** methods and provide possible solutions.</span></span>

## <a name="common-error-codes-for-write-methods-of-the-fileio-and-pathio-classes"></a><span data-ttu-id="4bf42-153">FileIO と PathIO クラスの書き込みメソッドの一般的なエラー コード</span><span class="sxs-lookup"><span data-stu-id="4bf42-153">Common error codes for Write methods of the FileIO and PathIO classes</span></span>

<span data-ttu-id="4bf42-154">この表では、アプリの開発者が**書き込み**メソッドを使用する場合に発生する一般的なエラー コードを示します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-154">This table presents common error codes that app developers encounter when using the **Write** methods.</span></span> <span data-ttu-id="4bf42-155">テーブルの手順は、前の図の手順に対応します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-155">The steps in the table correspond to steps in the previous diagram.</span></span>

|  <span data-ttu-id="4bf42-156">エラーの名前 (value)</span><span class="sxs-lookup"><span data-stu-id="4bf42-156">Error name (value)</span></span>  |  <span data-ttu-id="4bf42-157">手順</span><span class="sxs-lookup"><span data-stu-id="4bf42-157">Steps</span></span>  |  <span data-ttu-id="4bf42-158">原因</span><span class="sxs-lookup"><span data-stu-id="4bf42-158">Causes</span></span>  |  <span data-ttu-id="4bf42-159">解決策</span><span class="sxs-lookup"><span data-stu-id="4bf42-159">Solutions</span></span>  |
|----------------------|---------|----------|-------------|
|  <span data-ttu-id="4bf42-160">ERROR_ACCESS_DENIED (0X80070005)</span><span class="sxs-lookup"><span data-stu-id="4bf42-160">ERROR_ACCESS_DENIED (0X80070005)</span></span>  |  <span data-ttu-id="4bf42-161">5</span><span class="sxs-lookup"><span data-stu-id="4bf42-161">5</span></span>  |  <span data-ttu-id="4bf42-162">元のファイルは、場合によって、以前の操作の削除対象としてマークする可能性があります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-162">The original file might be marked for deletion, possibly from a previous operation.</span></span>  |  <span data-ttu-id="4bf42-163">操作を再試行します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-163">Retry the operation.</span></span></br><span data-ttu-id="4bf42-164">ファイルへのアクセスが同期されることを確認します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-164">Ensure access to the file is synchronized.</span></span>  |
|  <span data-ttu-id="4bf42-165">ERROR_SHARING_VIOLATION (0X80070020)</span><span class="sxs-lookup"><span data-stu-id="4bf42-165">ERROR_SHARING_VIOLATION (0x80070020)</span></span>  |  <span data-ttu-id="4bf42-166">5</span><span class="sxs-lookup"><span data-stu-id="4bf42-166">5</span></span>  |  <span data-ttu-id="4bf42-167">専用の別の書き込みによっては、元のファイルが開きます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-167">The original file is opened by another exclusive write.</span></span>   |  <span data-ttu-id="4bf42-168">操作を再試行します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-168">Retry the operation.</span></span></br><span data-ttu-id="4bf42-169">ファイルへのアクセスが同期されることを確認します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-169">Ensure access to the file is synchronized.</span></span>  |
|  <span data-ttu-id="4bf42-170">ERROR_UNABLE_TO_REMOVE_REPLACED (0X80070497)</span><span class="sxs-lookup"><span data-stu-id="4bf42-170">ERROR_UNABLE_TO_REMOVE_REPLACED (0x80070497)</span></span>  |  <span data-ttu-id="4bf42-171">19 20</span><span class="sxs-lookup"><span data-stu-id="4bf42-171">19-20</span></span>  |  <span data-ttu-id="4bf42-172">使用されているために、元のファイル (file.txt) を置き換えることができませんでした。</span><span class="sxs-lookup"><span data-stu-id="4bf42-172">The original file (file.txt) could not be replaced because it is in use.</span></span> <span data-ttu-id="4bf42-173">別のプロセスまたは操作は、ファイルへのアクセスを獲得に置き換えることができます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-173">Another process or operation gained access to the file before it could be replaced.</span></span>  |  <span data-ttu-id="4bf42-174">操作を再試行します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-174">Retry the operation.</span></span></br><span data-ttu-id="4bf42-175">ファイルへのアクセスが同期されることを確認します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-175">Ensure access to the file is synchronized.</span></span>  |
|  <span data-ttu-id="4bf42-176">ERROR_DISK_FULL (0X80070070)</span><span class="sxs-lookup"><span data-stu-id="4bf42-176">ERROR_DISK_FULL (0x80070070)</span></span>  |  <span data-ttu-id="4bf42-177">7、14、16、20</span><span class="sxs-lookup"><span data-stu-id="4bf42-177">7, 14, 16, 20</span></span>  |  <span data-ttu-id="4bf42-178">トランザクションのモデル、余分なファイルを作成し、この余分な記憶域を消費します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-178">The transacted model creates an extra file, and this consumes extra storage.</span></span>  |    |
|  <span data-ttu-id="4bf42-179">ERROR_OUTOFMEMORY (0X8007000E)</span><span class="sxs-lookup"><span data-stu-id="4bf42-179">ERROR_OUTOFMEMORY (0x8007000E)</span></span>  |  <span data-ttu-id="4bf42-180">14、16</span><span class="sxs-lookup"><span data-stu-id="4bf42-180">14, 16</span></span>  |  <span data-ttu-id="4bf42-181">これは、問題は、複数の未処理の I/O 操作や大規模なファイル サイズの問題が発生します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-181">This can happen due to multiple outstanding I/O operations or large file sizes.</span></span>  |  <span data-ttu-id="4bf42-182">ストリームを制御することより詳細なアプローチでは、エラーを解決する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-182">A more granular approach by controlling the stream might resolve the error.</span></span>  |
|  <span data-ttu-id="4bf42-183">E_FAIL (0X80004005)</span><span class="sxs-lookup"><span data-stu-id="4bf42-183">E_FAIL (0x80004005)</span></span> |  <span data-ttu-id="4bf42-184">任意</span><span class="sxs-lookup"><span data-stu-id="4bf42-184">Any</span></span>  |  <span data-ttu-id="4bf42-185">その他</span><span class="sxs-lookup"><span data-stu-id="4bf42-185">Miscellaneous</span></span>  |  <span data-ttu-id="4bf42-186">操作を再試行します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-186">Retry the operation.</span></span> <span data-ttu-id="4bf42-187">まだに失敗した場合は、プラットフォーム エラー場合があり、不整合な状態であるため、アプリが終了する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-187">If it still fails, it might be a platform error and the app should terminate because it's in an inconsistent state.</span></span> |

## <a name="other-considerations-for-file-states-that-might-lead-to-errors"></a><span data-ttu-id="4bf42-188">エラーにつながる可能性のあるファイルの状態に関するその他の考慮事項</span><span class="sxs-lookup"><span data-stu-id="4bf42-188">Other considerations for file states that might lead to errors</span></span>

<span data-ttu-id="4bf42-189">**書き込み**メソッドによって返されたエラー、またお客様には、ファイルに書き込むときに、アプリに期待のガイドラインをいくつかを次に示します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-189">Apart from errors returned by the **Write** methods, here are some guidelines on what an app can expect when writing to a file.</span></span>

### <a name="data-was-written-to-the-file-if-and-only-if-operation-completed"></a><span data-ttu-id="4bf42-190">操作が完了した場合にのみファイルにデータが書き込まれました。</span><span class="sxs-lookup"><span data-stu-id="4bf42-190">Data was written to the file if and only if operation completed</span></span>

<span data-ttu-id="4bf42-191">アプリしないでくださいデータに関するすべての前提ファイルの書き込み操作が進行中。</span><span class="sxs-lookup"><span data-stu-id="4bf42-191">Your app should not make any assumption about data in the file while a write operation is in progress.</span></span> <span data-ttu-id="4bf42-192">一貫性のないデータを招く可能性が操作が完了する前に、ファイルにアクセスしようとしています。</span><span class="sxs-lookup"><span data-stu-id="4bf42-192">Trying to access the file before an operation completes might lead to inconsistent data.</span></span> <span data-ttu-id="4bf42-193">アプリは、未処理の I/o を追跡の担当する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-193">Your app should be responsible of tracking outstanding I/Os.</span></span>

### <a name="readers"></a><span data-ttu-id="4bf42-194">リーダー</span><span class="sxs-lookup"><span data-stu-id="4bf42-194">Readers</span></span>

<span data-ttu-id="4bf42-195">ファイルに書き込まれてもは、ていねいリーダーで使用されている場合 (つまり、 [**FileAccessMode.Read**](https://docs.microsoft.com/uwp/api/Windows.Storage.FileAccessMode)で開くと、後続の読み取りエラーで失敗、ERROR_OPLOCK_HANDLE_CLOSED (0x80070323)。</span><span class="sxs-lookup"><span data-stu-id="4bf42-195">If the file that being written to is also being used by a polite reader (that is, opened with [**FileAccessMode.Read**](https://docs.microsoft.com/uwp/api/Windows.Storage.FileAccessMode), subsequent reads will fail with an error ERROR_OPLOCK_HANDLE_CLOSED (0x80070323).</span></span> <span data-ttu-id="4bf42-196">場合によってアプリでは、**書き込み**操作の進行中に読み取りのファイルをもう一度開く再試行してください。</span><span class="sxs-lookup"><span data-stu-id="4bf42-196">Sometimes apps retry opening the file for read again while the **Write** operation is ongoing.</span></span> <span data-ttu-id="4bf42-197">これにより、競合状態を**記述**する置き換えができないため、元のファイルを上書きしようとしたとき最終的に失敗した可能性があります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-197">This might result in a race condition on which the **Write** ultimately fails when trying to overwrite the original file because it cannot be replaced.</span></span>

### <a name="files-from-knownfolders"></a><span data-ttu-id="4bf42-198">KnownFolders からのファイル</span><span class="sxs-lookup"><span data-stu-id="4bf42-198">Files from KnownFolders</span></span>

<span data-ttu-id="4bf42-199">アプリは、 [**KnownFolders**](https://docs.microsoft.com/uwp/api/Windows.Storage.KnownFolders)のいずれかの上にあるファイルにアクセスしようとする唯一のアプリをできない可能性があります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-199">Your app might not be the only app that is trying to access a file that resides on any of the [**KnownFolders**](https://docs.microsoft.com/uwp/api/Windows.Storage.KnownFolders).</span></span> <span data-ttu-id="4bf42-200">保証、操作が成功した場合は、アプリがファイルに記述内容が一定のままですが、ファイルを読み取ろうとした、次回はありません。</span><span class="sxs-lookup"><span data-stu-id="4bf42-200">There’s no guarantee that if the operation is successful, the contents an app wrote to the file will remain constant the next time it tries to read the file.</span></span> <span data-ttu-id="4bf42-201">また、共有またはへのアクセスにこのシナリオで一般的なエラーを拒否されます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-201">Also, sharing or access denied errors become more common under this scenario.</span></span>

### <a name="conflicting-io"></a><span data-ttu-id="4bf42-202">競合する I/O</span><span class="sxs-lookup"><span data-stu-id="4bf42-202">Conflicting I/O</span></span>

<span data-ttu-id="4bf42-203">アプリのローカル データ内のファイルの**書き込み**メソッドを使用していて、いくつか注意が必要、同時実行のエラーの可能性を下げることができます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-203">The chances of concurrency errors can be lowered if our app uses the **Write** methods for files in its local data, but some caution is still required.</span></span> <span data-ttu-id="4bf42-204">複数の**書き込み**操作は、ファイルを同時に送信されるが場合、は、ファイルにどのようなデータが最終的には保証されません。</span><span class="sxs-lookup"><span data-stu-id="4bf42-204">If multiple **Write** operations are being sent concurrently to the file, there’s no guarantee about what data ends up in the file.</span></span> <span data-ttu-id="4bf42-205">これを軽減するためには、ファイルへの**書き込み**操作がアプリにシリアル化をお勧めします。</span><span class="sxs-lookup"><span data-stu-id="4bf42-205">To mitigate this, we recommend that your app serializes **Write** operations to the file.</span></span>

### <a name="tmp-files"></a><span data-ttu-id="4bf42-206">~ TMP ファイル</span><span class="sxs-lookup"><span data-stu-id="4bf42-206">~TMP files</span></span>

<span data-ttu-id="4bf42-207">場合によっては、(たとえば、するアプリが中断または終了、OS によって場合)、操作が強制的に取り消された場合、トランザクションまたはされていないコミット適切に終了します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-207">Occasionally, if the operation is forcefully cancelled (for example, if the app was suspended or terminated by the OS), the transaction is not committed or closed appropriately.</span></span> <span data-ttu-id="4bf42-208">ファイルの背後にあるこのままでかまいません、(. ~ TMP) 拡張機能です。</span><span class="sxs-lookup"><span data-stu-id="4bf42-208">This can leave behind files with a (.~TMP) extension.</span></span> <span data-ttu-id="4bf42-209">これらの一時ファイルを削除する (存在する場合、アプリのローカル データ) を検討してください。 アプリのアクティブ化を処理する場合。</span><span class="sxs-lookup"><span data-stu-id="4bf42-209">Consider deleting these temporary files (if they exist in the app's local data) when handling the app activation.</span></span>

## <a name="considerations-based-on-file-types"></a><span data-ttu-id="4bf42-210">ファイルの種類に基づいてに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="4bf42-210">Considerations based on file types</span></span>

<span data-ttu-id="4bf42-211">いくつかのエラーは、ファイルにアクセス中、頻度と、ファイル サイズの種類に応じてより一般的なになることができます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-211">Some errors can become more prevalent depending on the type of files, the frequency on which they’re accessed, and their file size.</span></span> <span data-ttu-id="4bf42-212">一般に、アプリがアクセスできるファイルの 3 つのカテゴリがあります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-212">Generally, there are three categories of files your app can access:</span></span>

* <span data-ttu-id="4bf42-213">ファイルが作成され、アプリのローカル データ フォルダー内のユーザーを編集します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-213">Files created and edited by the user in your app's local data folder.</span></span> <span data-ttu-id="4bf42-214">これらを作成し、アプリを使用している場合にのみを編集し、アプリ内でのみ存在します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-214">These are created and edited only while using your app, and they exist only within the app.</span></span>
* <span data-ttu-id="4bf42-215">アプリのメタデータ。</span><span class="sxs-lookup"><span data-stu-id="4bf42-215">App metadata.</span></span> <span data-ttu-id="4bf42-216">アプリでは、独自の状態を追跡するのにこれらのファイルを使用します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-216">Your app uses these files to keep track of its own state.</span></span>
* <span data-ttu-id="4bf42-217">アプリがアクセスする機能を宣言されているファイル システムの場所にその他のファイル。</span><span class="sxs-lookup"><span data-stu-id="4bf42-217">Other files in locations of the file system where your app has declared capabilities to access.</span></span> <span data-ttu-id="4bf42-218">これらは、最もよく、 [**KnownFolders**](https://docs.microsoft.com/uwp/api/Windows.Storage.KnownFolders)のいずれかにあります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-218">These are most commonly located in one of the [**KnownFolders**](https://docs.microsoft.com/uwp/api/Windows.Storage.KnownFolders).</span></span>

<span data-ttu-id="4bf42-219">アプリでは、アプリのパッケージ ファイルの一部になっているし、は、アプリによってのみアクセスするために、ファイルの最初の 2 つのカテゴリの完全なコントロールがあります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-219">Your app has full control on the first two categories of files, because they’re part of your app's package files and are accessed by your app exclusively.</span></span> <span data-ttu-id="4bf42-220">最後の項目内のファイル、アプリが、他のアプリと OS のサービスがファイルにアクセスする同時に注意してくださいである必要があります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-220">For files in the last category, your app must be aware that other apps and OS services may be accessing the files concurrently.</span></span>

<span data-ttu-id="4bf42-221">アプリによっては、ファイルへのアクセスは頻度の異なることができます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-221">Depending on the app, access to the files can vary on frequency:</span></span>

* <span data-ttu-id="4bf42-222">非常に低いします。</span><span class="sxs-lookup"><span data-stu-id="4bf42-222">Very low.</span></span> <span data-ttu-id="4bf42-223">これらは、通常、とき、アプリの起動とが保存されると、アプリが中断されたときに開いているファイルです。</span><span class="sxs-lookup"><span data-stu-id="4bf42-223">These are usually files that are opened once when the app launches and are saved when the app is suspended.</span></span>
* <span data-ttu-id="4bf42-224">低します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-224">Low.</span></span> <span data-ttu-id="4bf42-225">これらは、ユーザーは、具体的には、に対してアクションを実行 (保存または読み込みなど) のファイルです。</span><span class="sxs-lookup"><span data-stu-id="4bf42-225">These are files that the user is specifically taking an action on (such as save or load).</span></span>
* <span data-ttu-id="4bf42-226">中程度またはハイします。</span><span class="sxs-lookup"><span data-stu-id="4bf42-226">Medium or high.</span></span> <span data-ttu-id="4bf42-227">これらは、アプリに更新する必要がありますのデータ (たとえば、自動機能または定数のメタデータを追跡) 常にファイルです。</span><span class="sxs-lookup"><span data-stu-id="4bf42-227">These are files in which the app must constantly update data (for example, autosave features or constant metadata tracking).</span></span>

<span data-ttu-id="4bf42-228">ファイルのサイズ、 **WriteBytesAsync**メソッドでは、次のグラフ内のパフォーマンス データを検討してください。</span><span class="sxs-lookup"><span data-stu-id="4bf42-228">For file size, consider the performance data in the following chart for the **WriteBytesAsync** method.</span></span> <span data-ttu-id="4bf42-229">このグラフでは、10000 操作管理された環境でのファイル サイズごとの平均パフォーマンス経由で操作 vs ファイルのサイズを完了する時間を比較します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-229">This chart compares the time to complete an operation vs file size, over an average performance of 10000 operations per file size in a controlled environment.</span></span>

![WriteBytesAsync パフォーマンス](images/writebytesasync-performance.png)

<span data-ttu-id="4bf42-231">Y 軸の時間の値は、さまざまなハードウェアと構成別の絶対時刻の値が生成されますのでこのグラフから意図的に省略されます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-231">The time values on the y-axis are omitted intentionally from this chart because different hardware and configurations will yield different absolute time values.</span></span> <span data-ttu-id="4bf42-232">ただし、マイクロソフトによるテストでこれらの傾向を監視していた一貫しています。</span><span class="sxs-lookup"><span data-stu-id="4bf42-232">However, we have consistently observed these trends in our tests:</span></span>

* <span data-ttu-id="4bf42-233">非常に小さいファイル (_lt _ = 1 MB): 操作を完了するには一貫して高速です。</span><span class="sxs-lookup"><span data-stu-id="4bf42-233">For very small files (<= 1 MB): The time to complete the operations is consistently fast.</span></span>
* <span data-ttu-id="4bf42-234">大きなファイル (_gt 1 MB): 急激に増加する操作を完了する時間を開始します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-234">For larger files (> 1 MB): The time to complete the operations starts to increase exponentially.</span></span>

## <a name="io-during-app-suspension"></a><span data-ttu-id="4bf42-235">アプリの中断中の I/O</span><span class="sxs-lookup"><span data-stu-id="4bf42-235">I/O during app suspension</span></span>

<span data-ttu-id="4bf42-236">アプリは必要がありますの中断の処理する場合の状態情報を保持するまたはメタデータ後のセッションで使用するために設計されています。</span><span class="sxs-lookup"><span data-stu-id="4bf42-236">Your app must designed to handle suspension if you want to keep state information or metadata for use in later sessions.</span></span> <span data-ttu-id="4bf42-237">アプリの中断に関する背景情報は、[アプリのライフ サイクル](../launch-resume/app-lifecycle.md)と[このブログ記事](https://blogs.windows.com/buildingapps/2016/04/28/the-lifecycle-of-a-uwp-app/#qLwdmV5zfkAPMEco.97)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="4bf42-237">For background information about app suspension, see [App lifecycle](../launch-resume/app-lifecycle.md) and [this blog post](https://blogs.windows.com/buildingapps/2016/04/28/the-lifecycle-of-a-uwp-app/#qLwdmV5zfkAPMEco.97).</span></span>

<span data-ttu-id="4bf42-238">OS がアプリでは、延長実行を許可しない限り、そのすべてのリソースを解放し、そのデータを保存するには、5 秒間、アプリが中断されたときがあります。</span><span class="sxs-lookup"><span data-stu-id="4bf42-238">Unless the OS grants extended execution to your app, when your app is suspended it has 5 seconds to release all its resources and save its data.</span></span> <span data-ttu-id="4bf42-239">最適な信頼性とユーザー エクスペリエンス、常に一時停止のタスクを処理する必要が時間が限られていると仮定します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-239">For the best reliability and user experience, always assume the time you have to handle suspension tasks is limited.</span></span> <span data-ttu-id="4bf42-240">5 秒間の一時停止のタスクを処理するための期間中に、次のガイドラインを考慮してください。</span><span class="sxs-lookup"><span data-stu-id="4bf42-240">Keep in mind the following guidelines during the 5 second time period for handling suspension tasks:</span></span>

* <span data-ttu-id="4bf42-241">I/O をフラッシュとリリースの操作による競合を回避するために最小限に抑えるしようとしてください。</span><span class="sxs-lookup"><span data-stu-id="4bf42-241">Try to keep I/O to a minimum to avoid race conditions caused by flushing and release operations.</span></span>
* <span data-ttu-id="4bf42-242">何百もミリ秒以上を記述するを必要とするファイルの記述しないでください。</span><span class="sxs-lookup"><span data-stu-id="4bf42-242">Avoid writing files that require hundreds of milliseconds or more to write.</span></span>
* <span data-ttu-id="4bf42-243">アプリは、**書き込み**メソッドを使用している場合は、これらのメソッドを必要とするすべての中間手順に留意してください。</span><span class="sxs-lookup"><span data-stu-id="4bf42-243">If your app uses the **Write** methods, keep in mind all the intermediate steps that these methods require.</span></span>

<span data-ttu-id="4bf42-244">場合は、少量の状態データでは、変換されたアプリは中断された動作、ほとんどの場合できますメソッドを使って**書き込み**データをフラッシュします。</span><span class="sxs-lookup"><span data-stu-id="4bf42-244">If your app operates on a small amount of state data during suspension, in most cases you can use the **Write** methods to flush the data.</span></span> <span data-ttu-id="4bf42-245">ただし、アプリは、大量の状態データを使用している場合は、直接データを格納するストリームを使用して検討してください。</span><span class="sxs-lookup"><span data-stu-id="4bf42-245">However, if your app uses a large amount of state data, consider using streams to directly store your data.</span></span> <span data-ttu-id="4bf42-246">これは、**書き込み**の方法のトランザクションのモデルで導入された遅延時間を減らすために役立ちます。</span><span class="sxs-lookup"><span data-stu-id="4bf42-246">This can help reduce the delay introduced by the transactional model of the **Write** methods.</span></span> 

<span data-ttu-id="4bf42-247">たとえば、 [BasicSuspension](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/BasicSuspension)サンプルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="4bf42-247">For an example, see the [BasicSuspension](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/BasicSuspension) sample.</span></span>

## <a name="other-examples-and-resources"></a><span data-ttu-id="4bf42-248">その他の例とリソース</span><span class="sxs-lookup"><span data-stu-id="4bf42-248">Other examples and resources</span></span>

<span data-ttu-id="4bf42-249">次に例をいくつかと、特定のシナリオには、その他のリソースを示します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-249">Here are several examples and other resources for specific scenarios.</span></span>

### <a name="code-example-for-retrying-file-io-example"></a><span data-ttu-id="4bf42-250">ファイル I/O の例を再試行するためのコード例</span><span class="sxs-lookup"><span data-stu-id="4bf42-250">Code example for retrying file I/O example</span></span>

<span data-ttu-id="4bf42-251">書き込みは、ユーザーが選ぶと、ファイルを保存した後に実行すると想定すると (c#)、書き込みを再試行する方法について擬似コード例を次に示します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-251">The following is a pseudo-code example on how to retry a write (C#), assuming the write is to be done after the user picks a file for saving:</span></span>

```csharp
Windows.Storage.Pickers.FileSavePicker savePicker = new Windows.Storage.Pickers.FileSavePicker();
savePicker.FileTypeChoices.Add("Plain Text", new List<string>() { ".txt" });
Windows.Storage.StorageFile file = await savePicker.PickSaveFileAsync();

Int32 retryAttempts = 5;

const Int32 ERROR_ACCESS_DENIED = unchecked((Int32)0x80070005);
const Int32 ERROR_SHARING_VIOLATION = unchecked((Int32)0x80070020);

if (file != null)
{
    // Application now has read/write access to the picked file.
    while (retryAttempts > 0)
    {
        try
        {
            retryAttempts--;
            await Windows.Storage.FileIO.WriteTextAsync(file, "Text to write to file");
            break;
        }
        catch (Exception ex) when ((ex.HResult == ERROR_ACCESS_DENIED) ||
                                   (ex.HResult == ERROR_SHARING_VIOLATION))
        {
            // This might be recovered by retrying, otherwise let the exception be raised.
            // The app can decide to wait before retrying.
        }
    }
}
else
{
    // The operation was cancelled in the picker dialog.
}
```

### <a name="synchronize-access-to-the-file"></a><span data-ttu-id="4bf42-252">ファイルへのアクセスを同期します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-252">Synchronize access to the file</span></span>

<span data-ttu-id="4bf42-253">[並列プログラミング .NET ブログで](https://blogs.msdn.microsoft.com/pfxteam/)は、並列プログラミングに関するガイダンスについては優れたリソースです。</span><span class="sxs-lookup"><span data-stu-id="4bf42-253">The [Parallel Programming with .NET blog](https://blogs.msdn.microsoft.com/pfxteam/) is a great resource for guidance about parallel programming.</span></span> <span data-ttu-id="4bf42-254">具体的には、 [AsyncReaderWriterLock に関する投稿](https://blogs.msdn.microsoft.com/pfxteam/2012/02/12/building-async-coordination-primitives-part-7-asyncreaderwriterlock/)するには、読み取りの同時アクセスできるようにすることの書き込みのファイルへの排他的アクセスを管理する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="4bf42-254">In particular, the [post about AsyncReaderWriterLock](https://blogs.msdn.microsoft.com/pfxteam/2012/02/12/building-async-coordination-primitives-part-7-asyncreaderwriterlock/) describes how to maintain exclusive access to a file for writes while allowing concurrent read access.</span></span> <span data-ttu-id="4bf42-255">留意そのシリアル化され、I/O の影響のパフォーマンス。</span><span class="sxs-lookup"><span data-stu-id="4bf42-255">Keep in mind that serializing I/O will impact performance.</span></span>

## <a name="see-also"></a><span data-ttu-id="4bf42-256">関連項目</span><span class="sxs-lookup"><span data-stu-id="4bf42-256">See also</span></span>

* [<span data-ttu-id="4bf42-257">ファイルの作成、書き込み、および読み取り</span><span class="sxs-lookup"><span data-stu-id="4bf42-257">Create, write, and read a file</span></span>](quickstart-reading-and-writing-files.md)
