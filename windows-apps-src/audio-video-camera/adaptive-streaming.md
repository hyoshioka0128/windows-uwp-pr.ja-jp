---
author: drewbatgit
ms.assetid: AE98C22B-A071-4206-ABBB-C0F0FB7EF33C
description: この記事では、ユニバーサル Windows プラットフォーム (UWP) アプリにアダプティブ ストリーミング マルチメディア コンテンツの再生を追加する方法について説明します。 現在、この機能では、HTTP ライブ ストリーミング (HLS) と Dynamic Adaptive Streaming over HTTP (DASH) コンテンツの再生がサポートされています。
title: アダプティブ ストリーミング
ms.author: drewbat
ms.date: 02/08/2017
ms.topic: article
keywords: windows 10, UWP
ms.localizationpriority: medium
ms.openlocfilehash: ef8e3ab4abd9ee9159dc7d5aa757f55e00817a51
ms.sourcegitcommit: e814a13978f33654d8e995584f4b047cb53e0aef
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/05/2018
ms.locfileid: "6042651"
---
# <a name="adaptive-streaming"></a><span data-ttu-id="9728e-105">アダプティブ ストリーミング</span><span class="sxs-lookup"><span data-stu-id="9728e-105">Adaptive streaming</span></span>


<span data-ttu-id="9728e-106">この記事では、ユニバーサル Windows プラットフォーム (UWP) アプリにアダプティブ ストリーミング マルチメディア コンテンツの再生を追加する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="9728e-106">This article describes how to add playback of adaptive streaming multimedia content to a Universal Windows Platform (UWP) app.</span></span> <span data-ttu-id="9728e-107">この機能では、HTTP ライブ ストリーミング (HLS) と Dynamic Adaptive Streaming over HTTP (DASH) コンテンツの再生がサポートされています。</span><span class="sxs-lookup"><span data-stu-id="9728e-107">This feature supports playback of Http Live Streaming (HLS) and Dynamic Streaming over HTTP (DASH) content.</span></span> <span data-ttu-id="9728e-108">Windows 10 バージョン 1803 以降では、**[AdaptiveMediaSource](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSource)** によってスムーズ ストリーミングがサポートされています。</span><span class="sxs-lookup"><span data-stu-id="9728e-108">Starting with Windows 10, version 1803, Smooth Streaming is supported by  **[AdaptiveMediaSource](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSource)**.</span></span>

<span data-ttu-id="9728e-109">サポートされている HLS プロトコル タグの一覧については、「[HLS タグのサポート](hls-tag-support.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="9728e-109">For a list of supported HLS protocol tags, see [HLS tag support](hls-tag-support.md).</span></span> 

<span data-ttu-id="9728e-110">サポートされている DASH プロファイルの一覧については、「[DASH プロファイルのサポート](dash-profile-support.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="9728e-110">For a list of supported DASH profiles, see [DASH profile support](dash-profile-support.md).</span></span> 

> [!NOTE] 
> <span data-ttu-id="9728e-111">この記事のコードは、UWP の[アダプティブ ストリーミングのサンプル](https://github.com/Microsoft/Windows-universal-samples/tree/dev/Samples/AdaptiveStreaming)を基にしています。</span><span class="sxs-lookup"><span data-stu-id="9728e-111">The code in this article was adapted from the UWP [Adaptive streaming sample](https://github.com/Microsoft/Windows-universal-samples/tree/dev/Samples/AdaptiveStreaming).</span></span>

## <a name="simple-adaptive-streaming-with-mediaplayer-and-mediaplayerelement"></a><span data-ttu-id="9728e-112">MediaPlayer と MediaPlayerElement を使った簡単なアダプティブ ストリーミング</span><span class="sxs-lookup"><span data-stu-id="9728e-112">Simple adaptive streaming with MediaPlayer and MediaPlayerElement</span></span>

<span data-ttu-id="9728e-113">UWP アプリでアダプティブ ストリーミング メディアを再生するには、DASH または HLS のマニフェスト ファイルを指す **Uri** オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="9728e-113">To play adaptive streaming media in a UWP app, create a **Uri** object pointing to a DASH or HLS manifest file.</span></span> <span data-ttu-id="9728e-114">[**MediaPlayer**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Playback.MediaPlayer) クラスのインスタンスを作成します。</span><span class="sxs-lookup"><span data-stu-id="9728e-114">Create an instance of the [**MediaPlayer**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Playback.MediaPlayer) class.</span></span> <span data-ttu-id="9728e-115">[**MediaSource.CreateFromUri**](https://msdn.microsoft.com/library/windows/apps/dn930912) を呼び出して新しい **MediaSource** オブジェクトを作成し、それを **MediaPlayer** の [**Source**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Playback.MediaPlayer.Source) プロパティに設定します。</span><span class="sxs-lookup"><span data-stu-id="9728e-115">Call [**MediaSource.CreateFromUri**](https://msdn.microsoft.com/library/windows/apps/dn930912) to create a new **MediaSource** object and then set that to the [**Source**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Playback.MediaPlayer.Source) property of the **MediaPlayer**.</span></span> <span data-ttu-id="9728e-116">[**Play**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Playback.MediaPlayer.Play) を呼び出してメディア コンテンツの作成を開始します。</span><span class="sxs-lookup"><span data-stu-id="9728e-116">Call [**Play**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Playback.MediaPlayer.Play) to start playback of the media content.</span></span>

[!code-cs[DeclareMediaPlayer](./code/AdaptiveStreaming_RS1/cs/MainPage.xaml.cs#SnippetDeclareMediaPlayer)]

[!code-cs[ManifestSourceNoUI](./code/AdaptiveStreaming_RS1/cs/MainPage.xaml.cs#SnippetManifestSourceNoUI)]

<span data-ttu-id="9728e-117">上の例では、メディア コンテンツのオーディオが再生されますが、UI 内のコンテンツは自動的にレンダリングされません。</span><span class="sxs-lookup"><span data-stu-id="9728e-117">The above example will play the audio of the media content but it doesn't automatically render the content in your UI.</span></span> <span data-ttu-id="9728e-118">ビデオ コンテンツを再生するほとんどのアプリは、XAML ページでコンテンツをレンダリングします。</span><span class="sxs-lookup"><span data-stu-id="9728e-118">Most apps that play video content will want to render the content in a XAML page.</span></span>  <span data-ttu-id="9728e-119">これを行うには、XAML ページに [ **MediaPlayerElement** ](https://msdn.microsoft.com/library/windows/apps/Windows.UI.Xaml.Controls.MediaPlayerElement) コントロールを追加します。</span><span class="sxs-lookup"><span data-stu-id="9728e-119">To do this, add a [**MediaPlayerElement**](https://msdn.microsoft.com/library/windows/apps/Windows.UI.Xaml.Controls.MediaPlayerElement) control to your XAML page.</span></span>

[!code-xml[MediaPlayerElementXAML](./code/AdaptiveStreaming_RS1/cs/MainPage.xaml#SnippetMediaPlayerElementXAML)]

<span data-ttu-id="9728e-120">[**MediaSource.CreateFromUri**](https://msdn.microsoft.com/library/windows/apps/dn930912) を呼び出して、DASH や HLS のマニフェスト ファイルの URI から **MediaSource** を作成します。</span><span class="sxs-lookup"><span data-stu-id="9728e-120">Call [**MediaSource.CreateFromUri**](https://msdn.microsoft.com/library/windows/apps/dn930912) to create a **MediaSource** from the URI of a DASH or HLS manifest file.</span></span> <span data-ttu-id="9728e-121">その後、**MediaPlayerElement** の [**Source**](https://msdn.microsoft.com/library/windows/apps/br227420) プロパティを設定します。</span><span class="sxs-lookup"><span data-stu-id="9728e-121">Then set the [**Source**](https://msdn.microsoft.com/library/windows/apps/br227420) property of the **MediaPlayerElement**.</span></span> <span data-ttu-id="9728e-122">**MediaPlayerElement**によって、コンテンツの新しい **MediaPlayer** オブジェクトが自動的に作成されます。</span><span class="sxs-lookup"><span data-stu-id="9728e-122">The **MediaPlayerElement** will automatically create a new **MediaPlayer** object for the content.</span></span> <span data-ttu-id="9728e-123">**MediaPlayer** で **Play** を呼び出して、コンテンツの再生を開始できます。</span><span class="sxs-lookup"><span data-stu-id="9728e-123">You can call **Play** on the **MediaPlayer** to start playback of the content.</span></span>

[!code-cs[ManifestSource](./code/AdaptiveStreaming_RS1/cs/MainPage.xaml.cs#SnippetManifestSource)]

> [!NOTE] 
> <span data-ttu-id="9728e-124">Windows 10 バージョン 1607 以降、メディア項目の再生には、**MediaPlayer** クラスを使うことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="9728e-124">Starting with Windows 10, version 1607, it is recommended that you use the **MediaPlayer** class to play media items.</span></span> <span data-ttu-id="9728e-125">**MediaPlayerElement** は、XAML ページの **MediaPlayer** コンテンツをレンダリングするために使われる軽量の XAML コントロールです。</span><span class="sxs-lookup"><span data-stu-id="9728e-125">The **MediaPlayerElement** is a lightweight XAML control that is used to render the content of a **MediaPlayer** in a XAML page.</span></span> <span data-ttu-id="9728e-126">下位互換性を確保するため、**MediaElement**コントロールも引き続きサポートされています。</span><span class="sxs-lookup"><span data-stu-id="9728e-126">The **MediaElement** control continues to be supported for backwards compatibility.</span></span> <span data-ttu-id="9728e-127">**MediaPlayer** と **MediaPlayerElement** を使ってメディア コンテンツを再生する方法について詳しくは、「[MediaPlayer を使ったオーディオとビデオの再生](play-audio-and-video-with-mediaplayer.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="9728e-127">For more information about using **MediaPlayer** and **MediaPlayerElement** to play media content, see [Play audio and video with MediaPlayer](play-audio-and-video-with-mediaplayer.md).</span></span> <span data-ttu-id="9728e-128">**MediaSource** と関連の API を使ってメディア コンテンツを操作する方法について詳しくは、「[メディア項目、プレイリスト、トラック](media-playback-with-mediasource.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="9728e-128">For information about using **MediaSource** and related APIs to work with media content, see [Media items, playlists, and tracks](media-playback-with-mediasource.md).</span></span>

## <a name="adaptive-streaming-with-adaptivemediasource"></a><span data-ttu-id="9728e-129">AdaptiveMediaSource を使ったアダプティブ ストリーミング</span><span class="sxs-lookup"><span data-stu-id="9728e-129">Adaptive streaming with AdaptiveMediaSource</span></span>

<span data-ttu-id="9728e-130">アプリで、より高度なアダプティブ ストリーミング機能 (カスタム HTTP ヘッダーの指定、現在のダウンロードや再生のビットレートの監視、アダプティブ ストリーミングのビットレートをシステムで切り替えるタイミングを決定する比率の調整など) を必要とする場合は、**[AdaptiveMediaSource](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSource)** オブジェクトを使います。</span><span class="sxs-lookup"><span data-stu-id="9728e-130">If your app requires more advanced adaptive streaming features, such as providing custom HTTP headers, monitoring the current download and playback bitrates, or adjusting the ratios that determine when the system switches bitrates of the adaptive stream, use the **[AdaptiveMediaSource](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSource)** object.</span></span>

<span data-ttu-id="9728e-131">アダプティブ ストリーミング API は、[**Windows.Media.Streaming.Adaptive**](https://msdn.microsoft.com/library/windows/apps/dn931279) 名前空間にあります。</span><span class="sxs-lookup"><span data-stu-id="9728e-131">The adaptive streaming APIs are found in the [**Windows.Media.Streaming.Adaptive**](https://msdn.microsoft.com/library/windows/apps/dn931279) namespace.</span></span> <span data-ttu-id="9728e-132">この記事の例には、以下の名前空間の API が使われています。</span><span class="sxs-lookup"><span data-stu-id="9728e-132">The examples in this article use APIs from the following namespaces.</span></span>

[!code-cs[AdaptiveStreamingUsing](./code/AdaptiveStreaming_RS1/cs/MainPage.xaml.cs#SnippetAdaptiveStreamingUsing)]

## <a name="initialize-an-adaptivemediasource-from-a-uri"></a><span data-ttu-id="9728e-133">URI から AdaptiveMediaSource を初期化する</span><span class="sxs-lookup"><span data-stu-id="9728e-133">Initialize an AdaptiveMediaSource from a URI.</span></span>

<span data-ttu-id="9728e-134">[**CreateFromUriAsync**](https://msdn.microsoft.com/library/windows/apps/dn931261) を呼び出し、アダプティブ ストリーミング マニフェスト ファイルの URI で、**AdaptiveMediaSource** を初期化します。</span><span class="sxs-lookup"><span data-stu-id="9728e-134">Initialize the **AdaptiveMediaSource** with the URI of an adaptive streaming manifest file by calling [**CreateFromUriAsync**](https://msdn.microsoft.com/library/windows/apps/dn931261).</span></span> <span data-ttu-id="9728e-135">このメソッドから返される [**AdaptiveMediaSourceCreationStatus**](https://msdn.microsoft.com/library/windows/apps/dn946917) の値を利用して、メディア ソースが正しく作成されたかどうかを確認できます。</span><span class="sxs-lookup"><span data-stu-id="9728e-135">The [**AdaptiveMediaSourceCreationStatus**](https://msdn.microsoft.com/library/windows/apps/dn946917) value returned from this method lets you know if the media source was created successfully.</span></span> <span data-ttu-id="9728e-136">正しく作成されている場合、オブジェクトを **MediaPlayer** のストリーム ソースとして設定できます。そのためには、[**MediaSource.CreateFromAdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/Windows.Media.Core.MediaSource.AdaptiveMediaSource) を呼び出して **MediaSource** オブジェクトを作成し、このオブジェクトをメディア プレーヤーの [**Source**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer.Source) プロパティに割り当てます。</span><span class="sxs-lookup"><span data-stu-id="9728e-136">If so, you can set the object as the stream source for your **MediaPlayer** by creating a **MediaSource** object by calling  [**MediaSource.CreateFromAdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/Windows.Media.Core.MediaSource.AdaptiveMediaSource), and then assigning it to the media player's [**Source**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer.Source) property.</span></span> <span data-ttu-id="9728e-137">この例では、[**AvailableBitrates**](https://msdn.microsoft.com/library/windows/apps/dn931257) プロパティを照会することによって、このストリームで利用できる最大ビットレートを特定し、その値が初期ビットレートとして設定されます。</span><span class="sxs-lookup"><span data-stu-id="9728e-137">In this example, the [**AvailableBitrates**](https://msdn.microsoft.com/library/windows/apps/dn931257) property is queried to determine the maximum supported bitrate for this stream, and then that value is set as the inital bitrate.</span></span> <span data-ttu-id="9728e-138">またこの例では、**AdaptiveMediaSource** のいくつかのイベントのハンドラーも登録します。これらのイベントについては、この記事の後半で説明します。</span><span class="sxs-lookup"><span data-stu-id="9728e-138">This example also registers handlers for the several **AdaptiveMediaSource** events that are discussed later in this article.</span></span>

[!code-cs[InitializeAMS](./code/AdaptiveStreaming_RS1/cs/MainPage.xaml.cs#SnippetInitializeAMS)]

## <a name="initialize-an-adaptivemediasource-using-httpclient"></a><span data-ttu-id="9728e-139">HttpClient を使用して AdaptiveMediaSource を初期化する</span><span class="sxs-lookup"><span data-stu-id="9728e-139">Initialize an AdaptiveMediaSource using HttpClient</span></span>

<span data-ttu-id="9728e-140">マニフェスト ファイルを取得するためにカスタム HTTP ヘッダーを設定する場合は、[**HttpClient**](https://msdn.microsoft.com/library/windows/apps/dn298639) オブジェクトを作成し、目的のヘッダーを設定してから、そのオブジェクトを **CreateFromUriAsync** のオーバーロードに渡すことができます。</span><span class="sxs-lookup"><span data-stu-id="9728e-140">If you need to set custom HTTP headers for getting the manifest file, you can create an [**HttpClient**](https://msdn.microsoft.com/library/windows/apps/dn298639) object, set the desired headers, and then pass the object into the overload of **CreateFromUriAsync**.</span></span>

[!code-cs[InitializeAMSWithHttpClient](./code/AdaptiveStreaming_RS1/cs/MainPage.xaml.cs#SnippetInitializeAMSWithHttpClient)]

<span data-ttu-id="9728e-141">[**DownloadRequested**](https://msdn.microsoft.com/library/windows/apps/dn931272) イベントは、システムがサーバーからリソースの取得を試みるときに発生します。</span><span class="sxs-lookup"><span data-stu-id="9728e-141">The [**DownloadRequested**](https://msdn.microsoft.com/library/windows/apps/dn931272) event is raised when the system is about to retrieve a resource from the server.</span></span> <span data-ttu-id="9728e-142">イベント ハンドラーに渡される [**AdaptiveMediaSourceDownloadRequestedEventArgs**](https://msdn.microsoft.com/library/windows/apps/dn946935) によって、要求されているリソースに関する情報 (リソースの種類や URI など) を提供するプロパティが公開されます。</span><span class="sxs-lookup"><span data-stu-id="9728e-142">The [**AdaptiveMediaSourceDownloadRequestedEventArgs**](https://msdn.microsoft.com/library/windows/apps/dn946935) passed into the event handler exposes properties that provide information about the resource being requested such as the type and URI of the resource.</span></span>

## <a name="modify-resource-request-properties-using-the-downloadrequested-event"></a><span data-ttu-id="9728e-143">DownloadRequested イベントを使ってリソース要求プロパティを変更する</span><span class="sxs-lookup"><span data-stu-id="9728e-143">Modify resource request properties using the DownloadRequested event</span></span>

<span data-ttu-id="9728e-144">**DownloadRequested** イベント ハンドラーを使って、リソース要求を変更することができます。この場合、イベント引数によって提供される [**AdaptiveMediaSourceDownloadResult**](https://msdn.microsoft.com/library/windows/apps/dn946942) オブジェクトのプロパティを更新します。</span><span class="sxs-lookup"><span data-stu-id="9728e-144">You can use the **DownloadRequested** event handler to modify the resource request by updating the properties of the [**AdaptiveMediaSourceDownloadResult**](https://msdn.microsoft.com/library/windows/apps/dn946942) object provided by the event args.</span></span> <span data-ttu-id="9728e-145">次の例では、結果オブジェクトの [**ResourceUri**](https://msdn.microsoft.com/library/windows/apps/dn931250) プロパティを更新して、リソースの取得元となる URI を変更します。</span><span class="sxs-lookup"><span data-stu-id="9728e-145">In the example below, the URI from which the resource will be retrieved is modified by updating the [**ResourceUri**](https://msdn.microsoft.com/library/windows/apps/dn931250) properties of the result object.</span></span> <span data-ttu-id="9728e-146">メディア セグメントのバイト範囲オフセットや長さを書き換えたり、次の例に示すようにリソース URI を変更して完全なリソースをダウンロードし、バイト範囲のオフセットと長さを null に設定することもできます。</span><span class="sxs-lookup"><span data-stu-id="9728e-146">You can also rewrite the byte range offset and length for media segments or, as shown the example below, change the resource URI to download the full resource and set the byte range offset and length to null.</span></span>

<span data-ttu-id="9728e-147">結果オブジェクトの [**Buffer**](https://msdn.microsoft.com/library/windows/apps/dn946943) プロパティや [**InputStream**](https://msdn.microsoft.com/library/windows/apps/dn931249) プロパティを設定することによって、要求したリソースの内容を置き換えることができます。</span><span class="sxs-lookup"><span data-stu-id="9728e-147">You can override the content of the requested resource by setting the [**Buffer**](https://msdn.microsoft.com/library/windows/apps/dn946943) or [**InputStream**](https://msdn.microsoft.com/library/windows/apps/dn931249) properties of the result object.</span></span> <span data-ttu-id="9728e-148">次の例では、**Buffer** プロパティを設定することによって、マニフェスト リソースの内容が置き換わります。</span><span class="sxs-lookup"><span data-stu-id="9728e-148">In the example below, the contents of the manifest resource are replaced by setting the **Buffer** property.</span></span> <span data-ttu-id="9728e-149">非同期的に取得したデータを使ってリソース要求を更新する場合は (リモート サーバーや非同期ユーザー認証からデータを取得する場合など)、[**AdaptiveMediaSourceDownloadRequestedEventArgs.GetDeferral**](https://msdn.microsoft.com/library/windows/apps/dn946936) を呼び出して遅延を取得する必要があります。その後、操作が完了して、ダウンロード要求操作が継続可能なことをシステムに通知するときに、[**Complete**](https://msdn.microsoft.com/library/windows/apps/dn946934) を呼び出してください。</span><span class="sxs-lookup"><span data-stu-id="9728e-149">Note that if you are updating the resource request with data that is obtained asynchronously, such as retrieving data from a remote server or asynchronous user authentication, you must call [**AdaptiveMediaSourceDownloadRequestedEventArgs.GetDeferral**](https://msdn.microsoft.com/library/windows/apps/dn946936) to get a deferral and then call [**Complete**](https://msdn.microsoft.com/library/windows/apps/dn946934) when the operation is complete to signal the system that the download request operation can continue.</span></span>

[!code-cs[AMSDownloadRequested](./code/AdaptiveStreaming_RS1/cs/MainPage.xaml.cs#SnippetAMSDownloadRequested)]

## <a name="use-bitrate-events-to-manage-and-respond-to-bitrate-changes"></a><span data-ttu-id="9728e-150">ビットレート イベントを使用して、ビットレートの変更を管理し変更に応答する</span><span class="sxs-lookup"><span data-stu-id="9728e-150">Use bitrate events to manage and respond to bitrate changes</span></span>

<span data-ttu-id="9728e-151">**AdaptiveMediaSource** オブジェクトは、ダウンロードや再生のビットレートが変わったときに対応できるようにするイベントを提供します。</span><span class="sxs-lookup"><span data-stu-id="9728e-151">The **AdaptiveMediaSource** object provides events that allow you to react when the download or playback bitrates change.</span></span> <span data-ttu-id="9728e-152">この例では、現在のビットレートが UI で簡単に更新されます。</span><span class="sxs-lookup"><span data-stu-id="9728e-152">In this example, the current bitrates are simply updated in the UI.</span></span> <span data-ttu-id="9728e-153">また、アダプティブ ストリーミングのビットレートをシステムで切り替えるタイミングを決定する比率を変更できることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="9728e-153">Note that you can modify the ratios that determine when the system switches bitrates of the adaptive stream.</span></span> <span data-ttu-id="9728e-154">詳しくは、[**AdvancedSettings**](https://msdn.microsoft.com/library/windows/apps/mt628697) プロパティをご覧ください。</span><span class="sxs-lookup"><span data-stu-id="9728e-154">For more information, see the [**AdvancedSettings**](https://msdn.microsoft.com/library/windows/apps/mt628697) property.</span></span>

[!code-cs[AMSBitrateEvents](./code/AdaptiveStreaming_RS1/cs/MainPage.xaml.cs#SnippetAMSBitrateEvents)]

## <a name="handle-download-completion-and-failure-events"></a><span data-ttu-id="9728e-155">ダウンロードの完了と失敗イベントを処理する</span><span class="sxs-lookup"><span data-stu-id="9728e-155">Handle download completion and failure events</span></span>
<span data-ttu-id="9728e-156">**AdaptiveMediaSource** オブジェクトは、要求されたリソースのダウンロードが失敗したときに、[**DownloadFailed**](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSource.DownloadFailed) イベントを生成します。</span><span class="sxs-lookup"><span data-stu-id="9728e-156">The **AdaptiveMediaSource** object raises the [**DownloadFailed**](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSource.DownloadFailed) event when the download of a requested resource fails.</span></span> <span data-ttu-id="9728e-157">このイベントを使用して、エラーに応じて UI を更新できます。</span><span class="sxs-lookup"><span data-stu-id="9728e-157">You can use this event to update your UI in response to the failure.</span></span> <span data-ttu-id="9728e-158">このイベントを使用して、ダウンロード操作とエラーに関する統計情報をログに記録することもできます。</span><span class="sxs-lookup"><span data-stu-id="9728e-158">You can also use the event to log statistical information about the download operation and the failure.</span></span> 

<span data-ttu-id="9728e-159">イベント ハンドラーに渡される [**AdaptiveMediaSourceDownloadFailedEventArgs**](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSourceDownloadFailedEventArgs) オブジェクトには、リソースの種類、リソースの URI、ストリーム内のエラーが発生した位置など、失敗したリソースのダウンロードに関するメタデータが含まれています。</span><span class="sxs-lookup"><span data-stu-id="9728e-159">The [**AdaptiveMediaSourceDownloadFailedEventArgs**](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSourceDownloadFailedEventArgs) object passed into the event handler contains metadata about the failed resource download, such as the resource type, the URI of the resource, and the position within the stream where the failure occurred.</span></span> <span data-ttu-id="9728e-160">[**RequestId**](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSourceDownloadFailedEventArgs.RequestId) は、複数のイベント間で、個々の要求に関する状態情報を関連付けるために使用できる、システムで生成された一意の識別子を取得します。</span><span class="sxs-lookup"><span data-stu-id="9728e-160">The [**RequestId**](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSourceDownloadFailedEventArgs.RequestId) gets a system-generated unique identifier for the request that can be use to correlate status information about an individual request across multiple events.</span></span>

<span data-ttu-id="9728e-161">[**Statistics**](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSourceDownloadFailedEventArgs.Statistics) プロパティは、[**AdaptiveMediaSourceDownloadStatistics**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasourcedownloadstatistics) オブジェクトを返します。このオブジェクトは、イベントの発生時や、ダウンロード操作のさまざまなマイルストーンのタイミングで受信したバイト数に関する詳細情報を提供します。</span><span class="sxs-lookup"><span data-stu-id="9728e-161">The [**Statistics**](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSourceDownloadFailedEventArgs.Statistics) property returns a [**AdaptiveMediaSourceDownloadStatistics**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasourcedownloadstatistics) object which provides detailed information about the number of bytes received at the time of the event and the timing of various milestones in the download operation.</span></span> <span data-ttu-id="9728e-162">この情報は、アダプティブ ストリーミングの実装でパフォーマンスの問題を識別するためにろぐに記録できます。</span><span class="sxs-lookup"><span data-stu-id="9728e-162">You can log this information in order identify perfomance issues in your adaptive streaming implementation.</span></span>

[!code-cs[AMSDownloadFailed](./code/AdaptiveStreaming_RS1/cs/MainPage.xaml.cs#SnippetAMSDownloadFailed)]


<span data-ttu-id="9728e-163">[**DownloadCompleted**](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSource.DownloadCompleted) イベントは、リソースのダウンロードが完了したときに発生し、**DownloadFailed** イベントと同様のデータを提供します。</span><span class="sxs-lookup"><span data-stu-id="9728e-163">The  [**DownloadCompleted**](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSource.DownloadCompleted) event occurs when a resource download completes and provdes similar data to the **DownloadFailed** event.</span></span> <span data-ttu-id="9728e-164">ここでも、1 つの要求のイベントを関連付けるために **RequestId** が提供されます。</span><span class="sxs-lookup"><span data-stu-id="9728e-164">Once again, a **RequestId** is provided for correlating events for a single request.</span></span> <span data-ttu-id="9728e-165">また、ダウンロード統計情報のログ記録を有効にするために、**AdaptiveMediaSourceDownloadStatistics** オブジェクトが提供されます。</span><span class="sxs-lookup"><span data-stu-id="9728e-165">Also, an **AdaptiveMediaSourceDownloadStatistics** object is provided to enable logging of download stats.</span></span>

[!code-cs[AMSDownloadCompleted](./code/AdaptiveStreaming_RS1/cs/MainPage.xaml.cs#SnippetAMSDownloadCompleted)]

## <a name="gather-adaptive-streaming-telemetry-data-with-adaptivemediasourcediagnostics"></a><span data-ttu-id="9728e-166">AdaptiveMediaSourceDiagnostics によってアダプティブ ストリーミングの利用統計情報を収集する</span><span class="sxs-lookup"><span data-stu-id="9728e-166">Gather adaptive streaming telemetry data with AdaptiveMediaSourceDiagnostics</span></span>
<span data-ttu-id="9728e-167">**AdaptiveMediaSource** は、[**AdaptiveMediaSourceDiagnostics**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasourcediagnostics) オブジェクトを返す [**Diagnostics**](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSource?branch=master.Diagnostics) プロパティを公開します。</span><span class="sxs-lookup"><span data-stu-id="9728e-167">The **AdaptiveMediaSource** exposes a [**Diagnostics**](https://docs.microsoft.com/uwp/api/Windows.Media.Streaming.Adaptive.AdaptiveMediaSource?branch=master.Diagnostics) property which returns an [**AdaptiveMediaSourceDiagnostics**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasourcediagnostics) object.</span></span> <span data-ttu-id="9728e-168">このオブジェクトを使って、[**DiagnosticAvailable**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasourcediagnostics.DiagnosticAvailable) イベントを登録します。</span><span class="sxs-lookup"><span data-stu-id="9728e-168">Use this object to register for the [**DiagnosticAvailable**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasourcediagnostics.DiagnosticAvailable) event.</span></span> <span data-ttu-id="9728e-169">このイベントは、利用統計情報の収集に使用することを目的としており、実行時にアプリの動作を変更するために使用することはできません。</span><span class="sxs-lookup"><span data-stu-id="9728e-169">This event is intended to be used for telemetry collection and should not be used to modify app behavior at runtime.</span></span> <span data-ttu-id="9728e-170">この診断イベントは、さまざまな理由で発生します。</span><span class="sxs-lookup"><span data-stu-id="9728e-170">This diagnostic event is raised for many different reasons.</span></span> <span data-ttu-id="9728e-171">イベントが発生した理由を特定するには、イベントに渡される [**AdaptiveMediaSourceDiagnosticAvailableEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasourcediagnosticavailableeventargs) オブジェクトの [**DiagnosticType**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasourcediagnosticavailableeventargs.DiagnosticType) プロパティを確認します。</span><span class="sxs-lookup"><span data-stu-id="9728e-171">Check the [**DiagnosticType**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasourcediagnosticavailableeventargs.DiagnosticType) property of the [**AdaptiveMediaSourceDiagnosticAvailableEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasourcediagnosticavailableeventargs) object passed into the event to determine the reason that the event was raised.</span></span> <span data-ttu-id="9728e-172">潜在的な理由には、要求されたリソースへのアクセス時のエラーや、ストリーミング マニフェスト ファイルの解析時のエラーが含まれます。</span><span class="sxs-lookup"><span data-stu-id="9728e-172">Potential reasons include errors accessing the requested resource and errors parsing the streaming manifest file.</span></span> <span data-ttu-id="9728e-173">診断イベントをトリガーできる状況の一覧については、[**AdaptiveMediaSourceDiagnosticType**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasourcediagnostictype) を参照してください。</span><span class="sxs-lookup"><span data-stu-id="9728e-173">For a list of situations that can trigger a diagnostic event, see [**AdaptiveMediaSourceDiagnosticType**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasourcediagnostictype).</span></span> <span data-ttu-id="9728e-174">他のアダプティブ ストリーミング イベントの引数と同様に、**AdaptiveMediaSourceDiagnosticAvailableEventArgs** は、さまざまなイベントの間で要求情報を関連付けるための **RequestId** プロパティを提供します。</span><span class="sxs-lookup"><span data-stu-id="9728e-174">Like the arguments for other adaptive streaming events, the **AdaptiveMediaSourceDiagnosticAvailableEventArgs** provides a **RequestId** propery for correlating request information between different events.</span></span>

[!code-cs[AMSDiagnosticAvailable](./code/AdaptiveStreaming_RS1/cs/MainPage.xaml.cs#SnippetAMSDiagnosticAvailable)]

## <a name="defer-binding-of-adaptive-streaming-content-for-items-in-a-playback-list-by-using-mediabinder"></a><span data-ttu-id="9728e-175">MediaBinder を使用して、再生リスト内の項目のアダプティブ ストリーミング コンテンツのバインドを延期する</span><span class="sxs-lookup"><span data-stu-id="9728e-175">Defer binding of adaptive streaming content for items in a playback list by using MediaBinder</span></span>
<span data-ttu-id="9728e-176">[**MediaBinder**](https://docs.microsoft.com/uwp/api/Windows.Media.Core.MediaBinder) クラスによって、[**MediaPlaybackList**](https://msdn.microsoft.com/library/windows/apps/dn930955) 内のメディア コンテンツのバインドを延期することができます。</span><span class="sxs-lookup"><span data-stu-id="9728e-176">The [**MediaBinder**](https://docs.microsoft.com/uwp/api/Windows.Media.Core.MediaBinder) class allows you to defer binding of media content in a [**MediaPlaybackList**](https://msdn.microsoft.com/library/windows/apps/dn930955).</span></span> <span data-ttu-id="9728e-177">Windows 10 Version 1703 以降では、バインドされるコンテンツとして [**AdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource) を指定できます。</span><span class="sxs-lookup"><span data-stu-id="9728e-177">Starting with Windows 10, version 1703, you can supply an [**AdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource) as bound content.</span></span> <span data-ttu-id="9728e-178">アダプティブ メディア ソースの遅延バインドのプロセスの大部分は、「[メディア項目、プレイリスト、トラック](media-playback-with-mediasource.md)」で説明されている、他の種類のメディアのバインドと同じです。</span><span class="sxs-lookup"><span data-stu-id="9728e-178">The process for deferred binding of an adaptive media source is largely the same as binding other types of media, which is described in [Media items, playlists, and tracks](media-playback-with-mediasource.md).</span></span> 

<span data-ttu-id="9728e-179">**MediaBinder** インスタンスを作成し、アプリで定義された、バインドされるコンテンツを識別するための [**Token**](https://docs.microsoft.com/uwp/api/Windows.Media.Core.MediaBinder.Token) 文字列を設定して、[**Binding**](https://docs.microsoft.com/uwp/api/Windows.Media.Core.MediaBinder.Binding) イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="9728e-179">Create a **MediaBinder** instance, set an app-defined [**Token**](https://docs.microsoft.com/uwp/api/Windows.Media.Core.MediaBinder.Token) string to identify the content to be bound, and register for the [**Binding**](https://docs.microsoft.com/uwp/api/Windows.Media.Core.MediaBinder.Binding) event.</span></span> <span data-ttu-id="9728e-180">[**MediaSource.CreateFromMediaBinder**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.createfrommediabinder) を呼び出すことによって、**Binder** から **MediaSource** を作成します。</span><span class="sxs-lookup"><span data-stu-id="9728e-180">Create a **MediaSource** from the **Binder** by calling [**MediaSource.CreateFromMediaBinder**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.createfrommediabinder).</span></span> <span data-ttu-id="9728e-181">次に、**MediaSource** から **MediaPlaybackItem** を作成し、再生リストに追加します。</span><span class="sxs-lookup"><span data-stu-id="9728e-181">Then, create a **MediaPlaybackItem** from the **MediaSource** and add it to the playback list.</span></span>

[!code-cs[InitMediaBinder](./code/MediaSource_RS1/cs/MainPage.xaml.cs#SnippetInitMediaBinder)]

<span data-ttu-id="9728e-182">**Binding** イベント ハンドラーでは、トークン文字列を使用してバインドされるコンテンツを識別し、**[CreateFromStreamAsync](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.createfromstreamasync)** または **[CreateFromUriAsync](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.createfromuriasync)** のオーバーロードを呼び出すことによってアダプティブ メディア ソースを作成します。</span><span class="sxs-lookup"><span data-stu-id="9728e-182">In the **Binding** event handler, use the token string to identify the content to be bound and then create the adaptive media source by calling one of the overloads of **[CreateFromStreamAsync](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.createfromstreamasync)** or **[CreateFromUriAsync](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.createfromuriasync)**.</span></span> <span data-ttu-id="9728e-183">これらは非同期メソッドであるため、最初に [**MediaBindingEventArgs.GetDeferral**](https://docs.microsoft.com/uwp/api/windows.media.core.mediabindingeventargs.GetDeferral) メソッドを呼び出して、操作が完了するまで待機してから続行するようにシステムに指示する必要があります。</span><span class="sxs-lookup"><span data-stu-id="9728e-183">Because these are asynchronous methods, you should first call the [**MediaBindingEventArgs.GetDeferral**](https://docs.microsoft.com/uwp/api/windows.media.core.mediabindingeventargs.GetDeferral) method to instruct the system to wait for your operation to complete before continuing.</span></span>  <span data-ttu-id="9728e-184">**[SetAdaptiveMediaSource](https://docs.microsoft.com/uwp/api/windows.media.core.mediabindingeventargs.setadaptivemediasource)** を呼び出すことによって、バインドされるコンテンツとして、アダプティブ メディア ソースを設定します。</span><span class="sxs-lookup"><span data-stu-id="9728e-184">Set the adaptive media source as the bound content by calling **[SetAdaptiveMediaSource](https://docs.microsoft.com/uwp/api/windows.media.core.mediabindingeventargs.setadaptivemediasource)**.</span></span> <span data-ttu-id="9728e-185">最後に、操作が完了した後、[**Deferral.Complete**](https://docs.microsoft.com/uwp/api/windows.foundation.deferral.Complete) を呼び出して、システムに続行を指示します。</span><span class="sxs-lookup"><span data-stu-id="9728e-185">Finally, call [**Deferral.Complete**](https://docs.microsoft.com/uwp/api/windows.foundation.deferral.Complete) after your operation is complete to instruct the system to continue.</span></span>

[!code-cs[BinderBindingAMS](./code/MediaSource_RS1/cs/MainPage.xaml.cs#SnippetBinderBindingAMS)]

<span data-ttu-id="9728e-186">バインドされているアダプティブ メディア ソースのイベント ハンドラーを登録する場合は、**MediaPlaybackList** の [**CurrentItemChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacklist.CurrentItemChanged) イベントのハンドラーでこれを実行できます。</span><span class="sxs-lookup"><span data-stu-id="9728e-186">If you want to register event handlers for the bound adaptive media source, you can do this in the handler for the [**CurrentItemChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacklist.CurrentItemChanged) event of the **MediaPlaybackList**.</span></span> <span data-ttu-id="9728e-187">[**CurrentMediaPlaybackItemChangedEventArgs.NewItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.currentmediaplaybackitemchangedeventargs.NewItem) プロパティには、リスト内で現在再生中の新しい **MediaPlaybackItem** が含まれます。</span><span class="sxs-lookup"><span data-stu-id="9728e-187">The [**CurrentMediaPlaybackItemChangedEventArgs.NewItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.currentmediaplaybackitemchangedeventargs.NewItem) property contains the new currently playing **MediaPlaybackItem** in the list.</span></span> <span data-ttu-id="9728e-188">新しい項目を表す **AdaptiveMediaSource** インスタンスを取得するには、**MediaPlaybackItem** の [**Source**](https://docs.microsoft.com/uwp/api/Windows.Media.Playback.MediaPlaybackItem.Source) プロパティにアクセスし、次にメディア ソースの [**AdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.AdaptiveMediaSource) プロパティにアクセスします。</span><span class="sxs-lookup"><span data-stu-id="9728e-188">Get an instance of the **AdaptiveMediaSource** representing the new item by accessing the [**Source**](https://docs.microsoft.com/uwp/api/Windows.Media.Playback.MediaPlaybackItem.Source) property of the **MediaPlaybackItem** and then the [**AdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.AdaptiveMediaSource) property of the media source.</span></span> <span data-ttu-id="9728e-189">新しい再生項目が **AdaptiveMediaSource** ではない場合、このプロパティは null になるため、このオブジェクトのイベントのハンドラーを登録する前に、これが null であることをテストする必要があります。</span><span class="sxs-lookup"><span data-stu-id="9728e-189">This property will be null if the new playback item is not an **AdaptiveMediaSource**, so you should test for null before attempting to register handlers for any of the object's events.</span></span>

[!code-cs[AMSBindingCurrentItemChanged](./code/MediaSource_RS1/cs/MainPage.xaml.cs#SnippetAMSBindingCurrentItemChanged)]

## <a name="related-topics"></a><span data-ttu-id="9728e-190">関連トピック</span><span class="sxs-lookup"><span data-stu-id="9728e-190">Related topics</span></span>
* [<span data-ttu-id="9728e-191">メディア再生</span><span class="sxs-lookup"><span data-stu-id="9728e-191">Media playback</span></span>](media-playback.md)
* [<span data-ttu-id="9728e-192">HLS タグのサポート</span><span class="sxs-lookup"><span data-stu-id="9728e-192">HLS tag support</span></span>](hls-tag-support.md) 
* [<span data-ttu-id="9728e-193">DASH プロファイルのサポート</span><span class="sxs-lookup"><span data-stu-id="9728e-193">Dash profile support</span></span>](dash-profile-support.md) 
* [<span data-ttu-id="9728e-194">MediaPlayer を使ったオーディオとビデオの再生</span><span class="sxs-lookup"><span data-stu-id="9728e-194">Play audio and video with MediaPlayer</span></span>](play-audio-and-video-with-mediaplayer.md)
* [<span data-ttu-id="9728e-195">バックグラウンドでのメディアの再生</span><span class="sxs-lookup"><span data-stu-id="9728e-195">Play media in the background</span></span>](background-audio.md) 





