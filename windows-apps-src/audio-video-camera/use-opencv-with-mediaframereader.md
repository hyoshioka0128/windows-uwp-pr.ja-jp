---
author: drewbatgit
ms.assetid: ''
description: この記事では、Open Source Computer Vision Library (OpenCV) と MediaFrameReader クラスを使用する方法について説明します。
title: OpenCV と MediaFrameReader の使用
ms.author: drewbat
ms.date: 02/08/2017
ms.topic: article
ms.prod: windows
ms.technology: uwp
keywords: Windows 10, UWP, OpenCV
ms.localizationpriority: medium
ms.openlocfilehash: d9c2ac6ad4de6dc67cc4c661e055ad43ecb143ec
ms.sourcegitcommit: 1eabcf511c7c7803a19eb31f600c6ac4a0067786
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/28/2018
ms.locfileid: "1692803"
---
# <a name="use-the-open-source-computer-vision-library-opencv-with-mediaframereader"></a><span data-ttu-id="1e42e-104">Open Source Computer Vision Library (OpenCV) と MediaFrameReader の使用</span><span class="sxs-lookup"><span data-stu-id="1e42e-104">Use the Open Source Computer Vision Library (OpenCV) with MediaFrameReader</span></span>

<span data-ttu-id="1e42e-105">この記事では、さまざまな画像処理アルゴリズムを提供するネイティブ コード ライブラリである Open Source Computer Vision Library (OpenCV) を、複数のソースから同時にメディア フレームを読み取ることができる [**MediaFrameReader**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader) クラスと共に使用する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-105">This article shows you how to use the Open Source Computer Vision Library (OpenCV), a native code library that provides a wide variety of image processing algorithms, with the [**MediaFrameReader**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader) class that can read media frames from multiple sources simulataneously.</span></span> <span data-ttu-id="1e42e-106">この記事のコード例では、カラー センサーからフレームを取得し、OpenCV ライブラリを使用して各フレームをぼかして、処理された画像を XAML の **Image** コントロールに表示する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-106">The example code in this article walks you through creating a simple app that obtains frames from a color sensor, blurs each frame using the OpenCV library, and then displays the processed image in a XAML **Image** control.</span></span>

<span data-ttu-id="1e42e-107">この記事は、他の 2 つの記事の内容に基づいています。</span><span class="sxs-lookup"><span data-stu-id="1e42e-107">This article builds on the content of two other articles:</span></span>

* <span data-ttu-id="1e42e-108">[MediaFrameReader を使ったメディア フレームの処理](process-media-frames-with-mediaframereader.md): この記事では、**MediaFrameReader** を使用して 1 つまたは複数のメディア フレーム ソースからフレームを取得する方法について詳細な情報を提供し、この記事のサンプル コードの多くについて詳しく説明しています。</span><span class="sxs-lookup"><span data-stu-id="1e42e-108">[Process media frames with MediaFrameReader](process-media-frames-with-mediaframereader.md) - This article provides detailed information on using **MediaFrameReader** to obtain frames from one or more media frame sources and describes, in detail, most of the sample code in this article.</span></span> <span data-ttu-id="1e42e-109">具体的には、「**MediaFrameReader を使ったメディア フレームの処理**」では、ヘルパー クラス **FrameRenderer** のコード一覧を示します。このクラスは、XAML の **Image** 要素でのメディア フレームのプレゼンテーションを処理します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-109">In particular, **Process media frames with MediaFrameReader** provides the code listing for a helper class, **FrameRenderer**, which handles the presentation of media frames in a XAML **Image** element.</span></span> <span data-ttu-id="1e42e-110">この記事のサンプル コードでもこのヘルパー クラスを使用します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-110">The sample code in this article uses this helper class as well.</span></span>

* <span data-ttu-id="1e42e-111">[OpenCV でのソフトウェア ビットマップの処理](process-software-bitmaps-with-opencv.md): この記事では、ネイティブ コードの Windows ランタイム コンポーネントである、**OpenCVBridge** を作成する手順を示します。これは、**MediaFrameReader** によって使用される **SoftwareBitmap** オブジェクトと、OpenCV ライブラリで使用される **Mat** 型との変換に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="1e42e-111">[Process software bitmaps with OpenCV](process-software-bitmaps-with-opencv.md) - This article walks you through creating a native code Windows Runtime Component, **OpenCVBridge**, which helps to convert between the **SoftwareBitmap** object, used by the **MediaFrameReader**,  and the **Mat** type used by the OpenCV library.</span></span> <span data-ttu-id="1e42e-112">この記事のサンプル コードでは、**OpenCVBridge**コンポーネントを UWP アプリ ソリューションに追加する手順を実行していることを前提としています。</span><span class="sxs-lookup"><span data-stu-id="1e42e-112">The sample code in this article assumes you have followed the steps to add the **OpenCVBridge** component to your UWP app solution.</span></span>

<span data-ttu-id="1e42e-113">これらの記事に加えて、この記事で説明したシナリオの完全でエンド ツー エンドの実用的なサンプルを表示およびダウンロードするには、Windows ユニバーサル サンプル GitHub リポジトリにある[カメラ フレームと OpenCV のサンプル](https://go.microsoft.com/fwlink/?linkid=854003)をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="1e42e-113">In addition to these articles, to view and download a full, end-to-end working sample of the scenario described in this article, see the [Camera Frames + OpenCV Sample](https://go.microsoft.com/fwlink/?linkid=854003) in the Windows Universal Samples GitHub repo.</span></span>

<span data-ttu-id="1e42e-114">NuGet パッケージを使用して、UWP アプリ プロジェクトに OpenCV ライブラリを含めます。</span><span class="sxs-lookup"><span data-stu-id="1e42e-114">Include the OpenCV library in a UWP app project by through NuGet packages.</span></span> <span data-ttu-id="1e42e-115">この記事の例では、NuGet パッケージの OpenCV.Win.Core と OpenCV.Win.ImgProc を使用します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-115">The example in this article uses the OpenCV.Win.Core and OpenCV.Win.ImgProc NuGet packages.</span></span> <span data-ttu-id="1e42e-116">記事「[OpenCV でのソフトウェア ビットマップの処理](process-software-bitmaps-with-opencv.md)」には、ソリューションにこれらのパッケージを追加するための手順も含まれています。</span><span class="sxs-lookup"><span data-stu-id="1e42e-116">The article [Process software bitmaps with OpenCV](process-software-bitmaps-with-opencv.md) includes instructions for adding these packages to your solution.</span></span> <span data-ttu-id="1e42e-117">OpenCV を使った開発に関する情報については、[http://opencv.org](http://opencv.org) をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="1e42e-117">Information developing with OpenCV can be found at [http://opencv.org](http://opencv.org)</span></span>

## <a name="implement-the-opencvhelper-native-windows-runtime-component"></a><span data-ttu-id="1e42e-118">OpenCVHelper ネイティブ Windows ランタイム コンポーネントを実装する</span><span class="sxs-lookup"><span data-stu-id="1e42e-118">Implement the OpenCVHelper native Windows Runtime Component</span></span>
<span data-ttu-id="1e42e-119">「[OpenCV によるソフトウェア ビットマップの処理](process-software-bitmaps-with-opencv.md)」の手順に従って、OpenCV ヘルパー Windows ランタイム コンポーネントを作成し、UWP アプリのソリューションにコンポーネント プロジェクトへの参照を追加します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-119">Follow the steps in [Process software bitmaps with OpenCV](process-software-bitmaps-with-opencv.md) to create the OpenCV helper Windows Runtime Component and add a reference to the component project to your UWP app solution.</span></span>

## <a name="find-available-frame-source-groups"></a><span data-ttu-id="1e42e-120">利用可能なフレーム ソース グループを検索する</span><span class="sxs-lookup"><span data-stu-id="1e42e-120">Find available frame source groups</span></span>
<span data-ttu-id="1e42e-121">最初に、メディア フレームを取得するメディア フレーム ソース グループを見つける必要があります。</span><span class="sxs-lookup"><span data-stu-id="1e42e-121">First, you need to find a media frame source group from which media frames will be obtained.</span></span> <span data-ttu-id="1e42e-122">**[MediaFrameSourceGroup.FindAllAsync](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.mediaframesourcegroup.FindAllAsync)** を呼び出して、現在のデバイスで利用可能なソース グループの一覧を取得します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-122">Get the list of available source groups on the current device by calling **[MediaFrameSourceGroup.FindAllAsync](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.mediaframesourcegroup.FindAllAsync)**.</span></span> <span data-ttu-id="1e42e-123">アプリのシナリオに必要なセンサーの種類を指定するソース グループを選択します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-123">Then select the source groups that provide the sensor types required for your app scenario.</span></span> <span data-ttu-id="1e42e-124">この例では、RGB カメラからのフレームを提供するソース グループのみが必要です。</span><span class="sxs-lookup"><span data-stu-id="1e42e-124">For this example, we simply need a source group that provides frames from an RGB camera.</span></span>

[!code-cs[OpenCVFrameSourceGroups](./code/Frames_Win10/Frames_Win10/MainPage.OpenCV.xaml.cs#SnippetOpenCVFrameSourceGroups)]

## <a name="initialize-the-mediacapture-object"></a><span data-ttu-id="1e42e-125">MediaCapture オブジェクトを初期化する</span><span class="sxs-lookup"><span data-stu-id="1e42e-125">Initialize the MediaCapture object</span></span>
<span data-ttu-id="1e42e-126">次に、前の手順で **MediaCaptureInitializationSettings** の **[SourceGroup](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacaptureinitializationsettings.SourceGroup)** プロパティを設定することによって選択したフレーム ソース グループを使うように、**MediaCapture** オブジェクトを初期化する必要があります。</span><span class="sxs-lookup"><span data-stu-id="1e42e-126">Next, you need to initialize the **MediaCapture** object to use the frame source group selected in the previous step by setting the **[SourceGroup](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacaptureinitializationsettings.SourceGroup)** property of the **MediaCaptureInitializationSettings**.</span></span>

> [!NOTE] 
> <span data-ttu-id="1e42e-127">「[OpenCV でのソフトウェア ビットマップの処理](process-software-bitmaps-with-opencv.md)」で解説する OpenCVHelper コンポーネントで使用されている手法では、処理される画像データが GPU メモリではなく CPU メモリに格納されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="1e42e-127">The technique used by the OpenCVHelper component, described in detail in [Process software bitmaps with OpenCV](process-software-bitmaps-with-opencv.md), requires that the image data resides in CPU memory, not GPU memory.</span></span> <span data-ttu-id="1e42e-128">そのため、**MediaCaptureInitializationSettings** の **[MemoryPreference](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacaptureinitializationsettings.MemoryPreference)** フィールドに **MemoryPreference.CPU** を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="1e42e-128">So, you should specify **MemoryPreference.CPU** for the **[MemoryPreference](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacaptureinitializationsettings.MemoryPreference)** field of the **MediaCaptureInitializationSettings**.</span></span>

<span data-ttu-id="1e42e-129">**MediaCapture** オブジェクトが初期化された後、**[MediaCapture.FrameSources](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacapture.FrameSources)** プロパティにアクセスして、RGB フレーム ソースへの参照を取得します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-129">After the **MediaCapture** objet has been initialized, get a reference to the RGB frame source by accessing the **[MediaCapture.FrameSources](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacapture.FrameSources)** property.</span></span>

[!code-cs[OpenCVInitMediaCapture](./code/Frames_Win10/Frames_Win10/MainPage.OpenCV.xaml.cs#SnippetOpenCVInitMediaCapture)]

## <a name="initialize-the-mediaframereader"></a><span data-ttu-id="1e42e-130">MediaFrameReader を初期化する</span><span class="sxs-lookup"><span data-stu-id="1e42e-130">Initialize the MediaFrameReader</span></span>
<span data-ttu-id="1e42e-131">次に、前の手順で取得した RGB フレーム ソースの [**MediaFrameReader**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader) を作成します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-131">Next, create a [**MediaFrameReader**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader) for the RGB frame source retrieved in the previous step.</span></span> <span data-ttu-id="1e42e-132">適切なフレーム レートを維持するために、センサーの解像度よりも低い解像度のフレームを処理する場合があります。</span><span class="sxs-lookup"><span data-stu-id="1e42e-132">In order to maintain a good frame rate, you may want to process frames that have a lower resolution than the resolution of the sensor.</span></span> <span data-ttu-id="1e42e-133">この例では、省略可能な **[BitmapSize](https://docs.microsoft.com/uwp/api/windows.graphics.imaging.bitmapsize)** 引数を、**[MediaCapture.CreateFrameReaderAsync](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacapture.createframereaderasync)** メソッドに対して指定して、フレーム リーダーによって提供されるフレームのサイズを 640 x 480 ピクセルに変更するよう要求しています。</span><span class="sxs-lookup"><span data-stu-id="1e42e-133">This example provides the optional **[BitmapSize](https://docs.microsoft.com/uwp/api/windows.graphics.imaging.bitmapsize)** argument to the **[MediaCapture.CreateFrameReaderAsync](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacapture.createframereaderasync)** method to request that frames provided by the frame reader be resized to 640 x 480 pixels.</span></span>

<span data-ttu-id="1e42e-134">フレーム リーダーを作成した後、**[FrameArrived](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.mediaframereader.FrameArrived)** イベントのハンドラーを登録します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-134">After creating the frame reader, register a handler for the **[FrameArrived](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.mediaframereader.FrameArrived)** event.</span></span> <span data-ttu-id="1e42e-135">次に、新しい **[SoftwareBitmapSource](https://docs.microsoft.com/uwp/api/windows.ui.xaml.media.imaging.softwarebitmapsource)** オブジェクトを作成します。これは、**FrameRenderer** ヘルパー クラスが処理済みの画像を表示するために使用します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-135">Then create a new **[SoftwareBitmapSource](https://docs.microsoft.com/uwp/api/windows.ui.xaml.media.imaging.softwarebitmapsource)** object, which the **FrameRenderer** helper class will use to present the processed image.</span></span> <span data-ttu-id="1e42e-136">次に、**FrameRenderer** のコンストラクターを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-136">Then call the constructor for the **FrameRenderer**.</span></span> <span data-ttu-id="1e42e-137">OpenCVBridge Windows ランタイム コンポーネントで定義されている **OpenCVHelper** クラスのインスタンスを初期化します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-137">Initialize the instance of the **OpenCVHelper** class defined in the OpenCVBridge Windows Runtime Component.</span></span> <span data-ttu-id="1e42e-138">このヘルパー クラスは、各フレームを処理するために **FrameArrived** ハンドラーで使用されます。</span><span class="sxs-lookup"><span data-stu-id="1e42e-138">This helper class is used in the **FrameArrived** handler to process each frame.</span></span> <span data-ttu-id="1e42e-139">最後に、**[StartAsync](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.mediaframereader.StartAsync)** を呼び出して、フレーム リーダーを開始します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-139">Finally, start the frame reader by calling **[StartAsync](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.mediaframereader.StartAsync)**.</span></span>

[!code-cs[OpenCVFrameReader](./code/Frames_Win10/Frames_Win10/MainPage.OpenCV.xaml.cs#SnippetOpenCVFrameReader)]


## <a name="handle-the-framearrived-event"></a><span data-ttu-id="1e42e-140">FrameArrived イベントを処理する</span><span class="sxs-lookup"><span data-stu-id="1e42e-140">Handle the FrameArrived event</span></span>
<span data-ttu-id="1e42e-141">フレーム リーダーからの新しいフレームが利用可能になると、**FrameArrived** イベントが発生します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-141">The **FrameArrived** event is raised whenever a new frame is available from the frame reader.</span></span> <span data-ttu-id="1e42e-142">フレームが存在する場合は、**[TryAcquireLatestFrame](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.mediaframereader.TryAcquireLatestFrame)** を呼び出してフレームを取得します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-142">Call **[TryAcquireLatestFrame](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.mediaframereader.TryAcquireLatestFrame)** to get the frame, if it exists.</span></span> <span data-ttu-id="1e42e-143">**[MediaFrameReference](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.mediaframereference)** から **SoftwareBitmap** を取得します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-143">Get the **SoftwareBitmap** from the **[MediaFrameReference](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.mediaframereference)**.</span></span> <span data-ttu-id="1e42e-144">この例で使用されている **CVHelper** クラスでは、画像がプリマルチプライ済みアルファを含む  BRGA8 ピクセル形式を使用している必要があります。</span><span class="sxs-lookup"><span data-stu-id="1e42e-144">Note that the **CVHelper** class used in this example requires images to use the BRGA8 pixel format with premultiplied alpha.</span></span> <span data-ttu-id="1e42e-145">イベントに渡されたフレームが別の形式である場合は、**SoftwareBitmap** を正しい形式に変換します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-145">If the frame passed into the event has a different format, convert the **SoftwareBitmap** to the correct format.</span></span> <span data-ttu-id="1e42e-146">次に、ぼかし操作のターゲットとして使用される **SoftwareBitmap** を作成します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-146">Next, create a **SoftwareBitmap** to be used as the target of the blur operation.</span></span> <span data-ttu-id="1e42e-147">一致する形式のビットマップを作成するために、ソース画像のプロパティがコンストラクターの引数として使用されます。</span><span class="sxs-lookup"><span data-stu-id="1e42e-147">The source image properties are used as arguments to the constructor to create a bitmap with matching format.</span></span> <span data-ttu-id="1e42e-148">ヘルパー クラスの **Blur** メソッドを呼び出してフレームを処理します。</span><span class="sxs-lookup"><span data-stu-id="1e42e-148">Call the helper class **Blur** method to process the frame.</span></span> <span data-ttu-id="1e42e-149">最後に、ぼかし操作の出力画像を **PresentSoftwareBitmap** メソッドに渡します。これは、画像が初期化された XAML **Image** コントロールに画像を表示する **FrameRenderer** ヘルパー クラスのメソッドです。</span><span class="sxs-lookup"><span data-stu-id="1e42e-149">Finally, pass the output image of the blur operation into **PresentSoftwareBitmap**, the method of the **FrameRenderer** helper class that displays the image in the XAML **Image** control with which it was initialized.</span></span>

[!code-cs[OpenCVFrameArrived](./code/Frames_Win10/Frames_Win10/MainPage.OpenCV.xaml.cs#SnippetOpenCVFrameArrived)]

## <a name="related-topics"></a><span data-ttu-id="1e42e-150">関連トピック</span><span class="sxs-lookup"><span data-stu-id="1e42e-150">Related topics</span></span>

* [<span data-ttu-id="1e42e-151">カメラ</span><span class="sxs-lookup"><span data-stu-id="1e42e-151">Camera</span></span>](camera.md)
* [<span data-ttu-id="1e42e-152">MediaCapture を使った基本的な写真、ビデオ、およびオーディオのキャプチャ</span><span class="sxs-lookup"><span data-stu-id="1e42e-152">Basic photo, video, and audio capture with MediaCapture</span></span>](basic-photo-video-and-audio-capture-with-MediaCapture.md)
* [<span data-ttu-id="1e42e-153">MediaFrameReader を使ったメディア フレームの処理</span><span class="sxs-lookup"><span data-stu-id="1e42e-153">Process media frames with MediaFrameReader</span></span>](process-media-frames-with-mediaframereader.md)
* [<span data-ttu-id="1e42e-154">OpenCV でのソフトウェア ビットマップの処理</span><span class="sxs-lookup"><span data-stu-id="1e42e-154">Process software bitmaps with OpenCV</span></span>](process-software-bitmaps-with-opencv.md)
* [<span data-ttu-id="1e42e-155">カメラ フレームのサンプル</span><span class="sxs-lookup"><span data-stu-id="1e42e-155">Camera frames sample</span></span>](http://go.microsoft.com/fwlink/?LinkId=823230)
* [<span data-ttu-id="1e42e-156">カメラ フレームと OpenCV のサンプル</span><span class="sxs-lookup"><span data-stu-id="1e42e-156">Camera Frames + OpenCV Sample</span></span>](https://go.microsoft.com/fwlink/?linkid=854003)
 

 




