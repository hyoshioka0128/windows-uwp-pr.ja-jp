---
ms.assetid: 40B97E0C-EB1B-40C2-A022-1AB95DFB085E
description: この記事では、ユニバーサル Windows アプリからリモート デバイスにメディアをキャストする方法について説明します。
title: メディアのキャスト
ms.date: 02/08/2017
ms.topic: article
keywords: windows 10, uwp
ms.localizationpriority: medium
ms.openlocfilehash: 2318d873a55b4134cf36eda91b57866e14b6b3a7
ms.sourcegitcommit: ac7f3422f8d83618f9b6b5615a37f8e5c115b3c4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/29/2019
ms.locfileid: "66361726"
---
# <a name="media-casting"></a><span data-ttu-id="26f3c-104">メディアのキャスト</span><span class="sxs-lookup"><span data-stu-id="26f3c-104">Media casting</span></span>



<span data-ttu-id="26f3c-105">この記事では、ユニバーサル Windows アプリからリモート デバイスにメディアをキャストする方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-105">This article shows you how to cast media to remote devices from a Universal Windows app.</span></span>

## <a name="built-in-media-casting-with-mediaplayerelement"></a><span data-ttu-id="26f3c-106">MediaPlayerElement を使った組み込みのメディア キャスト機能</span><span class="sxs-lookup"><span data-stu-id="26f3c-106">Built-in media casting with MediaPlayerElement</span></span>

<span data-ttu-id="26f3c-107">ユニバーサル Windows アプリからメディアをキャストする方法としては、[**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.Controls.MediaPlayerElement) コントロールの組み込みのキャスト機能を使うのが最も簡単です。</span><span class="sxs-lookup"><span data-stu-id="26f3c-107">The simplest way to cast media from a Universal Windows app is to use the built-in casting capability of the [**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.Controls.MediaPlayerElement) control.</span></span>

<span data-ttu-id="26f3c-108">**MediaPlayerElement** コントロールで再生するビデオ ファイルをユーザーが開くことができるようにするには、以下の名前空間をプロジェクトに追加します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-108">To allow the user to open a video file to be played in the **MediaPlayerElement** control, add the following namespaces to your project.</span></span>

[!code-cs[BuiltInCastingUsing](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetBuiltInCastingUsing)]

<span data-ttu-id="26f3c-109">アプリの XAML ファイルに **MediaPlayerElement** を追加し、[**AreTransportControlsEnabled**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaelement.aretransportcontrolsenabled) を true に設定します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-109">In your app's XAML file, add a **MediaPlayerElement** and set [**AreTransportControlsEnabled**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaelement.aretransportcontrolsenabled) to true.</span></span>

[!code-xml[MediaElement](./code/MediaCasting_RS1/cs/MainPage.xaml#SnippetMediaElement)]

<span data-ttu-id="26f3c-110">ユーザーがファイルを選択するときに使うボタンを追加します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-110">Add a button to let the user initiate picking a file.</span></span>

[!code-xml[OpenButton](./code/MediaCasting_RS1/cs/MainPage.xaml#SnippetOpenButton)]

<span data-ttu-id="26f3c-111">このボタンの [**Click**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.primitives.buttonbase.click) イベント ハンドラーで [**FileOpenPicker**](https://docs.microsoft.com/uwp/api/Windows.Storage.Pickers.FileOpenPicker) の新しいインスタンスを作成し、ビデオ ファイルの種類を [**FileTypeFilter**](https://docs.microsoft.com/uwp/api/windows.storage.pickers.fileopenpicker.filetypefilter) コレクションに追加して、開始位置をユーザーのビデオ ライブラリに設定します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-111">In the [**Click**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.primitives.buttonbase.click) event handler for the button, create a new instance of the [**FileOpenPicker**](https://docs.microsoft.com/uwp/api/Windows.Storage.Pickers.FileOpenPicker), add video file types to the [**FileTypeFilter**](https://docs.microsoft.com/uwp/api/windows.storage.pickers.fileopenpicker.filetypefilter) collection, and set the starting location to the user's videos library.</span></span>

<span data-ttu-id="26f3c-112">[  **PickSingleFileAsync**](https://docs.microsoft.com/uwp/api/windows.storage.pickers.fileopenpicker.picksinglefileasync) を呼び出して、ファイル ピッカー ダイアログを起動します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-112">Call [**PickSingleFileAsync**](https://docs.microsoft.com/uwp/api/windows.storage.pickers.fileopenpicker.picksinglefileasync) to launch the file picker dialog.</span></span> <span data-ttu-id="26f3c-113">このメソッドからは、ビデオ ファイルを表す [**StorageFile**](https://docs.microsoft.com/uwp/api/Windows.Storage.StorageFile) オブジェクトが返されます。</span><span class="sxs-lookup"><span data-stu-id="26f3c-113">When this method returns, the result is a [**StorageFile**](https://docs.microsoft.com/uwp/api/Windows.Storage.StorageFile) object representing the video file.</span></span> <span data-ttu-id="26f3c-114">ファイル選択操作をユーザーが取り消した場合は null が返されます。返されたファイルが null ではないことを確認してください。</span><span class="sxs-lookup"><span data-stu-id="26f3c-114">Check to make sure the file isn't null, which it will be if the user cancels the picking operation.</span></span> <span data-ttu-id="26f3c-115">ファイルの [**IRandomAccessStream**](https://docs.microsoft.com/uwp/api/Windows.Storage.Streams.IRandomAccessStream) を取得するには、そのファイルの [**OpenAsync**](https://docs.microsoft.com/uwp/api/windows.storage.storagefile.openasync) メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-115">Call the file's [**OpenAsync**](https://docs.microsoft.com/uwp/api/windows.storage.storagefile.openasync) method to get an [**IRandomAccessStream**](https://docs.microsoft.com/uwp/api/Windows.Storage.Streams.IRandomAccessStream) for the file.</span></span> <span data-ttu-id="26f3c-116">最後に、[**CreateFromStorageFile**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.createfromstoragefile) を呼び出して選択したファイルから新しい **MediaSource** オブジェクトを作成し、そのオブジェクトを **MediaPlayerElement** オブジェクトの [**Source**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement.source) プロパティに割り当てて、そのビデオ ファイルをコントロールのビデオ ソースに設定します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-116">Finally, create a new **MediaSource** object from the selected file by calling [**CreateFromStorageFile**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.createfromstoragefile) and assign it to the **MediaPlayerElement** object's [**Source**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement.source) property to make the video file the video source for the control.</span></span>

[!code-cs[OpenButtonClick](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetOpenButtonClick)]

<span data-ttu-id="26f3c-117">**MediaPlayerElement** にビデオを読み込んだら、ユーザーがトランスポート コントロールのキャスト ボタンを押すだけで、組み込みのダイアログを起動し、読み込まれているメディアのキャスト先となるデバイスを選択できます。</span><span class="sxs-lookup"><span data-stu-id="26f3c-117">Once the video is loaded in the **MediaPlayerElement**, the user can simply press the casting button on the transport controls to launch a built-in dialog that allows them to choose a device to which the loaded media will be cast.</span></span>

![mediaelement casting button](images/media-element-casting-button.png)

> [!NOTE] 
> <span data-ttu-id="26f3c-119">Windows 10 バージョン 1607 以降、メディア項目の再生には、**MediaPlayer** クラスを使うことをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="26f3c-119">Starting with Windows 10, version 1607, it is recommended that you use the **MediaPlayer** class to play media items.</span></span> <span data-ttu-id="26f3c-120">**MediaPlayerElement** は、XAML ページの **MediaPlayer** コンテンツをレンダリングするために使われる軽量の XAML コントロールです。</span><span class="sxs-lookup"><span data-stu-id="26f3c-120">The **MediaPlayerElement** is a lightweight XAML control that is used to render the content of a **MediaPlayer** in a XAML page.</span></span> <span data-ttu-id="26f3c-121">下位互換性を確保するため、**MediaElement**コントロールも引き続きサポートされています。</span><span class="sxs-lookup"><span data-stu-id="26f3c-121">The **MediaElement** control continues to be supported for backwards compatibility.</span></span> <span data-ttu-id="26f3c-122">**MediaPlayer** と **MediaPlayerElement** を使ってメディア コンテンツを再生する方法について詳しくは、「[MediaPlayer を使ったオーディオとビデオの再生](play-audio-and-video-with-mediaplayer.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="26f3c-122">For more information on using **MediaPlayer** and **MediaPlayerElement** to play media content, see [Play audio and video with MediaPlayer](play-audio-and-video-with-mediaplayer.md).</span></span> <span data-ttu-id="26f3c-123">**MediaSource** と関連の API を使ってメディア コンテンツを操作する方法について詳しくは、「[メディア項目、プレイリスト、トラック](media-playback-with-mediasource.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="26f3c-123">For information on using **MediaSource** and related APIs to work with media content, see [Media items, playlists, and tracks](media-playback-with-mediasource.md).</span></span>

## <a name="media-casting-with-the-castingdevicepicker"></a><span data-ttu-id="26f3c-124">CastingDevicePicker を使ったメディアのキャスト</span><span class="sxs-lookup"><span data-stu-id="26f3c-124">Media casting with the CastingDevicePicker</span></span>

<span data-ttu-id="26f3c-125">メディアをデバイスにキャストするもう 1 つの方法は、[**CastingDevicePicker**](https://docs.microsoft.com/uwp/api/Windows.Media.Casting.CastingDevicePicker) を使うことです。</span><span class="sxs-lookup"><span data-stu-id="26f3c-125">A second way to cast media to a device is to use the [**CastingDevicePicker**](https://docs.microsoft.com/uwp/api/Windows.Media.Casting.CastingDevicePicker).</span></span> <span data-ttu-id="26f3c-126">このクラスを使うには、プロジェクトに [**Windows.Media.Casting**](https://docs.microsoft.com/uwp/api/Windows.Media.Casting) 名前空間を追加します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-126">To use this class, include the [**Windows.Media.Casting**](https://docs.microsoft.com/uwp/api/Windows.Media.Casting) namespace in your project.</span></span>

[!code-cs[CastingNamespace](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetCastingNamespace)]

<span data-ttu-id="26f3c-127">**CastingDevicePicker** オブジェクトのメンバー変数を宣言します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-127">Declare a member variable for the **CastingDevicePicker** object.</span></span>

[!code-cs[DeclareCastingPicker](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetDeclareCastingPicker)]

<span data-ttu-id="26f3c-128">対象のページが初期化されたタイミングで CastingDevicePicker の新しいインスタンスを作成します。さらに、ビデオをサポートするデバイスだけをキャスト先としてピッカーに一覧表示するために、[**Filter**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevicepicker.filter) を [**SupportsVideo**](https://docs.microsoft.com/uwp/api/Windows.Media.Casting.CastingDevicePickerFilter) プロパティに設定します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-128">When you page is initialized, create a new instance of the casting picker and set the [**Filter**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevicepicker.filter) to [**SupportsVideo**](https://docs.microsoft.com/uwp/api/Windows.Media.Casting.CastingDevicePickerFilter) property to indicate that the casting devices listed by the picker should support video.</span></span> <span data-ttu-id="26f3c-129">[  **CastingDeviceSelected**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevicepicker.castingdeviceselected) イベントのハンドラーを登録します。これは、ユーザーがキャスト先のデバイスを選んだときに発生するイベントです。</span><span class="sxs-lookup"><span data-stu-id="26f3c-129">Register a handler for the [**CastingDeviceSelected**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevicepicker.castingdeviceselected) event, which is raised when the user picks a device for casting.</span></span>

[!code-cs[InitCastingPicker](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetInitCastingPicker)]

<span data-ttu-id="26f3c-130">ユーザーがピッカーを起動するためのボタンを XAML ファイルに追加します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-130">In your XAML file, add a button to allow the user to launch the picker.</span></span>

[!code-xml[CastPickerButton](./code/MediaCasting_RS1/cs/MainPage.xaml#SnippetCastPickerButton)]

<span data-ttu-id="26f3c-131">ボタンの **Click** イベント ハンドラーで [**TransformToVisual**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.uielement.) を呼び出し、別の要素を基準とした UI 要素の変換を取得します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-131">In the **Click** event handler for the button, call [**TransformToVisual**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.uielement.) to get the transform of a UI element relative to another element.</span></span> <span data-ttu-id="26f3c-132">この例の変換は、アプリケーション ウィンドウの表示ルートを基準としたキャスト ピッカー ボタンの位置です。</span><span class="sxs-lookup"><span data-stu-id="26f3c-132">In this example, the transform is the position of the cast picker button relative to the visual root of the application window.</span></span> <span data-ttu-id="26f3c-133">[  **CastingDevicePicker**](https://docs.microsoft.com/uwp/api/Windows.Media.Casting.CastingDevicePicker) オブジェクトの [**Show**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevicepicker.show) メソッドを呼び出して、キャスト先の選択ダイアログを起動します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-133">Call the [**Show**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevicepicker.show) method of the [**CastingDevicePicker**](https://docs.microsoft.com/uwp/api/Windows.Media.Casting.CastingDevicePicker) object to launch the casting picker dialog.</span></span> <span data-ttu-id="26f3c-134">ユーザーによって押されたボタンから飛び出すようにダイアログを表示させるため、キャスト ピッカー ボタンの位置とサイズを指定します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-134">Specify the location and dimensions of the cast picker button so that the system can make the dialog fly out from the button that the user pressed.</span></span>

[!code-cs[CastPickerButtonClick](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetCastPickerButtonClick)]

<span data-ttu-id="26f3c-135">**CastingDeviceSelected** イベント ハンドラーで、イベント引数の [**SelectedCastingDevice**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdeviceselectedeventargs.selectedcastingdevice) プロパティ (ユーザーが選択したキャスト先デバイスを表す) の [**CreateCastingConnection**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevice.createcastingconnection) メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-135">In the **CastingDeviceSelected** event handler, call the [**CreateCastingConnection**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevice.createcastingconnection) method of the [**SelectedCastingDevice**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdeviceselectedeventargs.selectedcastingdevice) property of the event args, which represents the casting device selected by the user.</span></span> <span data-ttu-id="26f3c-136">[  **ErrorOccurred**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.erroroccurred) イベントと [**StateChanged**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.statechanged) イベントのハンドラーを登録します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-136">Register handlers for the [**ErrorOccurred**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.erroroccurred) and [**StateChanged**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.statechanged) events.</span></span> <span data-ttu-id="26f3c-137">最後に、[**RequestStartCastingAsync**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.requeststartcastingasync) を呼び出すとキャストが開始されます。キャストするメディアが **MediaPlayerElement** に関連付けられた **MediaPlayer** のコンテンツであることを指定するために、このメソッドの引数には、**MediaPlayerElement** コントロールの **MediaPlayer** オブジェクトの [**GetAsCastingSource**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaelement.getascastingsource) メソッドの結果を渡します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-137">Finally, call [**RequestStartCastingAsync**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.requeststartcastingasync) to begin casting, passing in the result to the **MediaPlayerElement** control's **MediaPlayer** object's [**GetAsCastingSource**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaelement.getascastingsource) method to specify that the media to be cast is the content of the **MediaPlayer** associated with the **MediaPlayerElement**.</span></span>

> [!NOTE] 
> <span data-ttu-id="26f3c-138">キャスト接続は UI スレッドで開始する必要があります。</span><span class="sxs-lookup"><span data-stu-id="26f3c-138">The casting connection must be initiated on the UI thread.</span></span> <span data-ttu-id="26f3c-139">**CastingDeviceSelected** は UI スレッドでは呼び出されないため、上に挙げた一連の呼び出しを、[**CoreDispatcher.RunAsync**](https://docs.microsoft.com/uwp/api/windows.ui.core.coredispatcher.windows) の呼び出しの中に置いて、UI スレッドで呼び出されるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="26f3c-139">Since the **CastingDeviceSelected** is not called on the UI thread, you must place these calls inside a call to [**CoreDispatcher.RunAsync**](https://docs.microsoft.com/uwp/api/windows.ui.core.coredispatcher.windows) which causes them to be called on the UI thread.</span></span>

[!code-cs[CastingDeviceSelected](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetCastingDeviceSelected)]

<span data-ttu-id="26f3c-140">**ErrorOccurred** イベントと **StateChanged** イベントのハンドラーでは、UI を更新して、現在のキャスト ステータスをユーザーに通知する必要があります。</span><span class="sxs-lookup"><span data-stu-id="26f3c-140">In the **ErrorOccurred** and **StateChanged** event handlers, you should update your UI to inform the user of the current casting status.</span></span> <span data-ttu-id="26f3c-141">これらのイベントについては、次のセクションで、カスタムのキャスト先デバイス ピッカーを作成する方法の中で詳しく説明します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-141">These events are discussed in detail in the following section on creating a custom casting device picker.</span></span>

[!code-cs[EmptyStateHandlers](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetEmptyStateHandlers)]

## <a name="media-casting-with-a-custom-device-picker"></a><span data-ttu-id="26f3c-142">カスタム デバイス ピッカーを使ったメディアのキャスト</span><span class="sxs-lookup"><span data-stu-id="26f3c-142">Media casting with a custom device picker</span></span>

<span data-ttu-id="26f3c-143">次のセクションでは、独自のコードでキャスト先デバイスを列挙し、接続を開始することによって、キャスト先デバイス ピッカーの UI を作成する方法を説明します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-143">The following section describes how to create your own casting device picker UI by enumerating the casting devices and initiating the connection from your code.</span></span>

<span data-ttu-id="26f3c-144">利用可能なキャスト先デバイスを列挙するには、[**Windows.Devices.Enumeration**](https://docs.microsoft.com/uwp/api/Windows.Devices.Enumeration) 名前空間をプロジェクトに追加します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-144">To enumerate the available casting devices, include the [**Windows.Devices.Enumeration**](https://docs.microsoft.com/uwp/api/Windows.Devices.Enumeration) namespace in your project.</span></span>

[!code-cs[EnumerationNamespace](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetEnumerationNamespace)]

<span data-ttu-id="26f3c-145">この例の基本的な UI を実装するために、以下のコントロールを XAML ページに追加します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-145">Add the following controls to your XAML page to implement the rudimentary UI for this example:</span></span>

-   <span data-ttu-id="26f3c-146">利用可能なキャスト先デバイスを探すデバイス ウォッチャーの起動ボタン。</span><span class="sxs-lookup"><span data-stu-id="26f3c-146">A button to start the device watcher that looks for available casting devices.</span></span>
-   <span data-ttu-id="26f3c-147">キャスト先を列挙する処理の進行状況をユーザーにフィードバックする [**ProgressRing**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.Controls.ProgressRing) コントロール。</span><span class="sxs-lookup"><span data-stu-id="26f3c-147">A [**ProgressRing**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.Controls.ProgressRing) control to provide feedback to the user that casting enumeration is ongoing.</span></span>
-   <span data-ttu-id="26f3c-148">検出されたキャスト先デバイスを一覧表示する [**ListBox**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.Controls.ListBox)。</span><span class="sxs-lookup"><span data-stu-id="26f3c-148">A [**ListBox**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.Controls.ListBox) to list the discovered casting devices.</span></span> <span data-ttu-id="26f3c-149">キャスト先デバイス オブジェクトを直接コントロールに割り当てたうえで、さらに [**FriendlyName**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevice.friendlyname) プロパティを表示できるようにコントロールの [**ItemTemplate**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.itemscontrol.itemtemplate) を定義します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-149">Define an [**ItemTemplate**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.itemscontrol.itemtemplate) for the control so that we can assign the casting device objects directly to the control and still display the [**FriendlyName**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevice.friendlyname) property.</span></span>
-   <span data-ttu-id="26f3c-150">キャスト先デバイスとの接続をユーザーが切断するためのボタン。</span><span class="sxs-lookup"><span data-stu-id="26f3c-150">A button to allow the user to disconnect the casting device.</span></span>

[!code-xml[CustomPickerXAML](./code/MediaCasting_RS1/cs/MainPage.xaml#SnippetCustomPickerXAML)]

<span data-ttu-id="26f3c-151">分離コードには、[**DeviceWatcher**](https://docs.microsoft.com/uwp/api/Windows.Devices.Enumeration.DeviceWatcher) と [**CastingConnection**](https://docs.microsoft.com/uwp/api/Windows.Media.Casting.CastingConnection) のメンバー変数を宣言します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-151">In your code behind, declare member variables for the [**DeviceWatcher**](https://docs.microsoft.com/uwp/api/Windows.Devices.Enumeration.DeviceWatcher) and the [**CastingConnection**](https://docs.microsoft.com/uwp/api/Windows.Media.Casting.CastingConnection).</span></span>

[!code-cs[DeclareDeviceWatcher](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetDeclareDeviceWatcher)]

<span data-ttu-id="26f3c-152">*startWatcherButton* の **Click** ハンドラーでまず行うのは UI の更新です。デバイスの列挙中はボタンを無効にし、プログレス リングをアクティブにします。</span><span class="sxs-lookup"><span data-stu-id="26f3c-152">In the **Click** handler for the *startWatcherButton*, first update the UI by disabling the button and making the progress ring active while device enumeration is ongoing.</span></span> <span data-ttu-id="26f3c-153">キャスト先デバイスのリスト ボックスをクリアします。</span><span class="sxs-lookup"><span data-stu-id="26f3c-153">Clear the list box of casting devices.</span></span>

<span data-ttu-id="26f3c-154">次に、[**DeviceInformation.CreateWatcher**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.deviceinformation.createwatcher) を呼び出してデバイス ウォッチャーを作成します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-154">Next, create a device watcher by calling [**DeviceInformation.CreateWatcher**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.deviceinformation.createwatcher).</span></span> <span data-ttu-id="26f3c-155">このメソッドを使うと、さまざまな種類のデバイスを監視することができます。</span><span class="sxs-lookup"><span data-stu-id="26f3c-155">This method can be used to watch for many different types of devices.</span></span> <span data-ttu-id="26f3c-156">ビデオ キャストに対応しているデバイスを監視対象として指定するには、[**CastingDevice.GetDeviceSelector**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevice.getdeviceselector) から返されるデバイスのセレクター文字列を使います。</span><span class="sxs-lookup"><span data-stu-id="26f3c-156">Specify that you want to watch for devices that support video casting by using the device selector string returned by [**CastingDevice.GetDeviceSelector**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevice.getdeviceselector).</span></span>

<span data-ttu-id="26f3c-157">最後に、[**Added**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.devicewatcher.added)、[**Removed**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.devicewatcher.removed)、[**EnumerationCompleted**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.devicewatcher.enumerationcompleted)、[**Stopped**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.devicewatcher.stopped) の各イベントのハンドラーを登録します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-157">Finally, register event handlers for the [**Added**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.devicewatcher.added), [**Removed**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.devicewatcher.removed), [**EnumerationCompleted**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.devicewatcher.enumerationcompleted), and [**Stopped**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.devicewatcher.stopped) events.</span></span>

[!code-cs[StartWatcherButtonClick](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetStartWatcherButtonClick)]

<span data-ttu-id="26f3c-158">**Added** は、ウォッチャーで新しいデバイスが検出されたときに発生するイベントです。</span><span class="sxs-lookup"><span data-stu-id="26f3c-158">The **Added** event is raised when a new device is discovered by the watcher.</span></span> <span data-ttu-id="26f3c-159">このイベントのハンドラーで [**CastingDevice.FromIdAsync**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevice.fromidasync) を呼び出して新しい [**CastingDevice**](https://docs.microsoft.com/uwp/api/Windows.Media.Casting.CastingDevice) オブジェクトを作成します。このメソッドの引数には、検出されたキャスト先デバイスの ID を指定します。ID は、ハンドラーに渡された **DeviceInformation** オブジェクトに格納されています。</span><span class="sxs-lookup"><span data-stu-id="26f3c-159">In the handler for this event, create a new [**CastingDevice**](https://docs.microsoft.com/uwp/api/Windows.Media.Casting.CastingDevice) object by calling [**CastingDevice.FromIdAsync**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevice.fromidasync) and passing in the ID of the discovered casting device, which is contained in the **DeviceInformation** object passed into the handler.</span></span>

<span data-ttu-id="26f3c-160">この **CastingDevice** をキャスト先デバイスの **ListBox** に追加して、ユーザーが選択できるようにします。</span><span class="sxs-lookup"><span data-stu-id="26f3c-160">Add the **CastingDevice** to the casting device **ListBox** so that the user can select it.</span></span> <span data-ttu-id="26f3c-161">リスト ボックスの項目テキストには、XAML で定義した [**ItemTemplate**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.itemscontrol.itemtemplate) により、[**FriendlyName**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevice.friendlyname) プロパティが使われます。</span><span class="sxs-lookup"><span data-stu-id="26f3c-161">Because of the [**ItemTemplate**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.itemscontrol.itemtemplate) defined in the XAML, the [**FriendlyName**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevice.friendlyname) property will be used as the item text for in the list box.</span></span> <span data-ttu-id="26f3c-162">このイベント ハンドラーは UI スレッドで呼び出されないため、UI の更新は、[**CoreDispatcher.RunAsync**](https://docs.microsoft.com/uwp/api/windows.ui.core.coredispatcher.windows) の呼び出しの中で行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="26f3c-162">Because this event handler is not called on the UI thread, you must update the UI from within a call to [**CoreDispatcher.RunAsync**](https://docs.microsoft.com/uwp/api/windows.ui.core.coredispatcher.windows).</span></span>

[!code-cs[WatcherAdded](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetWatcherAdded)]

<span data-ttu-id="26f3c-163">キャスト先デバイスがもう存在しないことをウォッチャーが検出すると、**Removed** イベントが発生します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-163">The **Removed** event is raised when the watcher detects that a casting device is no longer present.</span></span> <span data-ttu-id="26f3c-164">ハンドラーに渡された **Added** オブジェクトの ID プロパティと、リスト ボックスの [**Items**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.itemscontrol.items) コレクションに含まれている各 **Added** の ID とを比較します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-164">Compare the ID property of the **Added** object passed into the handler to the ID of each **Added** in the list box's [**Items**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.itemscontrol.items) collection.</span></span> <span data-ttu-id="26f3c-165">ID が一致する場合は、そのオブジェクトをコレクションから削除します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-165">If the ID matches, remove that object from the collection.</span></span> <span data-ttu-id="26f3c-166">UI が更新中であるため、先ほどと同様、この呼び出しは **RunAsync** の呼び出しの中で行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="26f3c-166">Again, because the UI is being updated, this call must be made from within a **RunAsync** call.</span></span>

[!code-cs[WatcherRemoved](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetWatcherRemoved)]

<span data-ttu-id="26f3c-167">ウォッチャーがデバイスの検出を完了すると、**EnumerationCompleted** イベントが発生します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-167">The **EnumerationCompleted** event is raised when the watcher has finished detecting devices.</span></span> <span data-ttu-id="26f3c-168">このイベントのハンドラーで UI を更新して、デバイスの列挙処理が完了したことをユーザーに知らせ、[**Stop**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.devicewatcher.stop) を呼び出してデバイス ウォッチャーを停止します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-168">In the handler for this event, update the UI to let the user know that device enumeration has completed and stop the device watcher by calling [**Stop**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.devicewatcher.stop).</span></span>

[!code-cs[WatcherEnumerationCompleted](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetWatcherEnumerationCompleted)]

<span data-ttu-id="26f3c-169">デバイス ウォッチャーの停止処理が完了すると Stopped イベントが発生します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-169">The Stopped event is raised when the device watcher has finished stopping.</span></span> <span data-ttu-id="26f3c-170">このイベントのハンドラーで [**ProgressRing**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.Controls.ProgressRing) コントロールを停止したうえで、デバイス列挙処理をユーザーが再開できるように *startWatcherButton* を再び有効にします。</span><span class="sxs-lookup"><span data-stu-id="26f3c-170">In the handler for this event, stop the [**ProgressRing**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.Controls.ProgressRing) control and reenable the *startWatcherButton* so that the user can restart the device enumeration process.</span></span>

[!code-cs[WatcherStopped](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetWatcherStopped)]

<span data-ttu-id="26f3c-171">リスト ボックスからいずれかのキャスト先デバイスをユーザーが選択すると、[**SelectionChanged**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.primitives.selector.selectionchanged) イベントが発生します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-171">When the user selects one of the casting devices from the list box, the [**SelectionChanged**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.primitives.selector.selectionchanged) event is raised.</span></span> <span data-ttu-id="26f3c-172">このハンドラーの中でキャスト接続を作成し、キャストを開始することになります。</span><span class="sxs-lookup"><span data-stu-id="26f3c-172">It is within this handler that the casting connection will be created and casting will be started.</span></span>

<span data-ttu-id="26f3c-173">まず、デバイスの列挙処理がメディアのキャスト処理に干渉しないよう、デバイス ウォッチャーが停止していることを確認します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-173">First, make sure the device watcher is stopped so that device enumeration doesn't interfere with media casting.</span></span> <span data-ttu-id="26f3c-174">キャスト接続を作成するには、ユーザーが選択した **CastingDevice** オブジェクトの [**CreateCastingConnection**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevice.createcastingconnection) を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-174">Create a casting connection by calling [**CreateCastingConnection**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingdevice.createcastingconnection) on the **CastingDevice** object selected by the user.</span></span> <span data-ttu-id="26f3c-175">[  **StateChanged**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.statechanged) イベントおよび [**ErrorOccurred**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.erroroccurred) イベントに対応するイベント ハンドラーを追加します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-175">Add event handlers for the [**StateChanged**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.statechanged) and [**ErrorOccurred**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.erroroccurred) events.</span></span>

<span data-ttu-id="26f3c-176">メディアのキャストを開始するには、[**RequestStartCastingAsync**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.requeststartcastingasync) を呼び出します。その際、引数には、**MediaPlayer** の [**GetAsCastingSource**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaelement.getascastingsource) メソッドを呼び出して取得したキャスト ソースを指定します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-176">Start media casting by calling [**RequestStartCastingAsync**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.requeststartcastingasync), passing in the casting source returned by calling the **MediaPlayer** method [**GetAsCastingSource**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaelement.getascastingsource).</span></span> <span data-ttu-id="26f3c-177">最後に、メディアのキャストをユーザーが停止するための切断ボタンを表示状態にします。</span><span class="sxs-lookup"><span data-stu-id="26f3c-177">Finally, make the disconnect button visible to allow the user to stop media casting.</span></span>

[!code-cs[SelectionChanged](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetSelectionChanged)]

<span data-ttu-id="26f3c-178">StateChanged ハンドラーで実行する操作は、キャスト接続の新しい状態によって異なります。</span><span class="sxs-lookup"><span data-stu-id="26f3c-178">In the state changed handler, the action you take depends on the new state of the casting connection:</span></span>

-   <span data-ttu-id="26f3c-179">状態が **Connected** または **Rendering** である場合は、**ProgressRing** コントロールを非アクティブにし、切断ボタンを表示します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-179">If the state is **Connected** or **Rendering**, make sure the **ProgressRing** control is inactive and the disconnect button is visible.</span></span>
-   <span data-ttu-id="26f3c-180">状態が **Disconnected** である場合は、現在のキャスト先デバイスの選択をリスト ボックスで解除し、**ProgressRing** コントロールを非アクティブにして、切断ボタンを非表示にします。</span><span class="sxs-lookup"><span data-stu-id="26f3c-180">If the state is **Disconnected**, unselect the current casting device in the list box, make the **ProgressRing** control inactive, and hide the disconnect button.</span></span>
-   <span data-ttu-id="26f3c-181">状態が **Connecting** である場合は、**ProgressRing** コントロールをアクティブにして、切断ボタンを非表示にします。</span><span class="sxs-lookup"><span data-stu-id="26f3c-181">If the state is **Connecting**, make the **ProgressRing** control active and hide the disconnect button.</span></span>
-   <span data-ttu-id="26f3c-182">状態が **Disconnecting** である場合は、**ProgressRing** コントロールをアクティブにして、切断ボタンを非表示にします。</span><span class="sxs-lookup"><span data-stu-id="26f3c-182">If the state is **Disconnecting**, make the **ProgressRing** control active and hide the disconnect button.</span></span>

[!code-cs[StateChanged](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetStateChanged)]

<span data-ttu-id="26f3c-183">**ErrorOccurred** イベントのハンドラーでは、UI を更新してキャスト エラーの発生をユーザーに知らせると共に、リスト ボックスで現在の **CastingDevice** オブジェクトの選択を解除します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-183">In the handler for the **ErrorOccurred** event, update your UI to let the user know that a casting error occurred and unselect the current **CastingDevice** object in the list box.</span></span>

[!code-cs[ErrorOccurred](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetErrorOccurred)]

<span data-ttu-id="26f3c-184">最後に、切断ボタンのハンドラーを実装します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-184">Finally, implement the handler for the disconnect button.</span></span> <span data-ttu-id="26f3c-185">メディアのキャストを停止してキャスト先デバイスから切断するために、**CastingConnection** オブジェクトの [**DisconnectAsync**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.disconnectasync) メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="26f3c-185">Stop media casting and disconnect from the casting device by calling the **CastingConnection** object's [**DisconnectAsync**](https://docs.microsoft.com/uwp/api/windows.media.casting.castingconnection.disconnectasync) method.</span></span> <span data-ttu-id="26f3c-186">この呼び出しは、[**CoreDispatcher.RunAsync**](https://docs.microsoft.com/uwp/api/windows.ui.core.coredispatcher.windows) を呼び出して UI スレッドにディスパッチする必要があります。</span><span class="sxs-lookup"><span data-stu-id="26f3c-186">This call must be dispatched to the UI thread by calling [**CoreDispatcher.RunAsync**](https://docs.microsoft.com/uwp/api/windows.ui.core.coredispatcher.windows).</span></span>

[!code-cs[DisconnectButton](./code/MediaCasting_RS1/cs/MainPage.xaml.cs#SnippetDisconnectButton)]

 

 




