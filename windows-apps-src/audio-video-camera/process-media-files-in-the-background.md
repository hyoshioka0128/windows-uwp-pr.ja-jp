---
ms.assetid: B5E3A66D-0453-4D95-A3DB-8E650540A300
description: この記事では、MediaProcessingTrigger とバックグラウンド タスクを使って、バックグラウンドでメディア ファイルを処理する方法について説明します。
title: バックグラウンドでのメディア ファイルの処理
ms.date: 02/08/2017
ms.topic: article
keywords: windows 10, uwp
ms.localizationpriority: medium
ms.openlocfilehash: 6d3530861175c8d9b70683926393b5adfdd59407
ms.sourcegitcommit: ac7f3422f8d83618f9b6b5615a37f8e5c115b3c4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/29/2019
ms.locfileid: "66361558"
---
# <a name="process-media-files-in-the-background"></a><span data-ttu-id="39979-104">バックグラウンドでのメディア ファイルの処理</span><span class="sxs-lookup"><span data-stu-id="39979-104">Process media files in the background</span></span>



<span data-ttu-id="39979-105">この記事では、[**MediaProcessingTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.MediaProcessingTrigger) とバックグラウンド タスクを使って、バックグラウンドでメディア ファイルを処理する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="39979-105">This article shows you how to use the [**MediaProcessingTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.MediaProcessingTrigger) and a background task to process media files in the background.</span></span>

<span data-ttu-id="39979-106">この記事で説明するサンプル アプリを使うと、ユーザーは入力メディア ファイルを選んでコード変換し、コード変換結果の出力ファイルを指定できます。</span><span class="sxs-lookup"><span data-stu-id="39979-106">The example app described in this article allows the user to select an input media file to transcode and specify an output file for the transcoding result.</span></span> <span data-ttu-id="39979-107">次に、バックグラウンド タスクが起動してコード変換操作が実行されます。</span><span class="sxs-lookup"><span data-stu-id="39979-107">Then, a background task is launched to perform the transcoding operation.</span></span> <span data-ttu-id="39979-108">[  **MediaProcessingTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.MediaProcessingTrigger) は、コード変換だけでなくさまざまなメディア処理シナリオ (ディスクへのメディア コンポジションのレンダリング、処理の完了後の処理済みメディア ファイルのアップロードなど) をサポートすることを目的としています。</span><span class="sxs-lookup"><span data-stu-id="39979-108">The [**MediaProcessingTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.MediaProcessingTrigger) is intended to support many different media processing scenarios besides transcoding, including rendering media compositions to disk and uploading processed media files after processing is complete.</span></span>

<span data-ttu-id="39979-109">このサンプルで利用されているさまざまなユニバーサル Windows アプリ機能について詳しくは、次をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="39979-109">For more detailed information on the different Universal Windows app features utilized in this sample, see:</span></span>

-   [<span data-ttu-id="39979-110">メディア ファイルのコード変換</span><span class="sxs-lookup"><span data-stu-id="39979-110">Transcode media files</span></span>](transcode-media-files.md)
-   [<span data-ttu-id="39979-111">再開して、バック グラウンド タスクを起動します。</span><span class="sxs-lookup"><span data-stu-id="39979-111">Launching resuming and background tasks</span></span>](https://docs.microsoft.com/windows/uwp/launch-resume/index)
-   [<span data-ttu-id="39979-112">タイル バッジと通知</span><span class="sxs-lookup"><span data-stu-id="39979-112">Tiles badges and notifications</span></span>](https://docs.microsoft.com/windows/uwp/controls-and-patterns/tiles-badges-notifications)

## <a name="create-a-media-processing-background-task"></a><span data-ttu-id="39979-113">メディア処理のバックグラウンド タスクの作成</span><span class="sxs-lookup"><span data-stu-id="39979-113">Create a media processing background task</span></span>

<span data-ttu-id="39979-114">Microsoft Visual Studio で既存のソリューションにバックグラウンド タスクを追加するには、コンポーネントの名前を入力します。</span><span class="sxs-lookup"><span data-stu-id="39979-114">To add a background task to your existing solution in Microsoft Visual Studio, Enter a name for your comp</span></span>

1.  <span data-ttu-id="39979-115">**[ファイル]** メニューの **[追加]** をクリックし、 **[新しいプロジェクト]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="39979-115">From the **File** menu, select **Add** and then **New Project...**.</span></span>
2.  <span data-ttu-id="39979-116">プロジェクトの種類として **[Windows ランタイム コンポーネント (ユニバーサル アプリ)]** を選びます。</span><span class="sxs-lookup"><span data-stu-id="39979-116">Select the project type **Windows Runtime Component (Universal Windows)**.</span></span>
3.  <span data-ttu-id="39979-117">新しいコンポーネント プロジェクトの名前を入力します。</span><span class="sxs-lookup"><span data-stu-id="39979-117">Enter a name for your new component project.</span></span> <span data-ttu-id="39979-118">この例では、プロジェクト名として **MediaProcessingBackgroundTask** を使います。</span><span class="sxs-lookup"><span data-stu-id="39979-118">This example uses the project name **MediaProcessingBackgroundTask**.</span></span>
4.  <span data-ttu-id="39979-119">[OK] をクリックします。</span><span class="sxs-lookup"><span data-stu-id="39979-119">Click OK.</span></span>

<span data-ttu-id="39979-120">**ソリューション エクスプ ローラー**で、既定で作成された "Class1.cs" ファイルのアイコンを右クリックし、 **[名前の変更]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="39979-120">In **Solution Explorer**, right-click the icon for the "Class1.cs" file that is created by default and select **Rename**.</span></span> <span data-ttu-id="39979-121">ファイル名を "MediaProcessingTask.cs" に変更します。</span><span class="sxs-lookup"><span data-stu-id="39979-121">Rename the file to "MediaProcessingTask.cs".</span></span> <span data-ttu-id="39979-122">Visual Studio に、このクラスへのすべての参照の名前を変更するかどうかを確認するメッセージが表示されたら、 **[はい]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="39979-122">When Visual Studio asks if you want to rename all of the references to this class, click **Yes**.</span></span>

<span data-ttu-id="39979-123">名前が変更されたクラス ファイルで、次の **using** ディレクティブを追加してこれらの名前空間をプロジェクトに含めます。</span><span class="sxs-lookup"><span data-stu-id="39979-123">In the renamed class file, add the following **using** directives to include these namespaces in your project.</span></span>
                                  
[!code-cs[BackgroundUsing](./code/MediaProcessingTriggerWin10/cs/MediaProcessingBackgroundTask/MediaProcessingTask.cs#SnippetBackgroundUsing)]

<span data-ttu-id="39979-124">クラスの宣言を更新して、クラスを [**IBackgroundTask**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.IBackgroundTask) から継承します。</span><span class="sxs-lookup"><span data-stu-id="39979-124">Update your class declaration to make your class inherit from [**IBackgroundTask**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.IBackgroundTask).</span></span>

[!code-cs[BackgroundClass](./code/MediaProcessingTriggerWin10/cs/MediaProcessingBackgroundTask/MediaProcessingTask.cs#SnippetBackgroundClass)]

<span data-ttu-id="39979-125">次のメンバー変数をクラスに追加します。</span><span class="sxs-lookup"><span data-stu-id="39979-125">Add the following member variables to your class:</span></span>

-   <span data-ttu-id="39979-126">[  **IBackgroundTaskInstance**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.IBackgroundTaskInstance)。バックグラウンド タスクの進行状況によってフォアグラウンド アプリを更新するために使われます。</span><span class="sxs-lookup"><span data-stu-id="39979-126">An [**IBackgroundTaskInstance**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.IBackgroundTaskInstance) that will be used to update the foreground app with the progress of the background task.</span></span>
-   <span data-ttu-id="39979-127">[  **BackgroundTaskDeferral**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.BackgroundTaskDeferral)。メディアのコード変換が非同期的に実行されている間も、システムがバックグラウンド タスクをシャットダウンしないようにします。</span><span class="sxs-lookup"><span data-stu-id="39979-127">A [**BackgroundTaskDeferral**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.BackgroundTaskDeferral) that keeps the system from shutting down your background task while media transcoding is being performed asynchronously.</span></span>
-   <span data-ttu-id="39979-128">**CancellationTokenSource** オブジェクト。非同期コード変換操作を取り消すために使うことができます。</span><span class="sxs-lookup"><span data-stu-id="39979-128">A **CancellationTokenSource** object that can be used to cancel the asynchronous transcoding operation.</span></span>
-   <span data-ttu-id="39979-129">[  **MediaTranscoder**](https://docs.microsoft.com/uwp/api/Windows.Media.Transcoding.MediaTranscoder) オブジェクト。メディア ファイルのコード変換に使われます。</span><span class="sxs-lookup"><span data-stu-id="39979-129">The [**MediaTranscoder**](https://docs.microsoft.com/uwp/api/Windows.Media.Transcoding.MediaTranscoder) object that will be used to transcode media files.</span></span>

[!code-cs[BackgroundMembers](./code/MediaProcessingTriggerWin10/cs/MediaProcessingBackgroundTask/MediaProcessingTask.cs#SnippetBackgroundMembers)]

<span data-ttu-id="39979-130">タスクが起動すると、システムはバックグラウンド タスクの [**Run**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtask.) メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="39979-130">The system calls [**Run**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtask.) method of a background task when the task is launched.</span></span> <span data-ttu-id="39979-131">メソッドに渡される [**IBackgroundTask**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.IBackgroundTask) オブジェクトを、対応するメンバー変数に設定します。</span><span class="sxs-lookup"><span data-stu-id="39979-131">Set the [**IBackgroundTask**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.IBackgroundTask) object passed into the method to the corresponding member variable.</span></span> <span data-ttu-id="39979-132">システムがバックグラウンド タスクをシャットダウンする必要がある場合に発生する [**Canceled**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtaskinstance.canceled) イベントのハンドラーを登録します。</span><span class="sxs-lookup"><span data-stu-id="39979-132">Register a handler for the [**Canceled**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtaskinstance.canceled) event, which will be raised if the system needs to shut down the background task.</span></span> <span data-ttu-id="39979-133">次に、[**Progress**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtaskinstance.progress) プロパティを 0 に設定します。</span><span class="sxs-lookup"><span data-stu-id="39979-133">Then, set the [**Progress**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtaskinstance.progress) property to zero.</span></span>

<span data-ttu-id="39979-134">次に、バックグラウンド タスク オブジェクトの [**GetDeferral**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtaskinstance.getdeferral) メソッドを呼び出して保留を取得します。</span><span class="sxs-lookup"><span data-stu-id="39979-134">Next, call the background task object's [**GetDeferral**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtaskinstance.getdeferral) method to obtain a deferral.</span></span> <span data-ttu-id="39979-135">非同期操作の実行中のため、タスクをシャットダウンしないようにシステムに指示されます。</span><span class="sxs-lookup"><span data-stu-id="39979-135">This tells the system not to shut down your task because you are performing asynchronous operations.</span></span>

<span data-ttu-id="39979-136">次に、次のセクションで定義するヘルパー メソッド **TranscodeFileAsync** を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="39979-136">Next, call the helper method **TranscodeFileAsync**, which is defined in the next section.</span></span> <span data-ttu-id="39979-137">正常に完了した場合、ヘルパー メソッドが呼び出され、コード変換が完了したことをユーザーに通知するトースト通知が起動されます。</span><span class="sxs-lookup"><span data-stu-id="39979-137">If that completes successfully, a helper method is called to launch a toast notification to alert the user that transcoding is complete.</span></span>

<span data-ttu-id="39979-138">**Run** メソッドの最後に、保留オブジェクトで [**Complete**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskdeferral.complete) を呼び出して、バックグラウンド タスクが完了したため終了できることをシステムが認識できるようにします。</span><span class="sxs-lookup"><span data-stu-id="39979-138">At the end of the **Run** method, call [**Complete**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskdeferral.complete) on the deferral object to let the system know that your background task is complete and can be terminated.</span></span>

[!code-cs[Run](./code/MediaProcessingTriggerWin10/cs/MediaProcessingBackgroundTask/MediaProcessingTask.cs#SnippetRun)]

<span data-ttu-id="39979-139">**TranscodeFileAsync** ヘルパー メソッドで、コード変換操作の入力ファイルと出力ファイルのファイル名がアプリの [**LocalSettings**](https://docs.microsoft.com/uwp/api/windows.storage.applicationdata.localsettings) から取得されます。</span><span class="sxs-lookup"><span data-stu-id="39979-139">In the **TranscodeFileAsync** helper method, the file names for the input and output files for the transcoding operations are retrieved from the [**LocalSettings**](https://docs.microsoft.com/uwp/api/windows.storage.applicationdata.localsettings) for your app.</span></span> <span data-ttu-id="39979-140">これらの値は、フォアグラウンド アプリによって設定されます。</span><span class="sxs-lookup"><span data-stu-id="39979-140">These values will be set by your foreground app.</span></span> <span data-ttu-id="39979-141">入力ファイルと出力ファイルの [**StorageFile**](https://docs.microsoft.com/uwp/api/Windows.Storage.StorageFile) オブジェクトを作成し、コード変換に使うエンコード プロファイルを作成します。</span><span class="sxs-lookup"><span data-stu-id="39979-141">Create a [**StorageFile**](https://docs.microsoft.com/uwp/api/Windows.Storage.StorageFile) object for the input and output files and then create an encoding profile to use for transcoding.</span></span>

<span data-ttu-id="39979-142">入力ファイル、出力ファイル、エンコード プロファイルを渡して [**PrepareFileTranscodeAsync**](https://docs.microsoft.com/uwp/api/windows.media.transcoding.mediatranscoder.preparefiletranscodeasync) を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="39979-142">Call [**PrepareFileTranscodeAsync**](https://docs.microsoft.com/uwp/api/windows.media.transcoding.mediatranscoder.preparefiletranscodeasync), passing in the input file, output file, and encoding profile.</span></span> <span data-ttu-id="39979-143">この呼び出しから返される [**PrepareTranscodeResult**](https://docs.microsoft.com/uwp/api/Windows.Media.Transcoding.PrepareTranscodeResult) オブジェクトにより、コード変換を実行できるかどうかを把握できます。</span><span class="sxs-lookup"><span data-stu-id="39979-143">The [**PrepareTranscodeResult**](https://docs.microsoft.com/uwp/api/Windows.Media.Transcoding.PrepareTranscodeResult) object returned from this call lets you know if transcoding can be performed.</span></span> <span data-ttu-id="39979-144">[  **CanTranscode**](https://docs.microsoft.com/uwp/api/windows.media.transcoding.preparetranscoderesult.cantranscode) プロパティが true の場合、[**TranscodeAsync**](https://docs.microsoft.com/uwp/api/windows.media.transcoding.preparetranscoderesult.transcodeasync) を呼び出してコード変換操作を実行します。</span><span class="sxs-lookup"><span data-stu-id="39979-144">If the [**CanTranscode**](https://docs.microsoft.com/uwp/api/windows.media.transcoding.preparetranscoderesult.cantranscode) property is true, call [**TranscodeAsync**](https://docs.microsoft.com/uwp/api/windows.media.transcoding.preparetranscoderesult.transcodeasync) to perform the transcoding operation.</span></span>

<span data-ttu-id="39979-145">**AsTask** メソッドを使うと、非同期操作の進行状況を追跡したり、取り消したりできます。</span><span class="sxs-lookup"><span data-stu-id="39979-145">The **AsTask** method enables you to track the progress the asynchronous operation or cancel it.</span></span> <span data-ttu-id="39979-146">必要な進行状況の単位と、タスクの現在の進行状況について通知するために呼び出されるメソッドの名前を指定して、新しい **Progress** オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="39979-146">Create a new **Progress** object, specifying the units of progress you desire and the name of the method that will be called to notify you of the current progress of the task.</span></span> <span data-ttu-id="39979-147">タスクの取り消しを可能にするキャンセル トークンと共に、**Progress** オブジェクトを **AsTask** メソッドに渡します。</span><span class="sxs-lookup"><span data-stu-id="39979-147">Pass the **Progress** object into the **AsTask** method along with the cancellation token that allows you to cancel the task.</span></span>

[!code-cs[TranscodeFileAsync](./code/MediaProcessingTriggerWin10/cs/MediaProcessingBackgroundTask/MediaProcessingTask.cs#SnippetTranscodeFileAsync)]

<span data-ttu-id="39979-148">前の手順で Progress オブジェクトを作成するために使ったメソッド **Progress** で、バックグラウンド タスク インスタンスの進行状況を設定します。</span><span class="sxs-lookup"><span data-stu-id="39979-148">In the method you used to create the Progress object in the previous step, **Progress**, set the progress of the background task instance.</span></span> <span data-ttu-id="39979-149">これにより、進行状況がフォアグラウンド アプリ (実行されている場合) に渡されます。</span><span class="sxs-lookup"><span data-stu-id="39979-149">This will pass the progress to the foreground app, if it is running.</span></span>

[!code-cs[Progress](./code/MediaProcessingTriggerWin10/cs/MediaProcessingBackgroundTask/MediaProcessingTask.cs#SnippetProgress)]

<span data-ttu-id="39979-150">**SendToastNotification** ヘルパー メソッドは、テキスト コンテンツしかないトーストのテンプレート XML ドキュメントを取得することによって新しいトースト通知を作成します。</span><span class="sxs-lookup"><span data-stu-id="39979-150">The **SendToastNotification** helper method creates a new toast notification by getting a template XML document for a toast that only has text content.</span></span> <span data-ttu-id="39979-151">トースト XML のテキスト要素が設定された後、XML ドキュメントから新しい [**ToastNotification**](https://docs.microsoft.com/uwp/api/Windows.UI.Notifications.ToastNotification) オブジェクトが作成されます。</span><span class="sxs-lookup"><span data-stu-id="39979-151">The text element of the toast XML is set and then a new [**ToastNotification**](https://docs.microsoft.com/uwp/api/Windows.UI.Notifications.ToastNotification) object is created from the XML document.</span></span> <span data-ttu-id="39979-152">最後に、[**ToastNotifier.Show**](https://docs.microsoft.com/uwp/api/windows.ui.notifications.toastnotifier.show) を呼び出すことによってトーストがユーザーに表示されます。</span><span class="sxs-lookup"><span data-stu-id="39979-152">Finally, the toast is shown to the user by calling [**ToastNotifier.Show**](https://docs.microsoft.com/uwp/api/windows.ui.notifications.toastnotifier.show).</span></span>

[!code-cs[SendToastNotification](./code/MediaProcessingTriggerWin10/cs/MediaProcessingBackgroundTask/MediaProcessingTask.cs#SnippetSendToastNotification)]

<span data-ttu-id="39979-153">システムがバック グラウンド タスクをキャンセルしたときに呼び出される [**Canceled**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtaskinstance.canceled) イベントのハンドラーでは、利用統計情報を取集するためにログにエラーを記録することができます。</span><span class="sxs-lookup"><span data-stu-id="39979-153">In the handler for the [**Canceled**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtaskinstance.canceled) event, which is called when the system cancels your background task, you can log the error for telemetry purposes.</span></span>

[!code-cs[OnCanceled](./code/MediaProcessingTriggerWin10/cs/MediaProcessingBackgroundTask/MediaProcessingTask.cs#SnippetOnCanceled)]

## <a name="register-and-launch-the-background-task"></a><span data-ttu-id="39979-154">バックグラウンド タスクの登録と起動</span><span class="sxs-lookup"><span data-stu-id="39979-154">Register and launch the background task</span></span>

<span data-ttu-id="39979-155">フォアグラウンド アプリからバックグラウンド タスクを起動するには、フォアグラウンド アプリの Package.appmanifest ファイルを更新して、アプリがバックグラウンド タスクを使っていることをシステムが認識できるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="39979-155">Before you can launch the background task from your foreground app, you must update your foreground app's Package.appmanifest file to let the system know that your app uses a background task.</span></span>

1.  <span data-ttu-id="39979-156">**ソリューション エクスプローラー**で、Package.appmanifest アイコンをダブルクリックしてマニフェスト エディターを開きます。</span><span class="sxs-lookup"><span data-stu-id="39979-156">In **Solution Explorer**, double-click the Package.appmanifest file icon to open the manifest editor.</span></span>
2.  <span data-ttu-id="39979-157">**[宣言]** タブをクリックします。</span><span class="sxs-lookup"><span data-stu-id="39979-157">Select the **Declarations** tab.</span></span>
3.  <span data-ttu-id="39979-158">**[使用可能な宣言]** で、 **[バックグラウンド タスク]** を選び、 **[追加]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="39979-158">From **Available Declarations**, select **Background Tasks** and click **Add**.</span></span>
4.  <span data-ttu-id="39979-159">**[サポートされる宣言]** で、 **[バックグラウンド タスク]** 項目が選択されていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="39979-159">Under **Supported Declarations** make sure that the **Background Tasks** item is selected.</span></span> <span data-ttu-id="39979-160">**[プロパティ]** で、 **[Media processing]** (メディア処理) チェック ボックスをオンにします。</span><span class="sxs-lookup"><span data-stu-id="39979-160">Under **Properties**, select the checkbox for **Media processing**.</span></span>
5.  <span data-ttu-id="39979-161">**[エントリ ポイント]** ボックスで、バックグラウンド テストの名前空間とクラス名を、ピリオドで区切って指定します。</span><span class="sxs-lookup"><span data-stu-id="39979-161">In the **Entry Point** text box, specify the namespace and class name for your background test, separated by a period.</span></span> <span data-ttu-id="39979-162">この例では、エントリは次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="39979-162">For this example, the entry is:</span></span>
   ```csharp
   MediaProcessingBackgroundTask.MediaProcessingTask
   ```
<span data-ttu-id="39979-163">次に、フォアグラウンド アプリにバックグラウンド タスクへの参照を追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="39979-163">Next, you need to add a reference to your background task to your foreground app.</span></span>
1.  <span data-ttu-id="39979-164">**ソリューション エクスプローラー**のフォアグラウンド アプリ プロジェクトで、 **[参照]** フォルダーを右クリックし、 **[参照の追加]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="39979-164">In **Solution Explorer**, under your foreground app project, right-click the **References** folder and select **Add Reference...**.</span></span>
2.  <span data-ttu-id="39979-165">**[プロジェクト]** ノードを展開し、 **[ソリューション]** を選択します。</span><span class="sxs-lookup"><span data-stu-id="39979-165">Expand the **Projects** node and select **Solution**.</span></span>
3.  <span data-ttu-id="39979-166">バックグラウンド プロジェクトの横のボックスをオンにし、 **[OK]** をクリックします。</span><span class="sxs-lookup"><span data-stu-id="39979-166">Check the box next to your background task project and click **OK**.</span></span>

<span data-ttu-id="39979-167">この例のコードの残りの部分をフォアグラウンド アプリに追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="39979-167">The rest of the code in this example should be added to your foreground app.</span></span> <span data-ttu-id="39979-168">まず、次の名前空間をプロジェクトに追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="39979-168">First, you will need to add the following namespaces to your project.</span></span>

[!code-cs[ForegroundUsing](./code/MediaProcessingTriggerWin10/cs/MediaProcessingTriggerWin10/MainPage.xaml.cs#SnippetForegroundUsing)]

<span data-ttu-id="39979-169">次に、バックグラウンド タスクの登録に必要な次のメンバー変数を追加します。</span><span class="sxs-lookup"><span data-stu-id="39979-169">Next, add the following member variables that are needed to register the background task.</span></span>

[!code-cs[ForegroundMembers](./code/MediaProcessingTriggerWin10/cs/MediaProcessingTriggerWin10/MainPage.xaml.cs#SnippetForegroundMembers)]

<span data-ttu-id="39979-170">**PickFilesToTranscode** ヘルパー メソッドは、[**FileOpenPicker**](https://docs.microsoft.com/uwp/api/Windows.Storage.Pickers.FileOpenPicker) と [**FileSavePicker**](https://docs.microsoft.com/uwp/api/Windows.Storage.Pickers.FileSavePicker) を使ってコード変換用の入力ファイルと出力ファイルを開きます。</span><span class="sxs-lookup"><span data-stu-id="39979-170">The **PickFilesToTranscode** helper method uses a [**FileOpenPicker**](https://docs.microsoft.com/uwp/api/Windows.Storage.Pickers.FileOpenPicker) and a [**FileSavePicker**](https://docs.microsoft.com/uwp/api/Windows.Storage.Pickers.FileSavePicker) to open the input and output files for transcoding.</span></span> <span data-ttu-id="39979-171">アプリがアクセスできない場所にあるファイルをユーザーが選ぶ可能性があります。</span><span class="sxs-lookup"><span data-stu-id="39979-171">The user may select files in a location that your app does not have access to.</span></span> <span data-ttu-id="39979-172">バックグラウンド タスクがファイルを開けるようにするには、ファイルをアプリの [**FutureAccessList**](https://docs.microsoft.com/uwp/api/windows.storage.accesscache.storageapplicationpermissions.futureaccesslist) に追加します。</span><span class="sxs-lookup"><span data-stu-id="39979-172">To make sure your background task can open the files, add them to the [**FutureAccessList**](https://docs.microsoft.com/uwp/api/windows.storage.accesscache.storageapplicationpermissions.futureaccesslist) for your app.</span></span>

<span data-ttu-id="39979-173">最後に、アプリの [**LocalSettings**](https://docs.microsoft.com/uwp/api/windows.storage.applicationdata.localsettings) で入力ファイルと出力ファイルの名前のエントリを設定します。</span><span class="sxs-lookup"><span data-stu-id="39979-173">Finally, set entries for the input and output file names in the [**LocalSettings**](https://docs.microsoft.com/uwp/api/windows.storage.applicationdata.localsettings) for your app.</span></span> <span data-ttu-id="39979-174">バックグラウンド タスクは、この場所からファイル名を取得します。</span><span class="sxs-lookup"><span data-stu-id="39979-174">The background task retrieves the file names from this location.</span></span>

[!code-cs[PickFilesToTranscode](./code/MediaProcessingTriggerWin10/cs/MediaProcessingTriggerWin10/MainPage.xaml.cs#SnippetPickFilesToTranscode)]

<span data-ttu-id="39979-175">バックグラウンド タスクを登録するには、新しい [**MediaProcessingTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.MediaProcessingTrigger) と新しい [**BackgroundTaskBuilder**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.BackgroundTaskBuilder) を作成します。</span><span class="sxs-lookup"><span data-stu-id="39979-175">To register the background task, create a new [**MediaProcessingTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.MediaProcessingTrigger) and a new [**BackgroundTaskBuilder**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.BackgroundTaskBuilder).</span></span> <span data-ttu-id="39979-176">後で識別できるようにバックグラウンド タスク ビルダーの名前を設定します。</span><span class="sxs-lookup"><span data-stu-id="39979-176">Set the name of the background task builder so that you can identify it later.</span></span> <span data-ttu-id="39979-177">[  **TaskEntryPoint**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskbuilder.taskentrypoint) を、マニフェスト ファイルで使ったのと同じ名前空間とクラス名文字列に設定します。</span><span class="sxs-lookup"><span data-stu-id="39979-177">Set the [**TaskEntryPoint**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskbuilder.taskentrypoint) to the same namespace and class name string you used in the manifest file.</span></span> <span data-ttu-id="39979-178">[  **Trigger**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskregistration.trigger) プロパティを **MediaProcessingTrigger** インスタンスに設定します。</span><span class="sxs-lookup"><span data-stu-id="39979-178">Set the [**Trigger**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskregistration.trigger) property to the **MediaProcessingTrigger** instance.</span></span>

<span data-ttu-id="39979-179">タスクを登録する前に、[**AllTasks**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskregistration.alltasks) コレクションをループ処理し、[**BackgroundTaskBuilder.Name**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskbuilder.name) プロパティで指定した名前を持つすべてのタスクで [**Unregister**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtaskregistration.unregister) を呼び出すことにより、以前に登録したタスクを必ず登録解除してください。</span><span class="sxs-lookup"><span data-stu-id="39979-179">Before registering the task, make sure you unregister any previously registered tasks by looping through the [**AllTasks**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskregistration.alltasks) collection and calling [**Unregister**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtaskregistration.unregister) on any tasks that have the name you specified in the [**BackgroundTaskBuilder.Name**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskbuilder.name) property.</span></span>

<span data-ttu-id="39979-180">[  **Register**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskbuilder.register) を呼び出してバックグラウンド タスクを登録します。</span><span class="sxs-lookup"><span data-stu-id="39979-180">Register the background task by calling [**Register**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskbuilder.register).</span></span> <span data-ttu-id="39979-181">[  **Completed**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskregistration.completed) イベントと [**Progress**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtaskregistration.progress) イベントのハンドラーを登録します。</span><span class="sxs-lookup"><span data-stu-id="39979-181">Register handlers for the [**Completed**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskregistration.completed) and [**Progress**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.ibackgroundtaskregistration.progress) events.</span></span>

[!code-cs[RegisterBackgroundTask](./code/MediaProcessingTriggerWin10/cs/MediaProcessingTriggerWin10/MainPage.xaml.cs#SnippetRegisterBackgroundTask)]

<span data-ttu-id="39979-182">アプリがなどで、最初に起動したときに一般的なアプリが、バック グラウンド タスクを登録、 **OnNavigatedTo**イベント。</span><span class="sxs-lookup"><span data-stu-id="39979-182">A typical app will register their background task when the app is initially launched, such as in the **OnNavigatedTo** event.</span></span>

<span data-ttu-id="39979-183">**MediaProcessingTrigger** オブジェクトの [**RequestAsync**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.mediaprocessingtrigger.requestasync) メソッドを呼び出してバックグラウンド タスクを起動します。</span><span class="sxs-lookup"><span data-stu-id="39979-183">Launch the background task by calling the **MediaProcessingTrigger** object's [**RequestAsync**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.mediaprocessingtrigger.requestasync) method.</span></span> <span data-ttu-id="39979-184">このメソッドによって返される [**MediaProcessingTriggerResult**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.MediaProcessingTriggerResult) オブジェクトにより、バックグラウンド タスクが正常に起動されたかどうかを把握することができます。正常に起動されなかった場合は、バックグラウンド タスクが起動しなかった理由を把握できます。</span><span class="sxs-lookup"><span data-stu-id="39979-184">The [**MediaProcessingTriggerResult**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.MediaProcessingTriggerResult) object returned by this method lets you know whether the background task was started successfully, and if not, lets you know why the background task wasn't launched.</span></span> 

[!code-cs[LaunchBackgroundTask](./code/MediaProcessingTriggerWin10/cs/MediaProcessingTriggerWin10/MainPage.xaml.cs#SnippetLaunchBackgroundTask)]

<span data-ttu-id="39979-185">一般的なアプリは起動し、ユーザーの操作への応答でバック グラウンド タスクなど、**クリックして**UI コントロールのイベント。</span><span class="sxs-lookup"><span data-stu-id="39979-185">A typical app will launch the background task in response to user interaction, such as in the **Click** event of a UI control.</span></span>

<span data-ttu-id="39979-186">バックグラウンド タスクが操作の進行状況を更新すると、**OnProgress** イベント ハンドラーが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="39979-186">The **OnProgress** event handler is called when the background task updates the progress of the operation.</span></span> <span data-ttu-id="39979-187">この機会を使って、進行状況情報によって UI を更新することができます。</span><span class="sxs-lookup"><span data-stu-id="39979-187">You can use this opportunity to update your UI with progress information.</span></span>

[!code-cs[OnProgress](./code/MediaProcessingTriggerWin10/cs/MediaProcessingTriggerWin10/MainPage.xaml.cs#SnippetOnProgress)]

<span data-ttu-id="39979-188">バックグラウンド タスクの実行が完了すると、**OnCompleted** イベント ハンドラーが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="39979-188">The **OnCompleted** event handler is called when the background task has finished running.</span></span> <span data-ttu-id="39979-189">ここでも、UI を更新してユーザーに状態情報を示すことができます。</span><span class="sxs-lookup"><span data-stu-id="39979-189">This is another opportunity to update your UI to give status information to the user.</span></span>

[!code-cs[OnCompleted](./code/MediaProcessingTriggerWin10/cs/MediaProcessingTriggerWin10/MainPage.xaml.cs#SnippetOnCompleted)]


 

 




