---
author: drewbatgit
ms.assetid: a128edc8-8a80-4645-ac29-908ede2d1c72
description: "この記事では、MediaCapture と共に MediaFrameReader を使って、色、深度、赤外線カメラ、オーディオ デバイスなどの 1 つ以上の利用可能なソースや、スケルタル トラッキング フレームを生成するようなカスタム フレーム ソースから、メディア フレームを取得する方法を示します。"
title: "MediaFrameReader を使ったメディア フレームの処理"
ms.author: drewbat
ms.date: 02/08/2017
ms.topic: article
ms.prod: windows
ms.technology: uwp
keywords: Windows 10, UWP
ms.openlocfilehash: bc0cfc468613429d7989c9c0d93bd98246c0195b
ms.sourcegitcommit: 7540962003b38811e6336451bb03d46538b35671
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/26/2017
---
# <a name="process-media-frames-with-mediaframereader"></a><span data-ttu-id="867d5-104">MediaFrameReader を使ったメディア フレームの処理</span><span class="sxs-lookup"><span data-stu-id="867d5-104">Process media frames with MediaFrameReader</span></span>

<span data-ttu-id="867d5-105">この記事では、[**MediaCapture**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCapture) と共に [**MediaFrameReader**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader) を使って、色、深度、赤外線カメラ、オーディオ デバイスなどの 1 つ以上の利用可能なソースや、スケルタル トラッキング フレームを生成するようなカスタム フレーム ソースから、メディア フレームを取得する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="867d5-105">This article shows you how to use a [**MediaFrameReader**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader) with [**MediaCapture**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCapture) to get media frames from one or more available sources, including color, depth, and infrared cameras, audio devices, or even custom frame sources such as those that produce skeletal tracking frames.</span></span> <span data-ttu-id="867d5-106">この機能は、拡張現実アプリや奥行きを検出するカメラ アプリなど、メディア フレームのリアルタイム処理を実行するアプリで使用するために設計されました。</span><span class="sxs-lookup"><span data-stu-id="867d5-106">This feature is designed to be used by apps that perform real-time processing of media frames, such as augmented reality and depth-aware camera apps.</span></span>

<span data-ttu-id="867d5-107">一般的な写真アプリなど、ビデオや写真を単にキャプチャすることに興味がある場合は、[ **MediaCapture**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCapture) でサポートされているその他のキャプチャ手法のいずれかを使う方がよいでしょう。</span><span class="sxs-lookup"><span data-stu-id="867d5-107">If you are interested in simply capturing video or photos, such as a typical photography app, then you probably want to use one of the other capture techniques supported by [**MediaCapture**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCapture).</span></span> <span data-ttu-id="867d5-108">利用可能なメディア キャプチャ手法のリストとそれらの使用方法を示す記事については、「[**カメラ**](camera.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="867d5-108">For a list of available media capture techniques and articles showing how to use them, see [**Camera**](camera.md).</span></span>

> [!NOTE] 
> <span data-ttu-id="867d5-109">この記事で説明している機能は、Windows 10 バージョン 1607 以降でのみ利用できます。</span><span class="sxs-lookup"><span data-stu-id="867d5-109">The features discussed in this article are only available starting with Windows 10, version 1607.</span></span>

> [!NOTE] 
> <span data-ttu-id="867d5-110">**MediaFrameReader** を使って色、深度、赤外線カメラなど、さまざまなフレーム ソースからのフレームを表示する方法を示す、ユニバーサル Windows アプリのサンプルがあります。</span><span class="sxs-lookup"><span data-stu-id="867d5-110">There is an Universal Windows app sample that demonstrates using **MediaFrameReader** to display frames from different frame sources, including color, depth, and infrared camreas.</span></span> <span data-ttu-id="867d5-111">詳しくは、「[カメラ フレームのサンプル](http://go.microsoft.com/fwlink/?LinkId=823230)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="867d5-111">For more information, see [Camera frames sample](http://go.microsoft.com/fwlink/?LinkId=823230).</span></span>

## <a name="setting-up-your-project"></a><span data-ttu-id="867d5-112">プロジェクトの設定</span><span class="sxs-lookup"><span data-stu-id="867d5-112">Setting up your project</span></span>
<span data-ttu-id="867d5-113">**MediaCapture** を使う他のアプリと同様に、カメラ デバイスにアクセスする前にアプリが *webcam* 機能を使うことを宣言する必要があります。</span><span class="sxs-lookup"><span data-stu-id="867d5-113">As with any app that uses **MediaCapture**, you must declare that your app uses the *webcam* capability before attempting to access any camera device.</span></span> <span data-ttu-id="867d5-114">アプリがオーディオ デバイスからキャプチャする場合は、*microphone* デバイス機能も宣言する必要があります。</span><span class="sxs-lookup"><span data-stu-id="867d5-114">If your app will capture from an audio device, you should also declare the *microphone* device capability.</span></span> 

**<span data-ttu-id="867d5-115">アプリ マニフェストに機能を追加する</span><span class="sxs-lookup"><span data-stu-id="867d5-115">Add capabilities to the app manifest</span></span>**

1.  <span data-ttu-id="867d5-116">Microsoft Visual Studio では、**ソリューション エクスプローラー**で **package.appxmanifest** 項目をダブルクリックして、アプリケーション マニフェストのデザイナーを開きます。</span><span class="sxs-lookup"><span data-stu-id="867d5-116">In Microsoft Visual Studio, in **Solution Explorer**, open the designer for the application manifest by double-clicking the **package.appxmanifest** item.</span></span>
2.  <span data-ttu-id="867d5-117">**[機能]** タブをクリックします。</span><span class="sxs-lookup"><span data-stu-id="867d5-117">Select the **Capabilities** tab.</span></span>
3.  <span data-ttu-id="867d5-118">**[Web カメラ]** のボックスと **[マイク]** のボックスをオンにします。</span><span class="sxs-lookup"><span data-stu-id="867d5-118">Check the box for **Webcam** and the box for **Microphone**.</span></span>
4.  <span data-ttu-id="867d5-119">画像ライブラリとビデオ ライブラリにアクセスするには、**画像ライブラリ**のボックスと**ビデオ ライブラリ**のボックスをオンにします。</span><span class="sxs-lookup"><span data-stu-id="867d5-119">For access to the Pictures and Videos library check the boxes for **Pictures Library** and the box for **Videos Library**.</span></span>

<span data-ttu-id="867d5-120">この記事のサンプル コードでは、既定のプロジェクト テンプレートに含まれている API に加えて、次の名前空間の API が使っています。</span><span class="sxs-lookup"><span data-stu-id="867d5-120">The example code in this article uses APIs from the following namespaces, in addition to those included by the default project template.</span></span>

[!code-cs[<span data-ttu-id="867d5-121">FramesUsing</span><span class="sxs-lookup"><span data-stu-id="867d5-121">FramesUsing</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetFramesUsing)]

## <a name="select-frame-sources-and-frame-source-groups"></a><span data-ttu-id="867d5-122">フレーム ソースとフレーム ソース グループを選択する</span><span class="sxs-lookup"><span data-stu-id="867d5-122">Select frame sources and frame source groups</span></span>
<span data-ttu-id="867d5-123">メディア フレームを処理する多くのアプリは、デバイスの色、深度カメラなど、複数のソースからフレームを一度に取得する必要があります。</span><span class="sxs-lookup"><span data-stu-id="867d5-123">Many apps that process media frames need to get frames from multiple sources at once, such as a device's color and depth cameras.</span></span> <span data-ttu-id="867d5-124">[**MediaFrameSourceGroup**] (https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceGroup) オブジェクトは、同時に使用できるメディア フレーム ソースのセットを表します。</span><span class="sxs-lookup"><span data-stu-id="867d5-124">The [**MediaFrameSourceGroup**] (https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceGroup) object represents a set of media frame sources that can be used simultaneously.</span></span> <span data-ttu-id="867d5-125">静的メソッド [ **MediaFrameSourceGroup.FindAllAsync** ](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceGroup.FindAllAsync) を呼び出して、現在のデバイスでサポートされているフレーム ソースのすべてのグループの一覧を取得します。</span><span class="sxs-lookup"><span data-stu-id="867d5-125">Call the static method [**MediaFrameSourceGroup.FindAllAsync**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceGroup.FindAllAsync) to get a list of all of the groups of frame sources supported by the current device.</span></span>

[!code-cs[<span data-ttu-id="867d5-126">FindAllAsync</span><span class="sxs-lookup"><span data-stu-id="867d5-126">FindAllAsync</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetFindAllAsync)]

<span data-ttu-id="867d5-127">[**DeviceInformation.CreateWatcher**](https://msdn.microsoft.com/library/windows/apps/br225427) と [**MediaFrameSourceGroup.GetDeviceSelector**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceGroup.GetDeviceSelector) から返される値を使って [**DeviceWatcher**](https://msdn.microsoft.com/library/windows/apps/Windows.Devices.Enumeration.DeviceWatcher) を作成して、外付けカメラが接続されたときなど、デバイス上の利用可能なフレーム ソース グループが変更されたときに通知を受け取ることもできます。</span><span class="sxs-lookup"><span data-stu-id="867d5-127">You can also create a [**DeviceWatcher**](https://msdn.microsoft.com/library/windows/apps/Windows.Devices.Enumeration.DeviceWatcher) using [**DeviceInformation.CreateWatcher**](https://msdn.microsoft.com/library/windows/apps/br225427) and the value retuned from [**MediaFrameSourceGroup.GetDeviceSelector**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceGroup.GetDeviceSelector) to receive notifications when the available frame source groups on the device changes, such as when an external camera is plugged in.</span></span> <span data-ttu-id="867d5-128">詳しくは、「[**デバイスの列挙**](https://msdn.microsoft.com/windows/uwp/devices-sensors/enumerate-devices)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="867d5-128">For more information see [**Enumerate devices**](https://msdn.microsoft.com/windows/uwp/devices-sensors/enumerate-devices).</span></span>

<span data-ttu-id="867d5-129">[**MediaFrameSourceGroup**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceGroup) には、グループに含まれるフレーム ソースを記述する [**MediaFrameSourceInfo**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceInfo) オブジェクトのコレクションがあります。</span><span class="sxs-lookup"><span data-stu-id="867d5-129">A [**MediaFrameSourceGroup**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceGroup) has a collection of [**MediaFrameSourceInfo**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceInfo) objects that describe the frame sources included in the group.</span></span> <span data-ttu-id="867d5-130">デバイスで利用可能なフレーム ソース グループを取得した後、目的のフレーム ソースを公開するグループを選択できます。</span><span class="sxs-lookup"><span data-stu-id="867d5-130">After retrieving the frame source groups available on the device, you can select the group that exposes the frame sources you are interested in.</span></span>

<span data-ttu-id="867d5-131">次の例は、フレーム ソース グループを選択する最も簡単な方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="867d5-131">The following example shows the simplest way to select a frame source group.</span></span> <span data-ttu-id="867d5-132">このコードは、すべての利用可能なグループをループで処理してから、[**SourceInfos**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceGroup.SourceInfos) コレクション内の各項目をループで処理します。</span><span class="sxs-lookup"><span data-stu-id="867d5-132">This code simply loops over all of the available groups and then loops over each item in the [**SourceInfos**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceGroup.SourceInfos) collection.</span></span> <span data-ttu-id="867d5-133">各 **MediaFrameSourceInfo** について、目的の機能をサポートしているかどうかがチェックされます。</span><span class="sxs-lookup"><span data-stu-id="867d5-133">Each **MediaFrameSourceInfo** is checked to see if it supports the features we are seeking.</span></span> <span data-ttu-id="867d5-134">この場合は、[**MediaStreamType**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceInfo.MediaStreamType) プロパティでデバイスがビデオ プレビュー ストリームを提供するかどうかを示す値 [**VideoPreview**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaStreamType) がチェックされ、[**SourceKind**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceInfo.SourceKind) プロパティでソースが色のフレームを提供するかどうかを示す値 [**Color**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceKind) がチェックされます。</span><span class="sxs-lookup"><span data-stu-id="867d5-134">In this case, the [**MediaStreamType**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceInfo.MediaStreamType) property is checked for the value [**VideoPreview**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaStreamType), meaning the device provides a video preview stream, and the [**SourceKind**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceInfo.SourceKind) property is checked for the value [**Color**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceKind), indicating that the source provides color frames.</span></span>

[!code-cs[<span data-ttu-id="867d5-135">SimpleSelect</span><span class="sxs-lookup"><span data-stu-id="867d5-135">SimpleSelect</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetSimpleSelect)]

<span data-ttu-id="867d5-136">目的のフレーム ソース グループとフレーム ソースを識別するこの方法は、簡単なケースでは機能しますが、より複雑な条件に基づいてフレーム ソースを選択する場合は難しくなります。</span><span class="sxs-lookup"><span data-stu-id="867d5-136">This method of identifying the desired frame source group and frame sources works for simple cases, but if you want to select frame sources based on more complex criteria, it can quickly become cumbersome.</span></span> <span data-ttu-id="867d5-137">別の方法として、Linq 構文と匿名オブジェクトを使って選択する方法があります。</span><span class="sxs-lookup"><span data-stu-id="867d5-137">Another method is to use Linq syntax and anonymous objects to make the selection.</span></span> <span data-ttu-id="867d5-138">次の例では、**Select** 拡張メソッドを使って、*frameSourceGroups* 一覧内の **MediaFrameSourceGroup** オブジェクトを 2 つのフィールドを持つ匿名オブジェクトに変換します。2 つのフィールドは、グループ自体を表す *sourceGroup* と、グループ内の色のフレーム ソースを表す *colorSourceInfo* です。</span><span class="sxs-lookup"><span data-stu-id="867d5-138">The following example uses the **Select** extension method to transform the **MediaFrameSourceGroup** objects in the *frameSourceGroups* list into an anonymous object with two fields: *sourceGroup*, representing the group itself, and *colorSourceInfo*, which represents the color frame source in the group.</span></span> <span data-ttu-id="867d5-139">*colorSourceInfo* フィールドは、指定された述語が true に解決される最初のオブジェクトを選ぶ **FirstOrDefault** の結果に設定されます。</span><span class="sxs-lookup"><span data-stu-id="867d5-139">The *colorSourceInfo* field is set to the result of **FirstOrDefault**, which selects the first object for which the provided predicate resolves to true.</span></span> <span data-ttu-id="867d5-140">この場合、述語が true になるのは、ストリーム タイプが **VideoPreview**、ソースの種類が **Color** で、カメラがデバイスのフロント パネルにある場合です。</span><span class="sxs-lookup"><span data-stu-id="867d5-140">In this case, the predicate is true if the stream type is **VideoPreview**, the source kind is **Color**, and if the camera is on the front panel of the device.</span></span>

<span data-ttu-id="867d5-141">上記のクエリから返された匿名オブジェクトの一覧から、**Where** 拡張メソッドを使って、*colorSourceInfo* フィールドが null でないオブジェクトのみを選択します。</span><span class="sxs-lookup"><span data-stu-id="867d5-141">From the list of anonymous objects returned from the query described above, the **Where** extension method is used to select only those objects where the *colorSourceInfo* field is not null.</span></span> <span data-ttu-id="867d5-142">最後に、**FirstOrDefault** が呼び出されて一覧内で最初の項目が選択されます。</span><span class="sxs-lookup"><span data-stu-id="867d5-142">Finally, **FirstOrDefault** is called to select the first item in the list.</span></span>

<span data-ttu-id="867d5-143">これで、選択したオブジェクトのフィールドを使って、選択した **MediaFrameSourceGroup** とカラー カメラを表す **MediaFrameSourceInfo** オブジェクトへの参照を取得できます。</span><span class="sxs-lookup"><span data-stu-id="867d5-143">Now you can use the fields of the selected object to get references to the selected **MediaFrameSourceGroup** and the **MediaFrameSourceInfo** object representing the color camera.</span></span> <span data-ttu-id="867d5-144">後でこれらを使って、**MediaCapture** オブジェクトを初期化し、選択したソースの **MediaFrameReader** を作成します。</span><span class="sxs-lookup"><span data-stu-id="867d5-144">These will be used later to initialize the **MediaCapture** object and create a **MediaFrameReader** for the selected source.</span></span> <span data-ttu-id="867d5-145">最後に、ソース グループが null であるかどうかをテストする必要があります。これは、現在のデバイスが要求されたキャプチャ ソースを持っていないことを意味します。</span><span class="sxs-lookup"><span data-stu-id="867d5-145">Finally, you should test to see if the source group is null, meaning the current device doesn't have your requested capture sources.</span></span>

[!code-cs[<span data-ttu-id="867d5-146">SelectColor</span><span class="sxs-lookup"><span data-stu-id="867d5-146">SelectColor</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetSelectColor)]

<span data-ttu-id="867d5-147">次の例では、上記と同様の手法を使って、色、深度、および赤外線カメラを含むソース グループを選択します。</span><span class="sxs-lookup"><span data-stu-id="867d5-147">The following example uses a similar technique as described above to select a source group that contains color, depth, and infrared cameras.</span></span>

[!code-cs[<span data-ttu-id="867d5-148">ColorInfraredDepth</span><span class="sxs-lookup"><span data-stu-id="867d5-148">ColorInfraredDepth</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetColorInfraredDepth)]

## <a name="initialize-the-mediacapture-object-to-use-the-selected-frame-source-group"></a><span data-ttu-id="867d5-149">選択したフレーム ソース グループを使うように MediaCapture オブジェクトを初期化する</span><span class="sxs-lookup"><span data-stu-id="867d5-149">Initialize the MediaCapture object to use the selected frame source group</span></span>
<span data-ttu-id="867d5-150">次に、前の手順で選択したフレーム ソース グループを使うように **MediaCapture** オブジェクトを初期化します。</span><span class="sxs-lookup"><span data-stu-id="867d5-150">The next step is to initialize the **MediaCapture** object to use the frame source group you selected in the previous step.</span></span>

<span data-ttu-id="867d5-151">通常、**MediaCapture** オブジェクトはアプリ内の複数の場所から使用できるため、それを保持するクラス メンバー変数を宣言する必要があります。</span><span class="sxs-lookup"><span data-stu-id="867d5-151">The **MediaCapture** object is typically used from multiple locations within your app, so you should declare a class member variable to hold it.</span></span>

[!code-cs[<span data-ttu-id="867d5-152">DeclareMediaCapture</span><span class="sxs-lookup"><span data-stu-id="867d5-152">DeclareMediaCapture</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetDeclareMediaCapture)]

<span data-ttu-id="867d5-153">コンス トラクターを呼び出して、**MediaCapture** オブジェクトのインスタンスを作成します。</span><span class="sxs-lookup"><span data-stu-id="867d5-153">Create an instance of the **MediaCapture** object by calling the constructor.</span></span> <span data-ttu-id="867d5-154">次に、**MediaCapture** オブジェクトの初期化に使われる [**MediaCaptureSettings**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureSettings) オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="867d5-154">Next, create a [**MediaCaptureSettings**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureSettings) object that will be used to initialize the **MediaCapture** object.</span></span> <span data-ttu-id="867d5-155">この例では、次の設定を使用しています。</span><span class="sxs-lookup"><span data-stu-id="867d5-155">In this example, the following settings are used:</span></span>

* <span data-ttu-id="867d5-156">[**SourceGroup**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureInitializationSettings.SourceGroup) - どのソース グループを使ってフレームを取得するかをシステムに知らせます。</span><span class="sxs-lookup"><span data-stu-id="867d5-156">[**SourceGroup**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureInitializationSettings.SourceGroup) - This tells the system which source group you will be using to get frames.</span></span> <span data-ttu-id="867d5-157">ソース グループは、同時に使用できるメディア フレーム ソースのセットを定義することに注意してください。</span><span class="sxs-lookup"><span data-stu-id="867d5-157">Remember that the source group defines a set of media frame sources that can be used simultaneously.</span></span>
* <span data-ttu-id="867d5-158">[**SharingMode**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureInitializationSettings.SharingMode) - キャプチャ ソース デバイスに関して排他的な制御が必要かどうかをシステムに知らせます。</span><span class="sxs-lookup"><span data-stu-id="867d5-158">[**SharingMode**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureInitializationSettings.SharingMode) - This tells the system whether you need exclusive control over the capture source devices.</span></span> <span data-ttu-id="867d5-159">これを [**ExclusiveControl**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureSharingMode) に設定すると、生成するフレームの形式など、キャプチャ デバイスの設定を変更することができますが、別のアプリが既に排他的制御を持っている場合、自分のアプリはメディア キャプチャ デバイスを初期化しようとすると失敗します。</span><span class="sxs-lookup"><span data-stu-id="867d5-159">If you set this to  [**ExclusiveControl**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureSharingMode), it means that you can change the settings of the capture device, such as the format of the frames it produces, but this means that if another app already has exclusive control, your app will fail when it tries to initialize the media capture device.</span></span> <span data-ttu-id="867d5-160">これを [**SharedReadOnly**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureSharingMode) に設定すると、別のアプリで使われてもフレーム ソースからフレームを受け取ることができますが、デバイスの設定を変更することはできません。</span><span class="sxs-lookup"><span data-stu-id="867d5-160">If you set this to [**SharedReadOnly**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureSharingMode), you can receive frames from the frame sources even if they are in use by another app, but you can't change the settings for the devices.</span></span>
* <span data-ttu-id="867d5-161">[**MemoryPreference**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureInitializationSettings.MemoryPreference) - [**CPU**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureMemoryPreference) を指定すると、システムは CPU メモリを使います。この場合、フレームが到着したとき、それらを [**SoftwareBitmap**](https://msdn.microsoft.com/library/windows/apps/Windows.Graphics.Imaging.SoftwareBitmap) オブジェクトとして利用できることが保証されます。</span><span class="sxs-lookup"><span data-stu-id="867d5-161">[**MemoryPreference**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureInitializationSettings.MemoryPreference) - If you specify [**CPU**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureMemoryPreference), the system will use CPU memory which guarantees that when frames arrive, they will be available as [**SoftwareBitmap**](https://msdn.microsoft.com/library/windows/apps/Windows.Graphics.Imaging.SoftwareBitmap) objects.</span></span> <span data-ttu-id="867d5-162">[**Auto**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureMemoryPreference) を指定すると、システムはフレームを格納するのに最適なメモリの場所を動的に選択します。</span><span class="sxs-lookup"><span data-stu-id="867d5-162">If you specify [**Auto**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureMemoryPreference), the system will dynamically choose the optimal memory location to store frames.</span></span> <span data-ttu-id="867d5-163">システムが GPU メモリの使用を選択した場合、メディア フレームは **SoftwareBitmap** としてではなく、[**IDirect3DSurface** ](https://msdn.microsoft.com/library/windows/apps/Windows.Graphics.DirectX.Direct3D11.IDirect3DSurface) オブジェクトとして到着します。</span><span class="sxs-lookup"><span data-stu-id="867d5-163">If the system chooses to use GPU memory, the media frames will arrive as an [**IDirect3DSurface**](https://msdn.microsoft.com/library/windows/apps/Windows.Graphics.DirectX.Direct3D11.IDirect3DSurface) object and not as a  **SoftwareBitmap**.</span></span>
* <span data-ttu-id="867d5-164">[**StreamingCaptureMode**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureInitializationSettings.StreamingCaptureMode) - これを [**Video**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.StreamingCaptureMode) に設定すると、オーディオをストリーミングする必要がないことが指定されます。</span><span class="sxs-lookup"><span data-stu-id="867d5-164">[**StreamingCaptureMode**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCaptureInitializationSettings.StreamingCaptureMode) - Set this to [**Video**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.StreamingCaptureMode) to indicate that audio doesn't need to be streamed.</span></span>

<span data-ttu-id="867d5-165">[**InitializeAsync**](https://msdn.microsoft.com/library/windows/apps/br226598) を呼び出して、目的の設定で **MediaCapture** を初期化します。</span><span class="sxs-lookup"><span data-stu-id="867d5-165">Call [**InitializeAsync**](https://msdn.microsoft.com/library/windows/apps/br226598) to initialize the **MediaCapture** with your desired settings.</span></span> <span data-ttu-id="867d5-166">初期化が失敗する場合は、必ず *try* ブロック内でこれを呼び出してください。</span><span class="sxs-lookup"><span data-stu-id="867d5-166">Be sure to call this within a *try* block in case initialization fails.</span></span>

[!code-cs[<span data-ttu-id="867d5-167">InitMediaCapture</span><span class="sxs-lookup"><span data-stu-id="867d5-167">InitMediaCapture</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetInitMediaCapture)]

## <a name="set-the-preferred-format-for-the-frame-source"></a><span data-ttu-id="867d5-168">フレーム ソースの優先形式を設定する</span><span class="sxs-lookup"><span data-stu-id="867d5-168">Set the preferred format for the frame source</span></span>
<span data-ttu-id="867d5-169">フレーム ソースの優先形式を設定するには、ソースを表す [ **MediaFrameSource** ](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSource) オブジェクトを取得する必要があります。</span><span class="sxs-lookup"><span data-stu-id="867d5-169">To set the preferred format for a frame source, you need to get a [**MediaFrameSource**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSource) object representing the source.</span></span> <span data-ttu-id="867d5-170">このオブジェクトを取得するには、初期化した **MediaCapture** オブジェクトの [**Frames**](https://msdn.microsoft.com/library/windows/apps/Windows.Phone.Media.Capture.CameraCaptureSequence.Frames) ディクショナリにアクセスし、使用するフレーム ソースの識別子を指定します。</span><span class="sxs-lookup"><span data-stu-id="867d5-170">You get this object by accessing the [**Frames**](https://msdn.microsoft.com/library/windows/apps/Windows.Phone.Media.Capture.CameraCaptureSequence.Frames) dictionary of the initialized **MediaCapture** object, specifying the identifier of the frame source you want to use.</span></span> <span data-ttu-id="867d5-171">これは、フレーム ソース グループを選択していたときに [**MediaFrameSourceInfo**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceInfo) オブジェクトを保存したからです。</span><span class="sxs-lookup"><span data-stu-id="867d5-171">This is why we saved the [**MediaFrameSourceInfo**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceInfo) object when we were selecting a frame source group.</span></span>

<span data-ttu-id="867d5-172">[**MediaFrameSource.SupportedFormats**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSource.SupportedFormats) プロパティには、フレーム ソースのサポートされている形式を記述する [**MediaFrameFormat**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameFormat) オブジェクトの一覧が含まれています。</span><span class="sxs-lookup"><span data-stu-id="867d5-172">The  [**MediaFrameSource.SupportedFormats**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSource.SupportedFormats) property contains a list of [**MediaFrameFormat**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameFormat) objects describing the supported formats for the frame source.</span></span> <span data-ttu-id="867d5-173">**Where** Linq 拡張メソッドを使って、目的のプロパティに基づいて形式を選択します。</span><span class="sxs-lookup"><span data-stu-id="867d5-173">Use the **Where** Linq extension method to select a format based on desired properties.</span></span> <span data-ttu-id="867d5-174">この例では、幅が 1080 ピクセルで、32 ビット RGB 形式のフレームを提供できる形式が選択されています。</span><span class="sxs-lookup"><span data-stu-id="867d5-174">In this example, a format is selected that has a width of 1080 pixels and can supply frames in 32-bit RGB format.</span></span> <span data-ttu-id="867d5-175">**FirstOrDefault** 拡張メソッドは一覧内で最初のエントリを選択します。</span><span class="sxs-lookup"><span data-stu-id="867d5-175">The **FirstOrDefault** extension method selects the first entry in the list.</span></span> <span data-ttu-id="867d5-176">選択された形式が null の場合、要求された形式はそのフレーム ソースでサポートされません。</span><span class="sxs-lookup"><span data-stu-id="867d5-176">If the selected format is null, then the requested format is not supported by the frame source.</span></span> <span data-ttu-id="867d5-177">形式がサポートされている場合は、[**SetFormatAsync**](https://msdn.microsoft.com/library/windows/apps/) を呼び出すことでソースがこの形式を使うことを要求できます。</span><span class="sxs-lookup"><span data-stu-id="867d5-177">If the format is supported, you can request that the source use this format by calling [**SetFormatAsync**](https://msdn.microsoft.com/library/windows/apps/).</span></span>

[!code-cs[<span data-ttu-id="867d5-178">GetPreferredFormat</span><span class="sxs-lookup"><span data-stu-id="867d5-178">GetPreferredFormat</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetGetPreferredFormat)]

## <a name="create-a-frame-reader-for-the-frame-source"></a><span data-ttu-id="867d5-179">フレーム ソースのフレーム リーダーを作成する</span><span class="sxs-lookup"><span data-stu-id="867d5-179">Create a frame reader for the frame source</span></span>
<span data-ttu-id="867d5-180">メディア フレーム ソースのフレームを受け取るには、[**MediaFrameReader**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader) を使います。</span><span class="sxs-lookup"><span data-stu-id="867d5-180">To receive frames for a media frame source, use a [**MediaFrameReader**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader).</span></span>

[!code-cs[<span data-ttu-id="867d5-181">DeclareMediaFrameReader</span><span class="sxs-lookup"><span data-stu-id="867d5-181">DeclareMediaFrameReader</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetDeclareMediaFrameReader)]

<span data-ttu-id="867d5-182">初期化した **MediaCapture** オブジェクトで [**CreateFrameReaderAsync**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCapture.CreateFrameReaderAsync) を呼び出して、フレーム リーダーをインスタンス化します。</span><span class="sxs-lookup"><span data-stu-id="867d5-182">Instantiate the frame reader by calling [**CreateFrameReaderAsync**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCapture.CreateFrameReaderAsync) on your initialized **MediaCapture** object.</span></span> <span data-ttu-id="867d5-183">このメソッドの最初の引数は、フレームを受け取るフレーム ソースです。</span><span class="sxs-lookup"><span data-stu-id="867d5-183">The first argument to this method is the frame source from which you want to receive frames.</span></span> <span data-ttu-id="867d5-184">使用するフレーム ソースごとに、別々のフレーム リーダーを作成できます。</span><span class="sxs-lookup"><span data-stu-id="867d5-184">You can create a separate frame reader for each frame source you want to use.</span></span> <span data-ttu-id="867d5-185">2 番目の引数で、フレームが到着するときの出力形式をシステムに知らせます。</span><span class="sxs-lookup"><span data-stu-id="867d5-185">The second argument tells the system the output format in which you want frames to arrive.</span></span> <span data-ttu-id="867d5-186">これによって、フレームが到着したときに独自の変換を行う必要がなくなります。</span><span class="sxs-lookup"><span data-stu-id="867d5-186">This can save you from having to do your own conversions to frames as they arrive.</span></span> <span data-ttu-id="867d5-187">フレーム ソースでサポートされていない形式を指定すると例外がスローされるため、その値が [**SupportedFormats**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSource.SupportedFormats) コレクションにあることを確認してください。</span><span class="sxs-lookup"><span data-stu-id="867d5-187">Note that if you specify a format that is not supported by the frame source, an exception will be thrown, so be sure that this value is in the [**SupportedFormats**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSource.SupportedFormats) collection.</span></span>  

<span data-ttu-id="867d5-188">フレーム リーダーを作成した後、ソースから新しいフレームが利用可能になったときに発生する [**FrameArrived**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.FrameArrived) イベントのハンドラーを登録します。</span><span class="sxs-lookup"><span data-stu-id="867d5-188">After creating the frame reader, register a handler for the [**FrameArrived**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.FrameArrived) event which is raised whenever a new frame is available from the source.</span></span>

<span data-ttu-id="867d5-189">[**StartAsync**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.StartAsync) を呼び出して、ソースからフレームの読み取りを開始するようにシステムに伝えます。</span><span class="sxs-lookup"><span data-stu-id="867d5-189">Tell the system to start reading frames from the source by calling [**StartAsync**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.StartAsync).</span></span>

[!code-cs[<span data-ttu-id="867d5-190">CreateFrameReader</span><span class="sxs-lookup"><span data-stu-id="867d5-190">CreateFrameReader</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetCreateFrameReader)]

## <a name="handle-the-frame-arrived-event"></a><span data-ttu-id="867d5-191">FrameArrived イベントを処理する</span><span class="sxs-lookup"><span data-stu-id="867d5-191">Handle the frame arrived event</span></span>
<span data-ttu-id="867d5-192">新しいフレームが利用可能になると、[**MediaFrameReader.FrameArrived**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.FrameArrived) イベントが発生します。</span><span class="sxs-lookup"><span data-stu-id="867d5-192">The [**MediaFrameReader.FrameArrived**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.FrameArrived) event is raised whenever a new frame is available.</span></span> <span data-ttu-id="867d5-193">到着したすべてのフレームを処理するか、必要なときのみフレームを使うかを選択できます。</span><span class="sxs-lookup"><span data-stu-id="867d5-193">You can choose to process every frame that arrives or only use frames when you need them.</span></span> <span data-ttu-id="867d5-194">フレーム リーダーは自身のスレッドでイベントを発生させるため、何らかの同期ロジックを実装して、複数のスレッドからの同じデータにアクセスしていないことを確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="867d5-194">Because the frame reader raises the event on its own thread, you may need to implement some synchronization logic to make sure that you aren't attempting to access the same data from multiple threads.</span></span> <span data-ttu-id="867d5-195">このセクションでは、XAML ページのイメージ コントロールへの色フレームの描画を同期する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="867d5-195">This section shows you how to synchronize drawing color frames to an image control in a XAML page.</span></span> <span data-ttu-id="867d5-196">このシナリオでは、XAML コントロールへのすべての更新を UI スレッドで実行するように要求する追加の同期制約について検討します。</span><span class="sxs-lookup"><span data-stu-id="867d5-196">This scenario addresses the additional synchronization constraint that requires all updates to XAML controls be performed on the UI thread.</span></span>

<span data-ttu-id="867d5-197">XAML でフレームを表示するときの最初の手順は、イメージ コントロールの作成です。</span><span class="sxs-lookup"><span data-stu-id="867d5-197">The first step in displaying frames in XAML is to create an Image control.</span></span> 

[!code-xml[<span data-ttu-id="867d5-198">ImageElementXAML</span><span class="sxs-lookup"><span data-stu-id="867d5-198">ImageElementXAML</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml#SnippetImageElementXAML)]

<span data-ttu-id="867d5-199">コード ビハインド ページで、**SoftwareBitmap** 型のクラス メンバー変数を宣言します。これは、すべての着信イメージのコピー先のバック バッファーとして使用されます。</span><span class="sxs-lookup"><span data-stu-id="867d5-199">In your code behind page, declare a class member variable of type **SoftwareBitmap** which will be used as a back buffer that all incoming images will be copied to.</span></span> <span data-ttu-id="867d5-200">イメージ データ自体はコピーされず、オブジェクト参照だけがコピーされます。</span><span class="sxs-lookup"><span data-stu-id="867d5-200">Note that the image data itself isn't copied, just the object references.</span></span> <span data-ttu-id="867d5-201">また、UI 操作が現在実行されているかどうかを追跡するブール値を宣言します。</span><span class="sxs-lookup"><span data-stu-id="867d5-201">Also, declare a boolean to track whether our UI operation is currently running.</span></span>

[!code-cs[<span data-ttu-id="867d5-202">DeclareBackBuffer</span><span class="sxs-lookup"><span data-stu-id="867d5-202">DeclareBackBuffer</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetDeclareBackBuffer)]

<span data-ttu-id="867d5-203">フレームは **SoftwareBitmap** オブジェクトとして到着するため、**SoftwareBitmap** を XAML **Control** のソースとして使用できるようにする [**SoftwareBitmapSource**](https://msdn.microsoft.com/library/windows/apps/Windows.UI.Xaml.Media.Imaging.SoftwareBitmapSource) オブジェクトを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="867d5-203">Because the frames will arrive as **SoftwareBitmap** objects, you need to create a [**SoftwareBitmapSource**](https://msdn.microsoft.com/library/windows/apps/Windows.UI.Xaml.Media.Imaging.SoftwareBitmapSource) object which allows you to use a **SoftwareBitmap** as the source for a XAML **Control**.</span></span> <span data-ttu-id="867d5-204">フレーム リーダーを開始する前に、コード内のどこかでイメージ ソースを設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="867d5-204">You should set the image source somewhere in your code before you start the frame reader.</span></span>

[!code-cs[<span data-ttu-id="867d5-205">ImageElementSource</span><span class="sxs-lookup"><span data-stu-id="867d5-205">ImageElementSource</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetImageElementSource)]

<span data-ttu-id="867d5-206">ここで、**FrameArrived** イベント ハンドラーを実装します。</span><span class="sxs-lookup"><span data-stu-id="867d5-206">Now it's time to implement the **FrameArrived** event handler.</span></span> <span data-ttu-id="867d5-207">ハンドラーが呼び出されると、*sender* パラメーターにイベントを発生させた **MediaFrameReader** オブジェクトへの参照が含まれます。</span><span class="sxs-lookup"><span data-stu-id="867d5-207">When the handler is called, the *sender* parameter contains a reference to the **MediaFrameReader** object which raised the event.</span></span> <span data-ttu-id="867d5-208">このオブジェクトで [**TryAcquireLatestFrame**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.TryAcquireLatestFrame) を呼び出して、最新のフレームの取得を試みます。</span><span class="sxs-lookup"><span data-stu-id="867d5-208">Call [**TryAcquireLatestFrame**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.TryAcquireLatestFrame) on this object to attempt to get the latest frame.</span></span> <span data-ttu-id="867d5-209">名前からわかるように、**TryAcquireLatestFrame** はフレームを返すことに失敗することがあります。</span><span class="sxs-lookup"><span data-stu-id="867d5-209">As the name implies, **TryAcquireLatestFrame** may not succeed in returning a frame.</span></span> <span data-ttu-id="867d5-210">そのため、VideoMediaFrame プロパティ、SoftwareBitmap プロパティの順にアクセスするときは、必ず null を検査してください。</span><span class="sxs-lookup"><span data-stu-id="867d5-210">So, when you access the VideoMediaFrame and then SoftwareBitmap properties, be sure to test for null.</span></span> <span data-ttu-id="867d5-211">この例では、null 条件演算子 ? を使って</span><span class="sxs-lookup"><span data-stu-id="867d5-211">In this example the null condtional operator ?</span></span> <span data-ttu-id="867d5-212">**SoftwareBitmap** にアクセスした後、取得したオブジェクトで null がチェックされています。</span><span class="sxs-lookup"><span data-stu-id="867d5-212">is used to access the **SoftwareBitmap** and then the retrieved object is checked for null.</span></span>

<span data-ttu-id="867d5-213">**Image** コントロールは、プリマルチプライ処理済みまたはアルファなしの BRGA8 形式でのみイメージを表示できます。</span><span class="sxs-lookup"><span data-stu-id="867d5-213">The **Image** control can only display images in BRGA8 format with either pre-multiplied or no alpha.</span></span> <span data-ttu-id="867d5-214">到着するフレームがその形式でない場合は、静的メソッド [**Convert**](https://msdn.microsoft.com/library/windows/apps/Windows.Graphics.Imaging.SoftwareBitmap.Covert) を使ってソフトウェア ビットマップを正しい形式に変換します。</span><span class="sxs-lookup"><span data-stu-id="867d5-214">If the arriving frame is not in that format, the static method [**Convert**](https://msdn.microsoft.com/library/windows/apps/Windows.Graphics.Imaging.SoftwareBitmap.Covert) is used to convert the software bitmap to the correct format.</span></span>

<span data-ttu-id="867d5-215">次に、[**Interlocked.Exchange**](https://msdn.microsoft.com/library/bb337971) メソッドを使って、到着するビットマップの参照をバックバッファー ビットマップと交換します。</span><span class="sxs-lookup"><span data-stu-id="867d5-215">Next, the [**Interlocked.Exchange**](https://msdn.microsoft.com/library/bb337971) method is used to swap the reference of to arriving bitmap with the backbuffer bitmap.</span></span> <span data-ttu-id="867d5-216">このメソッドは、スレッド セーフであるアトミック操作でこれらの参照を交換します。</span><span class="sxs-lookup"><span data-stu-id="867d5-216">This method swaps these references in an atomic operation that is thread-safe.</span></span> <span data-ttu-id="867d5-217">交換後、*softwareBitmap* 変数に格納されている古いバックバッファー イメージは、リソースをクリーンアップするために破棄されます。</span><span class="sxs-lookup"><span data-stu-id="867d5-217">After swapping, the old backbuffer image, now in the *softwareBitmap* variable is disposed of to clean up its resources.</span></span>

<span data-ttu-id="867d5-218">次に、**Image** 要素に関連付けられている [**CoreDispatcher**](https://msdn.microsoft.com/library/windows/apps/Windows.UI.Core.CoreDispatcher) を使って、[**RunAsync**](https://msdn.microsoft.com/library/windows/apps/hh750317) を呼び出して UI スレッドで実行されるタスクを作成します。</span><span class="sxs-lookup"><span data-stu-id="867d5-218">Next, the [**CoreDispatcher**](https://msdn.microsoft.com/library/windows/apps/Windows.UI.Core.CoreDispatcher) associated with the **Image** element is used to create a task that will run on the UI thread by calling [**RunAsync**](https://msdn.microsoft.com/library/windows/apps/hh750317).</span></span> <span data-ttu-id="867d5-219">非同期タスクはタスク内で実行されるため、**RunAsync** に渡されるラムダ式は *async* キーワードを付けて宣言されます。</span><span class="sxs-lookup"><span data-stu-id="867d5-219">Because the asynchronous tasks will be performed within the task, the lambda expression passed to **RunAsync** is declared with the *async* keyword.</span></span>

<span data-ttu-id="867d5-220">タスク内で、*_taskRunning* 変数をチェックして、タスクの 1 つのインスタンスだけが一度に実行されていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="867d5-220">Within the task, the *_taskRunning* variable is checked to make sure that only one instance of the task is running at a time.</span></span> <span data-ttu-id="867d5-221">タスクが既に実行されていない場合は、タスクがもう一度実行されることを防ぐために *_taskRunning* を true に設定します。</span><span class="sxs-lookup"><span data-stu-id="867d5-221">If the task isn't already running, *_taskRunning* is set to true to prevent the task from running again.</span></span> <span data-ttu-id="867d5-222">*while* ループで、バックバッファー イメージが null になるまで、**Interlocked.Exchange** を呼び出してバックバッファーから一時的な **SoftwareBitmap** にコピーします。</span><span class="sxs-lookup"><span data-stu-id="867d5-222">In a *while* loop, **Interlocked.Exchange** is called to copy from the backbuffer into a temporary **SoftwareBitmap** until the backbuffer image is null.</span></span> <span data-ttu-id="867d5-223">一時的なビットマップが入力されるたびに、**Image** の **Source** プロパティを **SoftwareBitmapSource** にキャストし、[**SetBitmapAsync** ](https://msdn.microsoft.com/library/windows/apps/dn997856) を呼び出してイメージのソースを設定します。</span><span class="sxs-lookup"><span data-stu-id="867d5-223">For each time the temporary bitmap is populated, the **Source** property of the **Image** is cast to a **SoftwareBitmapSource**, and then [**SetBitmapAsync**](https://msdn.microsoft.com/library/windows/apps/dn997856) is called to set the source of the image.</span></span>

<span data-ttu-id="867d5-224">最後に、次回にハンドラーが呼び出されたときにタスクをもう一度実行できるように、*_taskRunning* 変数を false に戻します。</span><span class="sxs-lookup"><span data-stu-id="867d5-224">Finally, the *_taskRunning* variable is set back to false so that the task can be run again the next time the handler is called.</span></span>

> [!NOTE] 
> <span data-ttu-id="867d5-225">[**MediaFrameReference**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReference) の [**VideoMediaFrame**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReference.VideoMediaFrame) プロパティが提供する [**SoftwareBitmap**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.VideoMediaFrame.SoftwareBitmap) オブジェクトまたは [**Direct3DSurface**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.VideoMediaFrame.Direct3DSurface) オブジェクトにアクセスすると、これらのオブジェクトへの強参照がシステムによって作成されます。そのため、それらが含まれている **MediaFrameReference** に対して [**Dispose**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReference.Close) を呼び出してもこれらのオブジェクトは破棄されません。</span><span class="sxs-lookup"><span data-stu-id="867d5-225">If you access the [**SoftwareBitmap**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.VideoMediaFrame.SoftwareBitmap) or [**Direct3DSurface**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.VideoMediaFrame.Direct3DSurface) objects provided by the [**VideoMediaFrame**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReference.VideoMediaFrame) property of a [**MediaFrameReference**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReference), the system creates a strong reference to these objects, which means that they will not be disposed when you call [**Dispose**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReference.Close) on the containing **MediaFrameReference**.</span></span> <span data-ttu-id="867d5-226">それらのオブジェクトを即座に破棄するには、**SoftwareBitmap** または **Direct3DSurface** の **Dispose** メソッドを明示的に直接呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="867d5-226">You must explicitly call the **Dispose** method of the **SoftwareBitmap** or **Direct3DSurface** directly for the objects to be immediately disposed.</span></span> <span data-ttu-id="867d5-227">そうしない場合、最終的にはガーベジ コレクターによってこれらのオブジェクトのメモリが解放されますが、それがいつになるかは不明であり、割り当てられたビットマップやサーフェスの数がシステムによって許容される最大数を上回った場合、新しいフレームのフローが停止します。</span><span class="sxs-lookup"><span data-stu-id="867d5-227">Otherwise, the garbage collector will eventually free the memory for these objects, but you can't know when this will occur, and if the number of allocated bitmaps or surfaces exceeds the maximum amount allowed by the system, the flow of new frames will stop.</span></span>


[!code-cs[<span data-ttu-id="867d5-228">FrameArrived</span><span class="sxs-lookup"><span data-stu-id="867d5-228">FrameArrived</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetFrameArrived)]

## <a name="cleanup-resources"></a><span data-ttu-id="867d5-229">リソースをクリーンアップする</span><span class="sxs-lookup"><span data-stu-id="867d5-229">Cleanup resources</span></span>
<span data-ttu-id="867d5-230">フレームの読み込みが終わったら、必ず [**StopAsync**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.StopAsync) を呼び出してメディア フレーム リーダーを停止して、**FrameArrived** ハンドラーの登録を解除し、**MediaCapture** オブジェクトを破棄してください。</span><span class="sxs-lookup"><span data-stu-id="867d5-230">When you are done reading frames, be sure to stop the media frame reader by calling [**StopAsync**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.StopAsync), unregistering the **FrameArrived** handler, and disposing of the **MediaCapture** object.</span></span>

[!code-cs[<span data-ttu-id="867d5-231">クリーンアップ</span><span class="sxs-lookup"><span data-stu-id="867d5-231">Cleanup</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetCleanup)]

<span data-ttu-id="867d5-232">アプリケーションが中断されたときのメディア キャプチャ オブジェクトのクリーンアップについて詳しくは、「[**カメラ プレビューの表示**](simple-camera-preview-access.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="867d5-232">For more information about cleaning up media capture objects when your application is suspended, see [**Display the camera preview**](simple-camera-preview-access.md).</span></span>

## <a name="the-framerenderer-helper-class"></a><span data-ttu-id="867d5-233">FrameRenderer ヘルパー クラス</span><span class="sxs-lookup"><span data-stu-id="867d5-233">The FrameRenderer helper class</span></span>
<span data-ttu-id="867d5-234">ユニバーサル Windows の[カメラ フレームのサンプル](http://go.microsoft.com/fwlink/?LinkId=823230)は、アプリで色、赤外線、および深度のソースからフレームを表示するのを容易にするヘルパー クラスを提供します。</span><span class="sxs-lookup"><span data-stu-id="867d5-234">The Universal Windows [Camera frames sample](http://go.microsoft.com/fwlink/?LinkId=823230) provides a helper class that makes it easy to display the frames from color, infrared, and depth sources in your app.</span></span> <span data-ttu-id="867d5-235">通常、深度や赤外線のデータを画面に表示するだけでなく、データを使ってそれ以上のことを行いたいですが、このヘルパー クラスは、フレーム リーダーの機能を示したり、独自のフレーム リーダーの実装をデバッグしたりするための便利なツールです。</span><span class="sxs-lookup"><span data-stu-id="867d5-235">Typically, you will want to do something more with depth and infrared data than just display it to the screen, but this helper class is a helpful tool for demonstrating the frame reader feature and for debugging your own frame reader implementation.</span></span>

<span data-ttu-id="867d5-236">**FrameRenderer** ヘルパー クラスは、次のメソッドを実装します。</span><span class="sxs-lookup"><span data-stu-id="867d5-236">The **FrameRenderer** helper class implements the following methods.</span></span>

* <span data-ttu-id="867d5-237">**FrameRenderer** コンストラクター - このコンストラクターは、メディア フレームを表示するために渡す XAML [**Image**](https://msdn.microsoft.com/library/windows/apps/Windows.UI.Xaml.Controls.Image) 要素を使うようにヘルパー クラスを初期化します。</span><span class="sxs-lookup"><span data-stu-id="867d5-237">**FrameRenderer** constructor - The constructor initializes the helper class to use the XAML [**Image**](https://msdn.microsoft.com/library/windows/apps/Windows.UI.Xaml.Controls.Image) element you pass in for displaying media frames.</span></span>
* <span data-ttu-id="867d5-238">**ProcessFrame** - このメソッドは、コンストラクターに渡した **Image** 要素に、[**MediaFrameReference**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReference) で表されるメディア フレームを表示します。</span><span class="sxs-lookup"><span data-stu-id="867d5-238">**ProcessFrame** - This method displays a media frame, represented by a [**MediaFrameReference**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReference), in the **Image** element you passed into the constructor.</span></span> <span data-ttu-id="867d5-239">通常、[**FrameArrived**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.FrameArrived) イベント ハンドラーからこのメソッドを呼び出し、[**TryAcquireLatestFrame**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.TryAcquireLatestFrame) から返されるフレームを渡します。</span><span class="sxs-lookup"><span data-stu-id="867d5-239">You should typically call this method from your [**FrameArrived**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.FrameArrived) event handler, passing in the frame returned by [**TryAcquireLatestFrame**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader.TryAcquireLatestFrame).</span></span>
* <span data-ttu-id="867d5-240">**ConvertToDisplayableImage** - このメソッドは、メディア フレームの形式をチェックし、必要な場合は表示可能な形式に変換します。</span><span class="sxs-lookup"><span data-stu-id="867d5-240">**ConvertToDisplayableImage** - This methods checks the format of the media frame and, if necessary, converts it to a displayable format.</span></span> <span data-ttu-id="867d5-241">カラー イメージの場合は、色の形式が BGRA8 であり、ビットマップのアルファ モードがプリマルチプライ済みであることを確認します。</span><span class="sxs-lookup"><span data-stu-id="867d5-241">For color images, this means making sure that the color format is BGRA8 and that the bitmap alpha mode is premultiplied.</span></span> <span data-ttu-id="867d5-242">深度または赤外線フレームの場合は、各スキャン ラインを処理して、深度または赤外線の値が疑似カラー グラデーションに変換します。これには、サンプルに含まれていて以下に記載される **PseudoColorHelper** クラスを使います。</span><span class="sxs-lookup"><span data-stu-id="867d5-242">For depth or infrared frames, each scanline is processed to convert the depth or infrared values to a psuedocolor gradient, using the **PsuedoColorHelper** class that is also included in the sample and listed below.</span></span>

> [!NOTE] 
> <span data-ttu-id="867d5-243">**SoftwareBitmap** イメージ上でピクセル操作を行うには、ネイティブ メモリ バッファーにアクセスする必要があります。</span><span class="sxs-lookup"><span data-stu-id="867d5-243">In order to do pixel manipulation on **SoftwareBitmap** images, you must access a native memory buffer.</span></span> <span data-ttu-id="867d5-244">これを行うには、以下のコードに含まれている IMemoryBufferByteAccess COM インターフェイスを使う必要があり、アンセーフ コードのコンパイルを許可するようにプロジェクトのプロパティを更新する必要があります。</span><span class="sxs-lookup"><span data-stu-id="867d5-244">To do this, you must use the IMemoryBufferByteAccess COM interface included in the code listing below and you must update your project properties to allow compilation of unsafe code.</span></span> <span data-ttu-id="867d5-245">詳しくは、「[ビットマップ画像の作成、編集、保存](imaging.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="867d5-245">For more information, see [Create, edit, and save bitmap images](imaging.md).</span></span>

[!code-cs[<span data-ttu-id="867d5-246">FrameArrived</span><span class="sxs-lookup"><span data-stu-id="867d5-246">FrameArrived</span></span>](./code/Frames_Win10/Frames_Win10/FrameRenderer.cs#SnippetFrameRenderer)]

## <a name="use-multisourcemediaframereader-to-get-time-corellated-frames-from-multiple-sources"></a><span data-ttu-id="867d5-247">MultiSourceMediaFrameReader を使って複数のソースから時間相関フレームを取得する</span><span class="sxs-lookup"><span data-stu-id="867d5-247">Use MultiSourceMediaFrameReader to get time-corellated frames from multiple sources</span></span>
<span data-ttu-id="867d5-248">Windows 10 Version 1607 以降では、[**MultiSourceMediaFrameReader**](https://docs.microsoft.com/en-us/uwp/api/windows.media.capture.frames.multisourcemediaframereader) を使って複数のソースから時間相関フレームを取得できます。</span><span class="sxs-lookup"><span data-stu-id="867d5-248">Starting with Windows 10, version 1607, you can use [**MultiSourceMediaFrameReader**](https://docs.microsoft.com/en-us/uwp/api/windows.media.capture.frames.multisourcemediaframereader) to receive time-corellated frames from multiple sources.</span></span> <span data-ttu-id="867d5-249">この API により、[**DepthCorrelatedCoordinateMapper**](https://docs.microsoft.com/en-us/uwp/api/windows.media.devices.core.depthcorrelatedcoordinatemapper) クラスを使う場合など、複数のソースから時間的に近接するフレームを必要とする処理が簡単になります。</span><span class="sxs-lookup"><span data-stu-id="867d5-249">This API makes it easier to do processing that requires frames from multiple sources that were taken in close temporal proximity, such as using the [**DepthCorrelatedCoordinateMapper**](https://docs.microsoft.com/en-us/uwp/api/windows.media.devices.core.depthcorrelatedcoordinatemapper) class.</span></span> <span data-ttu-id="867d5-250">ただし、この新しいメソッドを使う場合の制限の 1 つとして、フレーム到着イベントは、最も低速なキャプチャ ソースに合わせて生成されるようになります。</span><span class="sxs-lookup"><span data-stu-id="867d5-250">One limitation of using this new method is that frame-arrived events are only raised at the rate of the slowest capture source.</span></span> <span data-ttu-id="867d5-251">高速なソースからの追加のフレームは取りこぼされます。</span><span class="sxs-lookup"><span data-stu-id="867d5-251">Extra frames from faster sources will be dropped.</span></span> <span data-ttu-id="867d5-252">また、システムでは、さまざまなソースからさまざまな速度でフレームが到着するものと想定するため、ソースがフレームの生成を完全に停止したかどうかを自動的に認識することはできません。</span><span class="sxs-lookup"><span data-stu-id="867d5-252">Also, because the system expects frames to arrive from different sources at different rates, it does not automatically recognize if a source has stopped generating frames altogether.</span></span> <span data-ttu-id="867d5-253">このセクションのコード例では、イベントを使って独自のタイムアウト ロジックを作成する方法を示します。アプリで定義した制限時間内に相関フレームが到着しなかった場合、タイムアウトが発生します。</span><span class="sxs-lookup"><span data-stu-id="867d5-253">The example code in this section shows how to use an event to create your own timeout logic that gets invoked if correlated frames don't arrive within an app-defined time limit.</span></span>

<span data-ttu-id="867d5-254">[**MultiSourceMediaFrameReader**](https://docs.microsoft.com/en-us/uwp/api/windows.media.capture.frames.multisourcemediaframereader) を使う手順は、この記事で既に説明した [**MediaFrameReader**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader) を使う手順と同様です。</span><span class="sxs-lookup"><span data-stu-id="867d5-254">The steps for using [**MultiSourceMediaFrameReader**](https://docs.microsoft.com/en-us/uwp/api/windows.media.capture.frames.multisourcemediaframereader) are similar to the steps for using [**MediaFrameReader**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameReader) described previously in this article.</span></span> <span data-ttu-id="867d5-255">この例では、カラー ソースと深度ソースを使います。</span><span class="sxs-lookup"><span data-stu-id="867d5-255">This example will use a color source and a depth source.</span></span> <span data-ttu-id="867d5-256">メディア フレーム ソース ID を格納する文字列変数をいくつか宣言します。これらの ID は、各ソースからのフレームを選択するために使われます。</span><span class="sxs-lookup"><span data-stu-id="867d5-256">Declare some string variables to store the media frame source IDs that will be used to select frames from each source.</span></span> <span data-ttu-id="867d5-257">次に、サンプルのタイムアウト ロジックを実装するために使う [**ManualResetEventSlim**](https://docs.microsoft.com/dotnet/api/system.threading.manualreseteventslim?view=netframework-4.7)、[**CancellationTokenSource**](https://msdn.microsoft.com/library/system.threading.cancellationtokensource.aspx)、[**EventHandler**](https://msdn.microsoft.com/library/system.eventhandler.aspx) を宣言します。</span><span class="sxs-lookup"><span data-stu-id="867d5-257">Next, declare a [**ManualResetEventSlim**](https://docs.microsoft.com/dotnet/api/system.threading.manualreseteventslim?view=netframework-4.7), a [**CancellationTokenSource**](https://msdn.microsoft.com/library/system.threading.cancellationtokensource.aspx), and an [**EventHandler**](https://msdn.microsoft.com/library/system.eventhandler.aspx) that will be used to implement timeout logic for the example.</span></span> 

[!code-cs[<span data-ttu-id="867d5-258">MultiFrameDeclarations</span><span class="sxs-lookup"><span data-stu-id="867d5-258">MultiFrameDeclarations</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetMultiFrameDeclarations)]

<span data-ttu-id="867d5-259">この記事で既に説明した手法を使って、このサンプル シナリオに必要なカラー ソースと深度ソースを含む [**MediaFrameSourceGroup**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceGroup) を照会します。</span><span class="sxs-lookup"><span data-stu-id="867d5-259">Using the techniques described previously in this article, query for a [**MediaFrameSourceGroup**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceGroup) that includes the color and depth sources required for this example scenario.</span></span> <span data-ttu-id="867d5-260">目的のフレーム ソース グループを選択したら、各フレーム ソースの [**MediaFrameSourceInfo**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceInfo) を取得します。</span><span class="sxs-lookup"><span data-stu-id="867d5-260">After selecting the desired frame source group, get the [**MediaFrameSourceInfo**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.Frames.MediaFrameSourceInfo) for each frame source.</span></span>

[!code-cs[<span data-ttu-id="867d5-261">SelectColorAndDepth</span><span class="sxs-lookup"><span data-stu-id="867d5-261">SelectColorAndDepth</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetSelectColorAndDepth)]

<span data-ttu-id="867d5-262">**MediaCapture** オブジェクトを作成し、選択したフレーム ソース グループを初期化設定に渡して初期化します。</span><span class="sxs-lookup"><span data-stu-id="867d5-262">Create and initialize a **MediaCapture** object, passing the selected frame source group in the initialization settings.</span></span>

[!code-cs[<span data-ttu-id="867d5-263">MultiFrameInitMediaCapture</span><span class="sxs-lookup"><span data-stu-id="867d5-263">MultiFrameInitMediaCapture</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetMultiFrameInitMediaCapture)]

<span data-ttu-id="867d5-264">**MediaCapture** オブジェクトを初期化したら、カラー カメラと深度カメラの [**MediaFrameSource**](https://docs.microsoft.com/uwp/api/Windows.Media.Capture.Frames.MediaFrameSource) オブジェクトを取得します。</span><span class="sxs-lookup"><span data-stu-id="867d5-264">After initializing the **MediaCapture** object, retrieve [**MediaFrameSource**](https://docs.microsoft.com/uwp/api/Windows.Media.Capture.Frames.MediaFrameSource) objects for the color and depth cameras.</span></span> <span data-ttu-id="867d5-265">各ソースの ID を格納して、対応するソースから到着したフレームを選択できるようにします。</span><span class="sxs-lookup"><span data-stu-id="867d5-265">Store the ID for each source so that you can select the arriving frame for the corresponding source.</span></span>

[!code-cs[<span data-ttu-id="867d5-266">GetColorAndDepthSource</span><span class="sxs-lookup"><span data-stu-id="867d5-266">GetColorAndDepthSource</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetGetColorAndDepthSource)]

<span data-ttu-id="867d5-267">**MultiSourceMediaFrameReader** を作成して初期化します。そのためには、[**CreateMultiSourceFrameReaderAsync**](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacapture#Windows_Media_Capture_MediaCapture_CreateMultiSourceFrameReaderAsync_Windows_Foundation_Collections_IIterable_Windows_Media_Capture_Frames_MediaFrameSource__) を呼び出して、リーダーで使用するフレーム ソースの配列を渡します。</span><span class="sxs-lookup"><span data-stu-id="867d5-267">Create and initialize the **MultiSourceMediaFrameReader** by calling [**CreateMultiSourceFrameReaderAsync**](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacapture#Windows_Media_Capture_MediaCapture_CreateMultiSourceFrameReaderAsync_Windows_Foundation_Collections_IIterable_Windows_Media_Capture_Frames_MediaFrameSource__) and passing an array of frame sources that the reader will use.</span></span> <span data-ttu-id="867d5-268">[**FrameArrived**](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.multisourcemediaframereader#Windows_Media_Capture_Frames_MultiSourceMediaFrameReader_FrameArrived) イベントに対するイベント ハンドラーを登録します。</span><span class="sxs-lookup"><span data-stu-id="867d5-268">Register an event handler for the [**FrameArrived**](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.multisourcemediaframereader#Windows_Media_Capture_Frames_MultiSourceMediaFrameReader_FrameArrived) event.</span></span> <span data-ttu-id="867d5-269">この例では、フレームを **Image** コントロールにレンダリングするために、この記事で既に説明した **FrameRenderer** ヘルパー クラスのインスタンスを作成します。</span><span class="sxs-lookup"><span data-stu-id="867d5-269">This example creates an instance the **FrameRenderer** helper class, described previously in this article, to render frames to an **Image** control.</span></span> <span data-ttu-id="867d5-270">[**StartAsync**](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.multisourcemediaframereader#Windows_Media_Capture_Frames_MultiSourceMediaFrameReader_StartAsync) を呼び出して、フレーム リーダーを開始します。</span><span class="sxs-lookup"><span data-stu-id="867d5-270">Start the frame reader by calling [**StartAsync**](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.multisourcemediaframereader#Windows_Media_Capture_Frames_MultiSourceMediaFrameReader_StartAsync).</span></span>

<span data-ttu-id="867d5-271">この例で既に宣言した **CorellationFailed** イベントに対するイベント ハンドラーを登録します。</span><span class="sxs-lookup"><span data-stu-id="867d5-271">Register an event handler for the **CorellationFailed** event declared earlier in the example.</span></span> <span data-ttu-id="867d5-272">使用中のメディア フレーム ソースのいずれかがフレームの生成を停止すると、このイベントが通知されます。</span><span class="sxs-lookup"><span data-stu-id="867d5-272">We will signal this event if one of the media frame sources being used stops producing frames.</span></span> <span data-ttu-id="867d5-273">最後に、[**Task.Run**](https://msdn.microsoft.com/en-us/library/hh195051.aspx) を呼び出して、タイムアウト ヘルパー メソッドである **NotifyAboutCorrelationFailure** を別のスレッドで実行します。</span><span class="sxs-lookup"><span data-stu-id="867d5-273">Finally, call [**Task.Run**](https://msdn.microsoft.com/en-us/library/hh195051.aspx) to call the timeout helper method, **NotifyAboutCorrelationFailure**, on a separate thread.</span></span> <span data-ttu-id="867d5-274">このメソッドの実装は後で示します。</span><span class="sxs-lookup"><span data-stu-id="867d5-274">The implementation of this method is shown later in this article.</span></span>

[!code-cs[<span data-ttu-id="867d5-275">InitMultiFrameReader</span><span class="sxs-lookup"><span data-stu-id="867d5-275">InitMultiFrameReader</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetInitMultiFrameReader)]

<span data-ttu-id="867d5-276">**FrameArrived** イベントは、**MultiSourceMediaFrameReader** で管理されているすべてのメディア フレーム ソースで新しいフレームが利用可能になったときに発生します。</span><span class="sxs-lookup"><span data-stu-id="867d5-276">The **FrameArrived** event is raised whenever a new frame is available from all of the media frame sources that are managed by the **MultiSourceMediaFrameReader**.</span></span> <span data-ttu-id="867d5-277">つまりこのイベントは、最も低速なメディア ソースに合わせて発生することになります。</span><span class="sxs-lookup"><span data-stu-id="867d5-277">This means that the event will be raised on the cadence of the slowest media source.</span></span> <span data-ttu-id="867d5-278">低速なソースでフレームが 1 つ生成される間に別のソースで複数のフレームが生成された場合、高速なフレームからの追加のフレームは取りこぼされます。</span><span class="sxs-lookup"><span data-stu-id="867d5-278">If one source produces multiple frames in the time that a slower source produces one frame, the extra frames from the fast source will be dropped.</span></span> 

<span data-ttu-id="867d5-279">[**TryAcquireLatestFrame**](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.multisourcemediaframereader#Windows_Media_Capture_Frames_MultiSourceMediaFrameReader_TryAcquireLatestFrame) を呼び出して、イベントに関連付けられている [**MultiSourceMediaFrameReference**](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.multisourcemediaframereference) を取得します。</span><span class="sxs-lookup"><span data-stu-id="867d5-279">Get the [**MultiSourceMediaFrameReference**](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.multisourcemediaframereference) associated with the event by calling [**TryAcquireLatestFrame**](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.multisourcemediaframereader#Windows_Media_Capture_Frames_MultiSourceMediaFrameReader_TryAcquireLatestFrame).</span></span> <span data-ttu-id="867d5-280">[**TryGetFrameReferenceBySourceId**](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.multisourcemediaframereference#Windows_Media_Capture_Frames_MultiSourceMediaFrameReference_TryGetFrameReferenceBySourceId_System_String_) を呼び出して、各メディア フレーム ソースに関連付けられている **MediaFrameReference** を取得します。引数には、フレーム リーダーの初期化時に格納した ID 文字列を渡します。</span><span class="sxs-lookup"><span data-stu-id="867d5-280">Get the **MediaFrameReference** associated with each media frame source by calling [**TryGetFrameReferenceBySourceId**](https://docs.microsoft.com/uwp/api/windows.media.capture.frames.multisourcemediaframereference#Windows_Media_Capture_Frames_MultiSourceMediaFrameReference_TryGetFrameReferenceBySourceId_System_String_), passing in the ID strings stored when the frame reader was initialized.</span></span>

<span data-ttu-id="867d5-281">**ManualResetEventSlim** オブジェクトの [**Set**](https://msdn.microsoft.com/library/system.threading.manualreseteventslim.set.aspx) メソッドを呼び出して、フレームが到着したことを通知します。</span><span class="sxs-lookup"><span data-stu-id="867d5-281">Call the [**Set**](https://msdn.microsoft.com/library/system.threading.manualreseteventslim.set.aspx) method of the **ManualResetEventSlim** object to signal that frames have arrived.</span></span> <span data-ttu-id="867d5-282">このイベントは、別のスレッドで実行中の **NotifyCorrelationFailure** メソッドでチェックされます。</span><span class="sxs-lookup"><span data-stu-id="867d5-282">We will check this event in the **NotifyCorrelationFailure** method that is running in a separate thread.</span></span> 

<span data-ttu-id="867d5-283">最後に、時間相関メディア フレームに対して任意の処理を実行します。</span><span class="sxs-lookup"><span data-stu-id="867d5-283">Finally, perform any processing on the time-correlated media frames.</span></span> <span data-ttu-id="867d5-284">この例では、深度ソースからのフレームを描画するだけです。</span><span class="sxs-lookup"><span data-stu-id="867d5-284">This example simply displays the frame from the depth source.</span></span>

[!code-cs[<span data-ttu-id="867d5-285">MultiFrameArrived</span><span class="sxs-lookup"><span data-stu-id="867d5-285">MultiFrameArrived</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetMultiFrameArrived)]

<span data-ttu-id="867d5-286">**NotifyCorrelationFailure** ヘルパー メソッドは、フレーム リーダーの開始後に別のスレッドで実行ました。</span><span class="sxs-lookup"><span data-stu-id="867d5-286">The **NotifyCorrelationFailure** helper method was run on a separate thread after the frame reader was started.</span></span> <span data-ttu-id="867d5-287">このメソッドでは、フレーム受信イベントが通知されたかどうかをチェックします。</span><span class="sxs-lookup"><span data-stu-id="867d5-287">In this method, check to see if the frame received event has been signaled.</span></span> <span data-ttu-id="867d5-288">既に説明したとおり、このイベントは、相関フレームのセットが到着するたびに **FrameArrived** ハンドラーで設定されます。</span><span class="sxs-lookup"><span data-stu-id="867d5-288">Remember, in the **FrameArrived** handler, we set this event whenever a set of correlated frames arrive.</span></span> <span data-ttu-id="867d5-289">アプリで定義した時間内 (適切な値は 5 秒程度) にイベントが通知されなかった場合、**CancellationToken** を使ってタスクが取り消されたのでなければ、いずれかのメディア フレーム ソースでフレームの読み取りが停止した可能性があります。</span><span class="sxs-lookup"><span data-stu-id="867d5-289">If the event hasn't been signaled for some app-defined period of time - 5 seconds is a reasonable value - and the task wasn't cancelled using the **CancellationToken**, then it's likely that one of the media frame sources has stopped reading frames.</span></span> <span data-ttu-id="867d5-290">この場合、通常はフレーム リーダーをシャットダウンすることになります。そこで、アプリ定義の **CorrelationFailed** イベントを発生させます。</span><span class="sxs-lookup"><span data-stu-id="867d5-290">In this case you typically want to shut down the frame reader, so raise the app-defined **CorrelationFailed** event.</span></span> <span data-ttu-id="867d5-291">このイベントのハンドラーでフレーム リーダーを停止し、この記事で既に説明したように、関連付けられているリソースをクリーンアップします。</span><span class="sxs-lookup"><span data-stu-id="867d5-291">In the handler for this event you can stop the frame reader and clean up it's associated resources as shown previously in this article.</span></span>

[!code-cs[<span data-ttu-id="867d5-292">NotifyCorrelationFailure</span><span class="sxs-lookup"><span data-stu-id="867d5-292">NotifyCorrelationFailure</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetNotifyCorrelationFailure)]

[!code-cs[<span data-ttu-id="867d5-293">CorrelationFailure</span><span class="sxs-lookup"><span data-stu-id="867d5-293">CorrelationFailure</span></span>](./code/Frames_Win10/Frames_Win10/MainPage.xaml.cs#SnippetCorrelationFailure)]

## <a name="related-topics"></a><span data-ttu-id="867d5-294">関連トピック</span><span class="sxs-lookup"><span data-stu-id="867d5-294">Related topics</span></span>

* [<span data-ttu-id="867d5-295">カメラ</span><span class="sxs-lookup"><span data-stu-id="867d5-295">Camera</span></span>](camera.md)
* [<span data-ttu-id="867d5-296">MediaCapture を使った基本的な写真、ビデオ、およびオーディオのキャプチャ</span><span class="sxs-lookup"><span data-stu-id="867d5-296">Basic photo, video, and audio capture with MediaCapture</span></span>](basic-photo-video-and-audio-capture-with-MediaCapture.md)
* [<span data-ttu-id="867d5-297">カメラ フレームのサンプル</span><span class="sxs-lookup"><span data-stu-id="867d5-297">Camera frames sample</span></span>](http://go.microsoft.com/fwlink/?LinkId=823230)
 

 




