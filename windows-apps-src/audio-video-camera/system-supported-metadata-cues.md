---
ms.assetid: F28162D4-AACC-4EE0-B243-5878F870F87F
description: メディアの再生中にシステムでサポートされているメタデータ キューを処理します
title: システムでサポートされているタイミングが設定されたメタデータのキュー
ms.date: 04/18/2017
ms.topic: article
keywords: Windows 10, UWP, メタデータ, キュー, 音声, チャプター
ms.localizationpriority: medium
ms.openlocfilehash: 2f461bb70c1319352c66b8d12775dc7fa1db0edf
ms.sourcegitcommit: d7613c791107f74b6a3dc12a372d9de916c0454b
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/05/2018
ms.locfileid: "8744928"
---
# <a name="system-supported-timed-metadata-cues"></a><span data-ttu-id="514ee-104">システムでサポートされているタイミングが設定されたメタデータのキュー</span><span class="sxs-lookup"><span data-stu-id="514ee-104">System-supported timed metadata cues</span></span>
<span data-ttu-id="514ee-105">この記事では、メディア ファイルやストリームに埋め込まれる可能性がある、タイミングが設定されたメタデータのいくつかの形式を活用する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="514ee-105">This article describes how to take advantage of several formats of timed metadata that may be embedded in media files or streams.</span></span> <span data-ttu-id="514ee-106">UWP アプリは、これらのメタデータ キューが発生したときに、メディア パイプラインで再生中に発生したイベントについて登録できます。</span><span class="sxs-lookup"><span data-stu-id="514ee-106">UWP apps can register for events that are raised by the media pipeline during playback whenever these metadata cues are encountered.</span></span> <span data-ttu-id="514ee-107">アプリでは、[**DataCue**](https://docs.microsoft.com/uwp/api/Windows.Media.Core.DataCue) クラスを使って独自のカスタム メタデータ キューを実装できますが、この記事ではメディア パイプラインで自動的に検出される、次のようなメタデータ標準に重点を置いて説明します。</span><span class="sxs-lookup"><span data-stu-id="514ee-107">Using the [**DataCue**](https://docs.microsoft.com/uwp/api/Windows.Media.Core.DataCue) class, apps can implement their own custom metadata cues, but this article focuses on several metadata standards that are automatically detected by the media pipeline, including:</span></span>

* <span data-ttu-id="514ee-108">VobSub 形式の画像ベースの字幕</span><span class="sxs-lookup"><span data-stu-id="514ee-108">Image-based subtitles in VobSub format</span></span>
* <span data-ttu-id="514ee-109">単語の境界、文の境界、音声合成マークアップ言語 (SSML) のブックマークなど、音声キュー</span><span class="sxs-lookup"><span data-stu-id="514ee-109">Speech cues, including word boundaries, sentence boundaries, and Speech Synthesis Markup Language (SSML) bookmarks</span></span>
* <span data-ttu-id="514ee-110">チャプター キュー</span><span class="sxs-lookup"><span data-stu-id="514ee-110">Chapter cues</span></span>
* <span data-ttu-id="514ee-111">Extended M3U コメント</span><span class="sxs-lookup"><span data-stu-id="514ee-111">Extended M3U comments</span></span>
* <span data-ttu-id="514ee-112">ID3 タグ</span><span class="sxs-lookup"><span data-stu-id="514ee-112">ID3 tags</span></span>
* <span data-ttu-id="514ee-113">Fragmented mp4 emsg ボックス</span><span class="sxs-lookup"><span data-stu-id="514ee-113">Fragmented mp4 emsg boxes</span></span>


<span data-ttu-id="514ee-114">この記事は、「[メディア項目、プレイリスト、トラック](media-playback-with-mediasource.md)」の記事で説明されている概念に基づいています。この概念には、[**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource)、[**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem)、[**TimedMetadataTrack**](https://msdn.microsoft.com/library/windows/apps/dn956580) クラスの操作の基本や、アプリでタイミングが設定されたメタデータを使用するための一般的なガイダンスが含まれます。</span><span class="sxs-lookup"><span data-stu-id="514ee-114">This article builds on the concepts discussed  in the article [Media items, playlists, and tracks](media-playback-with-mediasource.md), which includes the basics of working with the [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource), [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem), and [**TimedMetadataTrack**](https://msdn.microsoft.com/library/windows/apps/dn956580) classes and general guidance for using timed metadata in your app.</span></span>

<span data-ttu-id="514ee-115">基本的な実装手順は、この記事で説明されている、さまざまな種類のタイミングが設定されたメタデータと同じです。</span><span class="sxs-lookup"><span data-stu-id="514ee-115">The basic implementation steps are the same for all of the different types of timed metadata described in this article:</span></span>

1. <span data-ttu-id="514ee-116">[**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) を作成した後、再生されるコンテンツの [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) を作成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-116">Create a [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) and then a [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) for the content to be played.</span></span>
2. <span data-ttu-id="514ee-117">[**MediaPlaybackItem.TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) イベントに登録します。このイベントは、メディア項目のサブトラックがメディア パイプラインで解決されるときに発生します。</span><span class="sxs-lookup"><span data-stu-id="514ee-117">Register for the [**MediaPlaybackItem.TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) event, which occurs as the sub-tracks of the media item are resolved by the media pipeline.</span></span>
3. <span data-ttu-id="514ee-118">使用するタイミングが設定されたメタデータ トラックの [**TimedMetadataTrack.CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) イベントと [**TimedMetadataTrack.CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-118">Register for the [**TimedMetadataTrack.CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) and [**TimedMetadataTrack.CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) events for the timed metadata tracks you want to use.</span></span>
4. <span data-ttu-id="514ee-119">**CueEntered** イベント ハンドラーで、イベント引数で渡されたメタデータに基づいて UI を更新します。</span><span class="sxs-lookup"><span data-stu-id="514ee-119">In the **CueEntered** event handler, update your UI based on the metadata passed in the event args.</span></span> <span data-ttu-id="514ee-120">**CueExited** イベントで、もう一度 UI を更新して、現在の字幕テキストを削除するなどの処理を行います。</span><span class="sxs-lookup"><span data-stu-id="514ee-120">You can update the UI again, to remove the current subtitle text for example, in the **CueExited** event.</span></span>

<span data-ttu-id="514ee-121">この記事では、個別のシナリオで各種のメタデータの処理について説明しますが、ほとんどが共有されるコードを使用して、さまざまな種類のメタデータを処理 (または無視) することができます。</span><span class="sxs-lookup"><span data-stu-id="514ee-121">In this article, handling each type of metadata is shown as a distinct scenario, but it's possible to handle (or ignore) different types of metadata using mostly shared code.</span></span> <span data-ttu-id="514ee-122">このプロセスの複数のポイントで、[**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) オブジェクトの [**TimedMetadataKind**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.TimedMetadataKind) プロパティを確認できます。</span><span class="sxs-lookup"><span data-stu-id="514ee-122">You can check the [**TimedMetadataKind**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.TimedMetadataKind) property of the [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) object at multiple points in the process.</span></span> <span data-ttu-id="514ee-123">そのため、たとえば、値が **TimedMetadataKind.ImageSubtitle** であるメタデータ トラックについては **CueEntered** イベントに登録し、値が **TimedMetadataKind.Speech** であるトラックについては登録しないことを選択できます。</span><span class="sxs-lookup"><span data-stu-id="514ee-123">So, for example, you could choose to register for the **CueEntered** event for metadata tracks that have the value **TimedMetadataKind.ImageSubtitle**, but not for tracks that have the value **TimedMetadataKind.Speech**.</span></span> <span data-ttu-id="514ee-124">この代わりに、すべての種類のメタデータ トラックのハンドラーを登録し、**CueEntered** ハンドラー内で **TimedMetadataKind** の値を確認して、キューへの応答で実行するアクションを決定することもできます。</span><span class="sxs-lookup"><span data-stu-id="514ee-124">Or instead, you could register a handler for all metadata track types and then check the **TimedMetadataKind** value inside the **CueEntered** handler to determine what action to take in response to the cue.</span></span>

## <a name="image-based-subtitles"></a><span data-ttu-id="514ee-125">画像ベースの字幕</span><span class="sxs-lookup"><span data-stu-id="514ee-125">Image-based subtitles</span></span>
<span data-ttu-id="514ee-126">Windows 10 Version 1703 以降では、UWP アプリで、VobSub 形式の外部の画像ベースの字幕をサポートできます。</span><span class="sxs-lookup"><span data-stu-id="514ee-126">Starting with Windows 10, version 1703, UWP apps can support external image-based subtitles in VobSub format.</span></span> <span data-ttu-id="514ee-127">この機能を使用するには、最初に、画像の字幕を表示するメディア コンテンツの [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-127">To use this feature, first create a [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) object for the media content for which image subtitles will be displayed.</span></span> <span data-ttu-id="514ee-128">次に、[**CreateFromUriWithIndex**](https://docs.microsoft.com/uwp/api/windows.media.core.timedtextsource.CreateFromUriWithIndex) または [**CreateFromStreamWithIndex**](https://docs.microsoft.com/uwp/api/windows.media.core.timedtextsource.CreateFromStreamWithIndex) を呼び出し、字幕の画像データを含む .sub ファイルと、字幕のタイミング情報を含む .idx ファイルの Uri を渡して、[**TimedTextSource**](https://docs.microsoft.com/uwp/api/windows.media.core.timedtextsource) オブジェクトを作成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-128">Next, create a [**TimedTextSource**](https://docs.microsoft.com/uwp/api/windows.media.core.timedtextsource) object by calling [**CreateFromUriWithIndex**](https://docs.microsoft.com/uwp/api/windows.media.core.timedtextsource.CreateFromUriWithIndex) or [**CreateFromStreamWithIndex**](https://docs.microsoft.com/uwp/api/windows.media.core.timedtextsource.CreateFromStreamWithIndex), passing in the Uri of the .sub file containing the subtitle image data and the .idx file containing the timing information for the subtitles.</span></span> <span data-ttu-id="514ee-129">**TimedTextSource** をソースの [**ExternalTimedTextSources**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.ExternalTimedTextSources) コレクションに追加することにより、**MediaSource** に追加します。</span><span class="sxs-lookup"><span data-stu-id="514ee-129">Add the **TimedTextSource** to the **MediaSource** by adding it to the source's [**ExternalTimedTextSources**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.ExternalTimedTextSources) collection.</span></span> <span data-ttu-id="514ee-130">**MediaSource** から [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) を作成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-130">Create a [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) from the **MediaSource**.</span></span>

[!code-cs[ImageSubtitleLoadContent](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetImageSubtitleLoadContent)]

<span data-ttu-id="514ee-131">前の手順で作成された **MediaPlaybackItem** オブジェクトを使用して、画像字幕メタデータ イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-131">Register for the image subtitle metadata events using the **MediaPlaybackItem** object created in the previous step.</span></span> <span data-ttu-id="514ee-132">この例では、ヘルパー メソッド **RegisterMetadataHandlerForImageSubtitles** を使用して、イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-132">This example uses a helper method, **RegisterMetadataHandlerForImageSubtitles**, to register for the events.</span></span> <span data-ttu-id="514ee-133">ラムダ式を使用して、[**TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) イベントのハンドラーを実装します。このイベントは、システムが **MediaPlaybackItem** に関連付けられたメタデータ トラック内の変更を検出したときに発生します。</span><span class="sxs-lookup"><span data-stu-id="514ee-133">A lambda expression is used to implement a handler for the [**TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) event, which occurs when the system detects a change in the metadata tracks associated with a **MediaPlaybackItem**.</span></span> <span data-ttu-id="514ee-134">状況によっては、再生項目が最初に解決されたときにメタデータ トラックが利用可能な場合があるため、**TimedMetadataTracksChanged** ハンドラーの外部でも、利用可能なメタデータ トラックをループ処理し、**RegisterMetadataHandlerForImageSubtitles** を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="514ee-134">In some cases, the metadata tracks may be available when the playback item is initially resolved, so outside of the **TimedMetadataTracksChanged** handler, we also loop through the available metadata tracks and call **RegisterMetadataHandlerForImageSubtitles**.</span></span>

[!code-cs[ImageSubtitleTracksChanged](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetImageSubtitleTracksChanged)]

<span data-ttu-id="514ee-135">画像字幕メタデータ イベントに登録した後、[**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement) 内で再生するために、**MediaItem** が [**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) に割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="514ee-135">After registering for the image subtitle metadata events, the **MediaItem** is assigned to a [**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) for playback within a [**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement).</span></span>

[!code-cs[ImageSubtitlePlay](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetImageSubtitlePlay)]

<span data-ttu-id="514ee-136">**RegisterMetadataHandlerForImageSubtitles** ヘルパー メソッドで、**MediaPlaybackItem** の **TimedMetadataTracks** コレクション内のインデックスを指定して、[**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) クラスのインスタンスを取得します。</span><span class="sxs-lookup"><span data-stu-id="514ee-136">In the **RegisterMetadataHandlerForImageSubtitles** helper method, get an instance of the [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) class by indexing into the **TimedMetadataTracks** collection of the **MediaPlaybackItem**.</span></span> <span data-ttu-id="514ee-137">[**CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) イベントと [**CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-137">Register for the [**CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) event and the [**CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) event.</span></span> <span data-ttu-id="514ee-138">次に、再生項目の **TimedMetadataTracks** コレクションで [**SetPresentationMode**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacktimedmetadatatracklist.SetPresentationMode) を呼び出して、アプリでこの再生項目のメタデータ キュー イベントを受信する必要があることをシステムに指示します。</span><span class="sxs-lookup"><span data-stu-id="514ee-138">Then, you must call [**SetPresentationMode**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacktimedmetadatatracklist.SetPresentationMode) on the playback item's **TimedMetadataTracks** collection, to instruct the system that the app wants to receive metadata cue events for this playback item.</span></span>

[!code-cs[RegisterMetadataHandlerForImageSubtitles](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetRegisterMetadataHandlerForImageSubtitles)]

<span data-ttu-id="514ee-139">**CueEntered** イベントのハンドラーで、ハンドラーに渡された [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) オブジェクトの [**TimedMetadataKind**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.TimedMetadataKind) プロパティを調べて、メタデータが画像字幕用であるかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="514ee-139">In the handler for the **CueEntered** event, you can check the [**TimedMetadataKind**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.TimedMetadataKind) propery of the [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) object passed into the handler to see if the metadata is for image subtitles.</span></span> <span data-ttu-id="514ee-140">これは、複数の種類のメタデータについて、同じデータ キュー イベント ハンドラーを使っている場合に必要です。</span><span class="sxs-lookup"><span data-stu-id="514ee-140">This is necessary if you are using the same data cue event handler for multiple types of metadata.</span></span> <span data-ttu-id="514ee-141">関連付けられたメタデータ トラックが **TimedMetadataKind.ImageSubtitle** 型である場合は、[**MediaCueEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.core.mediacueeventargs) の **Cue** プロパティに格納されているデータ キューを、[**ImageCue**](https://docs.microsoft.com/uwp/api/windows.media.core.imagecue) にキャストします。</span><span class="sxs-lookup"><span data-stu-id="514ee-141">If the associated metadata track is of type **TimedMetadataKind.ImageSubtitle**, cast the data cue contained in the **Cue** property of the [**MediaCueEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.core.mediacueeventargs) to an [**ImageCue**](https://docs.microsoft.com/uwp/api/windows.media.core.imagecue).</span></span> <span data-ttu-id="514ee-142">**ImageCue** の [**SoftwareBitmap**](https://docs.microsoft.com/uwp/api/windows.media.core.imagecue.SoftwareBitmap) プロパティには、字幕画像の [**SoftwareBitmap**](https://docs.microsoft.com/uwp/api/windows.graphics.imaging.softwarebitmap) 表現が格納されています。</span><span class="sxs-lookup"><span data-stu-id="514ee-142">The [**SoftwareBitmap**](https://docs.microsoft.com/uwp/api/windows.media.core.imagecue.SoftwareBitmap) property of the **ImageCue** contains a [**SoftwareBitmap**](https://docs.microsoft.com/uwp/api/windows.graphics.imaging.softwarebitmap) representation of the subtitle image.</span></span> <span data-ttu-id="514ee-143">[**SoftwareBitmapSource**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.media.imaging.softwarebitmapsource) を作成し、[**SetBitmapAsync**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.media.imaging.softwarebitmapsource.SetBitmapAsync) を呼び出して、画像を XAML [**Image**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.image) コントロールに割り当てます。</span><span class="sxs-lookup"><span data-stu-id="514ee-143">Create a [**SoftwareBitmapSource**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.media.imaging.softwarebitmapsource) and call [**SetBitmapAsync**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.media.imaging.softwarebitmapsource.SetBitmapAsync) to assign the image to a XAML [**Image**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.image) control.</span></span> <span data-ttu-id="514ee-144">**ImageCue** の [**Extent**](https://docs.microsoft.com/uwp/api/windows.media.core.imagecue.Extent) プロパティと [**Position**](https://docs.microsoft.com/uwp/api/windows.media.core.imagecue.Position) プロパティは、字幕画像のサイズと位置に関する情報を提供します。</span><span class="sxs-lookup"><span data-stu-id="514ee-144">The [**Extent**](https://docs.microsoft.com/uwp/api/windows.media.core.imagecue.Extent) and [**Position**](https://docs.microsoft.com/uwp/api/windows.media.core.imagecue.Position) properties of the **ImageCue** provide information about the size and position of the subtitle image.</span></span>

[!code-cs[ImageSubtitleCueEntered](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetImageSubtitleCueEntered)]

## <a name="speech-cues"></a><span data-ttu-id="514ee-145">音声キュー</span><span class="sxs-lookup"><span data-stu-id="514ee-145">Speech cues</span></span>
<span data-ttu-id="514ee-146">Windows 10 Version 1703 以降では、UWP アプリで、再生されるメディアの単語の境界、文の境界、音声合成マークアップ言語 (SSML) ブックマークに応答するイベントの受信を登録できます。</span><span class="sxs-lookup"><span data-stu-id="514ee-146">Starting with Windows 10, version 1703, UWP apps can register to receive events in response to word boundaries, sentence boundaries, and Speech Synthesis Markup Language (SSML) bookmarks in played media.</span></span> <span data-ttu-id="514ee-147">これによって、[**SpeechSynthesizer**](https://docs.microsoft.com/uwp/api/Windows.Media.SpeechSynthesis.SpeechSynthesizer) クラスを使用して生成されたオーディオ ストリームを再生し、現在再生中の単語や文のテキストを表示するなど、これらのイベントに基づいて UI を更新できます。</span><span class="sxs-lookup"><span data-stu-id="514ee-147">This allows you to play audio streams generated with the [**SpeechSynthesizer**](https://docs.microsoft.com/uwp/api/Windows.Media.SpeechSynthesis.SpeechSynthesizer) class and update your UI based on these events, such as displaying the text of the currently playing word or sentence.</span></span>

<span data-ttu-id="514ee-148">このセクションに示した例では、クラス メンバー変数を使用して、合成および再生されるテキスト文字列を格納します。</span><span class="sxs-lookup"><span data-stu-id="514ee-148">The example shown in this section uses a class member variable to store a text string that will be synthesized and played back.</span></span>

[!code-cs[SpeechInputText](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetSpeechInputText)]

<span data-ttu-id="514ee-149">**SpeechSynthesizer** クラスの新しいインスタンスを作成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-149">Create a new instance of the **SpeechSynthesizer** class.</span></span> <span data-ttu-id="514ee-150">シンセサイザーの [**IncludeWordBoundaryMetadata**](https://docs.microsoft.com/uwp/api/windows.media.speechsynthesis.speechsynthesizeroptions.IncludeWordBoundaryMetadata) オプションと [**IncludeSentenceBoundaryMetadata**](https://docs.microsoft.com/uwp/api/windows.media.speechsynthesis.speechsynthesizeroptions.IncludeSentenceBoundaryMetadata) オプションを **true** に設定して、生成されたメディア ストリームにメタデータを含める必要があることを指定します。</span><span class="sxs-lookup"><span data-stu-id="514ee-150">Set the [**IncludeWordBoundaryMetadata**](https://docs.microsoft.com/uwp/api/windows.media.speechsynthesis.speechsynthesizeroptions.IncludeWordBoundaryMetadata) and [**IncludeSentenceBoundaryMetadata**](https://docs.microsoft.com/uwp/api/windows.media.speechsynthesis.speechsynthesizeroptions.IncludeSentenceBoundaryMetadata) options for the synthesizer to **true** to specify that the metadata should be included in the generated media stream.</span></span> <span data-ttu-id="514ee-151">[**SynthesizeTextToStreamAsync**](https://docs.microsoft.com/uwp/api/Windows.Media.SpeechSynthesis.SpeechSynthesizer.SynthesizeTextToStreamAsync) を呼び出して、合成された音声と対応するメタデータを含むストリームを生成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-151">Call [**SynthesizeTextToStreamAsync**](https://docs.microsoft.com/uwp/api/Windows.Media.SpeechSynthesis.SpeechSynthesizer.SynthesizeTextToStreamAsync) to generate a stream containing the synthesized speech and corresponding metadata.</span></span> <span data-ttu-id="514ee-152">合成されたストリームから [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) と [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) を作成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-152">Create a [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) and a [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) from the synthesized stream.</span></span>

[!code-cs[SynthesizeSpeech](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetSynthesizeSpeech)]

<span data-ttu-id="514ee-153">**MediaPlaybackItem** オブジェクトを使って音声メタデータ イベントを登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-153">Register for the speech metadata events using the **MediaPlaybackItem** object.</span></span> <span data-ttu-id="514ee-154">この例では、ヘルパー メソッド **RegisterMetadataHandlerForSpeech** を使用して、イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-154">This example uses a helper method, **RegisterMetadataHandlerForSpeech**, to register for the events.</span></span> <span data-ttu-id="514ee-155">ラムダ式を使用して、[**TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) イベントのハンドラーを実装します。このイベントは、システムが **MediaPlaybackItem** に関連付けられたメタデータ トラック内の変更を検出したときに発生します。</span><span class="sxs-lookup"><span data-stu-id="514ee-155">A lambda expression is used to implement a handler for the [**TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) event, which occurs when the system detects a change in the metadata tracks associated with a **MediaPlaybackItem**.</span></span>  <span data-ttu-id="514ee-156">状況によっては、再生項目が最初に解決されたときにメタデータ トラックが利用可能な場合があるため、**TimedMetadataTracksChanged** ハンドラーの外部でも、利用可能なメタデータ トラックをループ処理し、**RegisterMetadataHandlerForSpeech** を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="514ee-156">In some cases, the metadata tracks may be available when the playback item is initially resolved, so outside of the **TimedMetadataTracksChanged** handler, we also loop through the available metadata tracks and call **RegisterMetadataHandlerForSpeech**.</span></span>

[!code-cs[SpeechTracksChanged](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetSpeechTracksChanged)]

<span data-ttu-id="514ee-157">音声メタデータ イベントに登録した後、[**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement) 内で再生するために、**MediaItem** が [**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) に割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="514ee-157">After registering for the speech metadata events, the **MediaItem** is assigned to a [**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) for playback within a [**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement).</span></span>

[!code-cs[SpeechPlay](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetSpeechPlay)]

<span data-ttu-id="514ee-158">**RegisterMetadataHandlerForSpeech** ヘルパー メソッドで、**MediaPlaybackItem** の **TimedMetadataTracks** コレクション内のインデックスを指定して、[**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) クラスのインスタンスを取得します。</span><span class="sxs-lookup"><span data-stu-id="514ee-158">In the **RegisterMetadataHandlerForSpeech** helper method, get an instance of the [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) class by indexing into the **TimedMetadataTracks** collection of the **MediaPlaybackItem**.</span></span> <span data-ttu-id="514ee-159">[**CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) イベントと [**CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-159">Register for the [**CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) event and the [**CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) event.</span></span> <span data-ttu-id="514ee-160">次に、再生項目の **TimedMetadataTracks** コレクションで [**SetPresentationMode**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacktimedmetadatatracklist.SetPresentationMode) を呼び出して、アプリでこの再生項目のメタデータ キュー イベントを受信する必要があることをシステムに指示します。</span><span class="sxs-lookup"><span data-stu-id="514ee-160">Then, you must call [**SetPresentationMode**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacktimedmetadatatracklist.SetPresentationMode) on the playback item's **TimedMetadataTracks** collection, to instruct the system that the app wants to receive metadata cue events for this playback item.</span></span>

[!code-cs[RegisterMetadataHandlerForWords](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetRegisterMetadataHandlerForWords)]

<span data-ttu-id="514ee-161">**CueEntered** イベントのハンドラーで、ハンドラーに渡された [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) オブジェクトの [**TimedMetadataKind**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.TimedMetadataKind) プロパティを調べて、メタデータが音声用であるかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="514ee-161">In the handler for the **CueEntered** event, you can check the [**TimedMetadataKind**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.TimedMetadataKind) propery of the [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) object passed into the handler to see if the metadata is speech.</span></span> <span data-ttu-id="514ee-162">これは、複数の種類のメタデータについて、同じデータ キュー イベント ハンドラーを使っている場合に必要です。</span><span class="sxs-lookup"><span data-stu-id="514ee-162">This is necessary if you are using the same data cue event handler for multiple types of metadata.</span></span> <span data-ttu-id="514ee-163">関連付けられたメタデータ トラックが **TimedMetadataKind.Speech** 型である場合は、[**MediaCueEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.core.mediacueeventargs) の **Cue** プロパティに格納されているデータ キューを、[**SpeechCue**](https://docs.microsoft.com/uwp/api/windows.media.core.speechcue) にキャストします。</span><span class="sxs-lookup"><span data-stu-id="514ee-163">If the associated metadata track is of type **TimedMetadataKind.Speech**, cast the data cue contained in the **Cue** property of the [**MediaCueEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.core.mediacueeventargs) to a [**SpeechCue**](https://docs.microsoft.com/uwp/api/windows.media.core.speechcue).</span></span> <span data-ttu-id="514ee-164">音声キューの場合、メタデータ トラックに含まれている音声キューの種類は、**Label** プロパティを調べることによって特定されます。</span><span class="sxs-lookup"><span data-stu-id="514ee-164">For speech cues, the type of speech cue included in the metadata track is determined by checking the **Label** property.</span></span> <span data-ttu-id="514ee-165">このプロパティの値は、単語の境界の場合は "SpeechWord"、文の境界の場合は "SpeechSentence"、SSML ブックマークの場合は "SpeechBookmark" になります。</span><span class="sxs-lookup"><span data-stu-id="514ee-165">The value of this property will be "SpeechWord" for word boundaries, "SpeechSentence" for sentence boundaries, or "SpeechBookmark" for SSML bookmarks.</span></span> <span data-ttu-id="514ee-166">この例では、"SpeechWord" 値を検索し、この値が見つかった場合、**SpeechCue** の [**StartPositionInInput**](https://docs.microsoft.com/uwp/api/windows.media.core.speechcue.StartPositionInInput) プロパティと [**EndPositionInInput**](https://docs.microsoft.com/uwp/api/windows.media.core.speechcue.EndPositionInInput) プロパティを使用して、現在再生中の単語の入力テキスト内の場所を特定します。</span><span class="sxs-lookup"><span data-stu-id="514ee-166">In this example, we check for the "SpeechWord" value, and if this value is found, the [**StartPositionInInput**](https://docs.microsoft.com/uwp/api/windows.media.core.speechcue.StartPositionInInput) and [**EndPositionInInput**](https://docs.microsoft.com/uwp/api/windows.media.core.speechcue.EndPositionInInput) properties of the **SpeechCue** are used to determine location within the input text of the word currently being played back.</span></span> <span data-ttu-id="514ee-167">この例では、単にデバッグ出力に各単語を出力します。</span><span class="sxs-lookup"><span data-stu-id="514ee-167">This example simply outputs each word to the debug output.</span></span>

[!code-cs[SpeechWordCueEntered](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetSpeechWordCueEntered)]

## <a name="chapter-cues"></a><span data-ttu-id="514ee-168">チャプター キュー</span><span class="sxs-lookup"><span data-stu-id="514ee-168">Chapter cues</span></span>
<span data-ttu-id="514ee-169">Windows 10 Version 1703 以降では、UWP アプリはメディア項目内のチャプターに対応するキューに登録できます。</span><span class="sxs-lookup"><span data-stu-id="514ee-169">Starting with Windows 10, version 1703, UWP apps can register for cues that correspond to chapters within a media item.</span></span> <span data-ttu-id="514ee-170">この機能を使用するには、メディア コンテキストの [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) オブジェクトを作成し、**MediaSource** から [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) を作成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-170">To use this feature, create a [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) object for the media content and then create a [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) from the **MediaSource**.</span></span>

[!code-cs[ChapterCueLoadContent](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetChapterCueLoadContent)]

<span data-ttu-id="514ee-171">前の手順で作成された **MediaPlaybackItem** オブジェクトを使用して、チャプター メタデータ イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-171">Register for the chapter metadata events using the **MediaPlaybackItem** object created in the previous step.</span></span> <span data-ttu-id="514ee-172">この例では、ヘルパー メソッド **RegisterMetadataHandlerForChapterCues** を使用して、イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-172">This example uses a helper method, **RegisterMetadataHandlerForChapterCues**, to register for the events.</span></span> <span data-ttu-id="514ee-173">ラムダ式を使用して、[**TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) イベントのハンドラーを実装します。このイベントは、システムが **MediaPlaybackItem** に関連付けられたメタデータ トラック内の変更を検出したときに発生します。</span><span class="sxs-lookup"><span data-stu-id="514ee-173">A lambda expression is used to implement a handler for the [**TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) event, which occurs when the system detects a change in the metadata tracks associated with a **MediaPlaybackItem**.</span></span> <span data-ttu-id="514ee-174">状況によっては、再生項目が最初に解決されたときにメタデータ トラックが利用可能な場合があるため、**TimedMetadataTracksChanged** ハンドラーの外部でも、利用可能なメタデータ トラックをループ処理し、**RegisterMetadataHandlerForChapterCues** を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="514ee-174">In some cases, the metadata tracks may be available when the playback item is initially resolved, so outside of the **TimedMetadataTracksChanged** handler, we also loop through the available metadata tracks and call **RegisterMetadataHandlerForChapterCues**.</span></span>

[!code-cs[ChapterCueTracksChanged](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetChapterCueTracksChanged)]

<span data-ttu-id="514ee-175">チャプター メタデータ イベントに登録した後、[**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement) 内で再生するために、**MediaItem** が [**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) に割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="514ee-175">After registering for the chapter metadata events, the **MediaItem** is assigned to a [**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) for playback within a [**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement).</span></span>

[!code-cs[ChapterCuePlay](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetChapterCuePlay)]

<span data-ttu-id="514ee-176">**RegisterMetadataHandlerForChapterCues** ヘルパー メソッドで、**MediaPlaybackItem** の **TimedMetadataTracks** コレクション内のインデックスを指定して、[**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) クラスのインスタンスを取得します。</span><span class="sxs-lookup"><span data-stu-id="514ee-176">In the **RegisterMetadataHandlerForChapterCues** helper method, get an instance of the [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) class by indexing into the **TimedMetadataTracks** collection of the **MediaPlaybackItem**.</span></span> <span data-ttu-id="514ee-177">[**CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) イベントと [**CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-177">Register for the [**CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) event and the [**CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) event.</span></span> <span data-ttu-id="514ee-178">次に、再生項目の **TimedMetadataTracks** コレクションで [**SetPresentationMode**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacktimedmetadatatracklist.SetPresentationMode) を呼び出して、アプリでこの再生項目のメタデータ キュー イベントを受信する必要があることをシステムに指示します。</span><span class="sxs-lookup"><span data-stu-id="514ee-178">Then, you must call [**SetPresentationMode**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacktimedmetadatatracklist.SetPresentationMode) on the playback item's **TimedMetadataTracks** collection, to instruct the system that the app wants to receive metadata cue events for this playback item.</span></span>

[!code-cs[RegisterMetadataHandlerForChapterCues](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetRegisterMetadataHandlerForChapterCues)]

<span data-ttu-id="514ee-179">**CueEntered** イベントのハンドラーで、ハンドラーに渡された [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) オブジェクトの [**TimedMetadataKind**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.TimedMetadataKind) プロパティを調べて、メタデータがチャプター キュー用であるかどうかを確認します。これは、複数の種類のメタデータについて、同じデータ キュー イベント ハンドラーを使っている場合に必要です。</span><span class="sxs-lookup"><span data-stu-id="514ee-179">In the handler for the **CueEntered** event, you can check the [**TimedMetadataKind**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.TimedMetadataKind) propery of the [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) object passed into the handler to see if the metadata is for chapter cues. This is necessary if you are using the same data cue event handler for multiple types of metadata.</span></span> <span data-ttu-id="514ee-180">関連付けられたメタデータ トラックが **TimedMetadataKind.Chapter** 型である場合は、[**MediaCueEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.core.mediacueeventargs) の **Cue** プロパティに格納されているデータ キューを、[**ChapterCue**](https://docs.microsoft.com/uwp/api/windows.media.core.chaptercue) にキャストします。</span><span class="sxs-lookup"><span data-stu-id="514ee-180">If the associated metadata track is of type **TimedMetadataKind.Chapter**, cast the data cue contained in the **Cue** property of the [**MediaCueEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.core.mediacueeventargs) to an [**ChapterCue**](https://docs.microsoft.com/uwp/api/windows.media.core.chaptercue).</span></span> <span data-ttu-id="514ee-181">**ChapterCue** の [**Title**](https://docs.microsoft.com/uwp/api/windows.media.core.chaptercue.Title) プロパティには、再生中に到達したチャプターのタイトルが含まれています。</span><span class="sxs-lookup"><span data-stu-id="514ee-181">The [**Title**](https://docs.microsoft.com/uwp/api/windows.media.core.chaptercue.Title) property of the **ChapterCue** contains the title of the chapter that has just been reached in playback.</span></span>

[!code-cs[ChapterCueEntered](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetChapterCueEntered)]

### <a name="seek-to-the-next-chapter-using-chapter-cues"></a><span data-ttu-id="514ee-182">チャプター キューを使用して、次のチャプターをシークします。</span><span class="sxs-lookup"><span data-stu-id="514ee-182">Seek to the next chapter using chapter cues</span></span>
<span data-ttu-id="514ee-183">再生中の項目内で現在のチャプターが変更されたときに通知を受け取るだけでなく、チャプター キューを使用して、再生中の項目内の次のチャプターをシークすることもできます。</span><span class="sxs-lookup"><span data-stu-id="514ee-183">In addition to receiving notifications when the current chapter changes in a playing item, you can also use chapter cues to seek to the next chapter within a playing item.</span></span> <span data-ttu-id="514ee-184">次に示す例のメソッドでは、引数として、[**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) と、現在再生中のメディア項目を表す [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) を受け取ります。</span><span class="sxs-lookup"><span data-stu-id="514ee-184">The example method shown below takes as arguments a [**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) and a [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) representing the currently playing media item.</span></span> <span data-ttu-id="514ee-185">[**TimedMetadataTracks**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracks) コレクションを検索して、いずれかのトラックで、[**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) の [**TimedMetadataKind**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.TimedMetadataKind) プロパティの値が **TimedMetadataKind.Chapter** であるかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="514ee-185">The [**TimedMetadataTracks**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracks) collection is searched to see if any of the tracks have [**TimedMetadataKind**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.TimedMetadataKind) propery of the [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) value of **TimedMetadataKind.Chapter**.</span></span>  <span data-ttu-id="514ee-186">チャプター トラックが見つかった場合、メソッドはトラックの [**Cues**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.Cues) コレクション内で各キューをループ処理し、[**StartTime**](https://docs.microsoft.com/uwp/api/windows.media.core.chaptercue.StartTime) がメディア プレーヤーの再生セッションの現在の [**Position**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacksession.Position) よりも大きい最初のキューを見つけます。</span><span class="sxs-lookup"><span data-stu-id="514ee-186">If a chapter track is found, the method loops through each cue in the track's [**Cues**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.Cues) collection to find the first cue that has a [**StartTime**](https://docs.microsoft.com/uwp/api/windows.media.core.chaptercue.StartTime) greater than the current [**Position**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacksession.Position) of the media player's playback session.</span></span> <span data-ttu-id="514ee-187">適切なキューが見つかったら、再生セッションの位置が更新され、UI でチャプター タイトルが更新されます。</span><span class="sxs-lookup"><span data-stu-id="514ee-187">Once the correct cue is found, the position of the playback session is updated and the chapter title is updated in the UI.</span></span>

[!code-cs[GoToNextChapter](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetGoToNextChapter)]

## <a name="extended-m3u-comments"></a><span data-ttu-id="514ee-188">Extended M3U コメント</span><span class="sxs-lookup"><span data-stu-id="514ee-188">Extended M3U comments</span></span>
<span data-ttu-id="514ee-189">Windows 10 Version 1703 以降では、UWP アプリは、Extended M3U マニフェスト ファイル内のコメントに対応するキューに登録できます。</span><span class="sxs-lookup"><span data-stu-id="514ee-189">Starting with Windows 10, version 1703, UWP apps can register for cues that correspond to comments within a Extended M3U manifest file.</span></span> <span data-ttu-id="514ee-190">この例では、[**AdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource) を使用してメディア コンテンツを再生します。</span><span class="sxs-lookup"><span data-stu-id="514ee-190">This example uses [**AdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource) to play the media content.</span></span> <span data-ttu-id="514ee-191">詳しくは、「[アダプティブ ストリーミング](adaptive-streaming.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="514ee-191">For more information, see [Adaptive Streaming](adaptive-streaming.md).</span></span> <span data-ttu-id="514ee-192">[**CreateFromUriAsync**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.CreateFromUriAsync) または [**CreateFromStreamAsync**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.CreateFromStreamAsync) を呼び出すことによって、コンテンツの **AdaptiveMediaSource** を作成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-192">Create an **AdaptiveMediaSource** for the content by calling [**CreateFromUriAsync**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.CreateFromUriAsync) or [**CreateFromStreamAsync**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.CreateFromStreamAsync).</span></span> <span data-ttu-id="514ee-193">[**CreateFromAdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.CreateFromAdaptiveMediaSource) を呼び出して [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) オブジェクトを作成し、**MediaSource** から [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) を作成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-193">Create a  [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) object by calling [**CreateFromAdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.CreateFromAdaptiveMediaSource) and then create a [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) from the **MediaSource**.</span></span>

[!code-cs[EXTM3ULoadContent](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetEXTM3ULoadContent)]

<span data-ttu-id="514ee-194">前の手順で作成された **MediaPlaybackItem** オブジェクトを使用して、M3U メタデータ イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-194">Register for the M3U metadata events using the **MediaPlaybackItem** object created in the previous step.</span></span> <span data-ttu-id="514ee-195">この例では、ヘルパー メソッド **RegisterMetadataHandlerForEXTM3UCues** を使用して、イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-195">This example uses a helper method, **RegisterMetadataHandlerForEXTM3UCues**, to register for the events.</span></span> <span data-ttu-id="514ee-196">ラムダ式を使用して、[**TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) イベントのハンドラーを実装します。このイベントは、システムが **MediaPlaybackItem** に関連付けられたメタデータ トラック内の変更を検出したときに発生します。</span><span class="sxs-lookup"><span data-stu-id="514ee-196">A lambda expression is used to implement a handler for the [**TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) event, which occurs when the system detects a change in the metadata tracks associated with a **MediaPlaybackItem**.</span></span> <span data-ttu-id="514ee-197">状況によっては、再生項目が最初に解決されたときにメタデータ トラックが利用可能な場合があるため、**TimedMetadataTracksChanged** ハンドラーの外部でも、利用可能なメタデータ トラックをループ処理し、**RegisterMetadataHandlerForEXTM3UCues** を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="514ee-197">In some cases, the metadata tracks may be available when the playback item is initially resolved, so outside of the **TimedMetadataTracksChanged** handler, we also loop through the available metadata tracks and call **RegisterMetadataHandlerForEXTM3UCues**.</span></span>

[!code-cs[EXTM3UCueTracksChanged](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetEXTM3UCueTracksChanged)]

<span data-ttu-id="514ee-198">M3U メタデータ イベントに登録した後、[**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement) 内で再生するために、**MediaItem** が [**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) に割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="514ee-198">After registering for the M3U metadata events, the **MediaItem** is assigned to a [**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) for playback within a [**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement).</span></span>

[!code-cs[EXTM3UCuePlay](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetEXTM3UCuePlay)]

<span data-ttu-id="514ee-199">**RegisterMetadataHandlerForEXTM3UCues** ヘルパー メソッドで、**MediaPlaybackItem** の **TimedMetadataTracks** コレクション内のインデックスを指定して、[**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) クラスのインスタンスを取得します。</span><span class="sxs-lookup"><span data-stu-id="514ee-199">In the **RegisterMetadataHandlerForEXTM3UCues** helper method, get an instance of the [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) class by indexing into the **TimedMetadataTracks** collection of the **MediaPlaybackItem**.</span></span> <span data-ttu-id="514ee-200">メタデータ トラックの DispatchType プロパティを確認します。トラックが M3U コメントを表す場合、この値は "EXTM3U" になります。</span><span class="sxs-lookup"><span data-stu-id="514ee-200">Check the DispatchType property of the metadata track, which will have a value of "EXTM3U" if the track represents M3U comments.</span></span> <span data-ttu-id="514ee-201">[**CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) イベントと [**CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-201">Register for the [**CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) event and the [**CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) event.</span></span> <span data-ttu-id="514ee-202">次に、再生項目の **TimedMetadataTracks** コレクションで [**SetPresentationMode**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacktimedmetadatatracklist.SetPresentationMode) を呼び出して、アプリでこの再生項目のメタデータ キュー イベントを受信する必要があることをシステムに指示します。</span><span class="sxs-lookup"><span data-stu-id="514ee-202">Then, you must call [**SetPresentationMode**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacktimedmetadatatracklist.SetPresentationMode) on the playback item's **TimedMetadataTracks** collection, to instruct the system that the app wants to receive metadata cue events for this playback item.</span></span>

[!code-cs[RegisterMetadataHandlerForEXTM3UCues](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetRegisterMetadataHandlerForEXTM3UCues)]

<span data-ttu-id="514ee-203">**CueEntered** イベントのハンドラーで、[**MediaCueEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.core.mediacueeventargs) の **Cue** プロパティに含まれるデータ キューを、[**DataCue**](https://docs.microsoft.com/uwp/api/windows.media.core.datacue) にキャストします。</span><span class="sxs-lookup"><span data-stu-id="514ee-203">In the handler for the **CueEntered** event, cast the data cue contained in the **Cue** property of the [**MediaCueEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.core.mediacueeventargs) to an [**DataCue**](https://docs.microsoft.com/uwp/api/windows.media.core.datacue).</span></span>  <span data-ttu-id="514ee-204">**DataCue** とキューの [**Data**](https://docs.microsoft.com/uwp/api/windows.media.core.datacue.Data) プロパティが null ではないことを確認します。</span><span class="sxs-lookup"><span data-stu-id="514ee-204">Check to make sure the **DataCue** and the [**Data**](https://docs.microsoft.com/uwp/api/windows.media.core.datacue.Data) property of the cue are not null.</span></span> <span data-ttu-id="514ee-205">Extended EMU コメントは、UTF-16、リトル エンディアン、null 終了文字列の形式で提供されます。</span><span class="sxs-lookup"><span data-stu-id="514ee-205">Extended EMU comments are provided in the form of UTF-16, little endian, null terminated strings.</span></span> <span data-ttu-id="514ee-206">新しい **DataReader** を作成し、[**DataReader.FromBuffer**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datareader.FromBuffer) を呼び出してキューのデータを読み取ります。</span><span class="sxs-lookup"><span data-stu-id="514ee-206">Create a new **DataReader** to read the cue data by calling [**DataReader.FromBuffer**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datareader.FromBuffer).</span></span> <span data-ttu-id="514ee-207">リーダーの [**UnicodeEncoding**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datareader.UnicodeEncoding) プロパティを [**Utf16LE**](https://docs.microsoft.com/uwp/api/windows.storage.streams.unicodeencoding) に設定して、正しい形式でデータを読み取ります。</span><span class="sxs-lookup"><span data-stu-id="514ee-207">Set the [**UnicodeEncoding**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datareader.UnicodeEncoding) property of the reader to [**Utf16LE**](https://docs.microsoft.com/uwp/api/windows.storage.streams.unicodeencoding) to read the data in the correct format.</span></span> <span data-ttu-id="514ee-208">**Data** フィールドの半分の長さを指定して、[**ReadString**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datareader.ReadString) を呼び出してデータを読み取ります。各文字は 2 バイトのサイズであるため、null 終端文字を削除するには、1を減算します。</span><span class="sxs-lookup"><span data-stu-id="514ee-208">Call [**ReadString**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datareader.ReadString) to read the data, specifying half of the length of the **Data** field, because each character is two bytes in size, and subtract one to remove the trailing null character.</span></span> <span data-ttu-id="514ee-209">この例では、M3U コメントは、単にデバッグ出力に書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="514ee-209">In this example, the M3U comment is simply written to the debug output.</span></span>

[!code-cs[EXTM3UCueEntered](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetEXTM3UCueEntered)]

## <a name="id3-tags"></a><span data-ttu-id="514ee-210">ID3 タグ</span><span class="sxs-lookup"><span data-stu-id="514ee-210">ID3 tags</span></span>
<span data-ttu-id="514ee-211">Windows 10 Version 1703 以降では、UWP アプリは、Http Live Streaming (HLS) コンテンツ内の ID3 タグに対応するキューに登録できます。</span><span class="sxs-lookup"><span data-stu-id="514ee-211">Starting with Windows 10, version 1703, UWP apps can register for cues that correspond to ID3 tags within Http Live Streaming (HLS) content.</span></span> <span data-ttu-id="514ee-212">この例では、[**AdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource) を使用してメディア コンテンツを再生します。</span><span class="sxs-lookup"><span data-stu-id="514ee-212">This example uses [**AdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource) to play the media content.</span></span> <span data-ttu-id="514ee-213">詳しくは、「[アダプティブ ストリーミング](adaptive-streaming.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="514ee-213">For more information, see [Adaptive Streaming](adaptive-streaming.md).</span></span> <span data-ttu-id="514ee-214">[**CreateFromUriAsync**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.CreateFromUriAsync) または [**CreateFromStreamAsync**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.CreateFromStreamAsync) を呼び出すことによって、コンテンツの **AdaptiveMediaSource** を作成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-214">Create an **AdaptiveMediaSource** for the content by calling [**CreateFromUriAsync**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.CreateFromUriAsync) or [**CreateFromStreamAsync**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.CreateFromStreamAsync).</span></span> <span data-ttu-id="514ee-215">[**CreateFromAdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.CreateFromAdaptiveMediaSource) を呼び出して [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) オブジェクトを作成し、**MediaSource** から [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) を作成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-215">Create a  [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) object by calling [**CreateFromAdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.CreateFromAdaptiveMediaSource) and then create a [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) from the **MediaSource**.</span></span>

[!code-cs[EXTM3ULoadContent](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetEXTM3ULoadContent)]

<span data-ttu-id="514ee-216">前の手順で作成された **MediaPlaybackItem** オブジェクトを使用して、ID3 タグ イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-216">Register for the ID3 tag events using the **MediaPlaybackItem** object created in the previous step.</span></span> <span data-ttu-id="514ee-217">この例では、ヘルパー メソッド **RegisterMetadataHandlerForID3Cues** を使用して、イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-217">This example uses a helper method, **RegisterMetadataHandlerForID3Cues**, to register for the events.</span></span> <span data-ttu-id="514ee-218">ラムダ式を使用して、[**TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) イベントのハンドラーを実装します。このイベントは、システムが **MediaPlaybackItem** に関連付けられたメタデータ トラック内の変更を検出したときに発生します。</span><span class="sxs-lookup"><span data-stu-id="514ee-218">A lambda expression is used to implement a handler for the [**TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) event, which occurs when the system detects a change in the metadata tracks associated with a **MediaPlaybackItem**.</span></span> <span data-ttu-id="514ee-219">状況によっては、再生項目が最初に解決されたときにメタデータ トラックが利用可能な場合があるため、**TimedMetadataTracksChanged** ハンドラーの外部でも、利用可能なメタデータ トラックをループ処理し、**RegisterMetadataHandlerForID3Cues** を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="514ee-219">In some cases, the metadata tracks may be available when the playback item is initially resolved, so outside of the **TimedMetadataTracksChanged** handler, we also loop through the available metadata tracks and call **RegisterMetadataHandlerForID3Cues**.</span></span>

[!code-cs[ID3LoadContent](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetID3LoadContent)]

<span data-ttu-id="514ee-220">ID3 メタデータ イベントに登録した後、[**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement) 内で再生するために、**MediaItem** が [**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) に割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="514ee-220">After registering for the ID3 metadata events, the **MediaItem** is assigned to a [**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) for playback within a [**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement).</span></span>

[!code-cs[ID3CuePlay](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetID3CuePlay)]


<span data-ttu-id="514ee-221">**RegisterMetadataHandlerForID3Cues** ヘルパー メソッドで、**MediaPlaybackItem** の **TimedMetadataTracks** コレクション内のインデックスを指定して、[**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) クラスのインスタンスを取得します。</span><span class="sxs-lookup"><span data-stu-id="514ee-221">In the **RegisterMetadataHandlerForID3Cues** helper method, get an instance of the [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) class by indexing into the **TimedMetadataTracks** collection of the **MediaPlaybackItem**.</span></span> <span data-ttu-id="514ee-222">メタデータ トラックの DispatchType プロパティを確認します。トラックが ID3 タグを表す場合、GUID 文字列 "15260DFFFF49443320FF49443320000F" を含む値になります。</span><span class="sxs-lookup"><span data-stu-id="514ee-222">Check the DispatchType property of the metadata track, which will have a value containing the GUID string "15260DFFFF49443320FF49443320000F" if the track represents ID3 tags.</span></span> <span data-ttu-id="514ee-223">[**CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) イベントと [**CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-223">Register for the [**CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) event and the [**CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) event.</span></span> <span data-ttu-id="514ee-224">次に、再生項目の **TimedMetadataTracks** コレクションで [**SetPresentationMode**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacktimedmetadatatracklist.SetPresentationMode) を呼び出して、アプリでこの再生項目のメタデータ キュー イベントを受信する必要があることをシステムに指示します。</span><span class="sxs-lookup"><span data-stu-id="514ee-224">Then, you must call [**SetPresentationMode**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacktimedmetadatatracklist.SetPresentationMode) on the playback item's **TimedMetadataTracks** collection, to instruct the system that the app wants to receive metadata cue events for this playback item.</span></span>

[!code-cs[RegisterMetadataHandlerForID3Cues](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetRegisterMetadataHandlerForID3Cues)]

<span data-ttu-id="514ee-225">**CueEntered** イベントのハンドラーで、[**MediaCueEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.core.mediacueeventargs) の **Cue** プロパティに含まれるデータ キューを、[**DataCue**](https://docs.microsoft.com/uwp/api/windows.media.core.datacue) にキャストします。</span><span class="sxs-lookup"><span data-stu-id="514ee-225">In the handler for the **CueEntered** event, cast the data cue contained in the **Cue** property of the [**MediaCueEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.core.mediacueeventargs) to an [**DataCue**](https://docs.microsoft.com/uwp/api/windows.media.core.datacue).</span></span>  <span data-ttu-id="514ee-226">**DataCue** とキューの [**Data**](https://docs.microsoft.com/uwp/api/windows.media.core.datacue.Data) プロパティが null ではないことを確認します。</span><span class="sxs-lookup"><span data-stu-id="514ee-226">Check to make sure the **DataCue** and the [**Data**](https://docs.microsoft.com/uwp/api/windows.media.core.datacue.Data) property of the cue are not null.</span></span> <span data-ttu-id="514ee-227">Extended EMU コメントは、トランスポート ストリーム内の未加工のバイトの形式で提供されます ([http://id3.org/id3v2.4.0-structure](http://id3.org/id3v2.4.0-structure) をご覧ください)。</span><span class="sxs-lookup"><span data-stu-id="514ee-227">Extended EMU comments are provided in the form raw bytes in the transport stream (see [http://id3.org/id3v2.4.0-structure](http://id3.org/id3v2.4.0-structure)).</span></span> <span data-ttu-id="514ee-228">新しい **DataReader** を作成し、[**DataReader.FromBuffer**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datareader.FromBuffer) を呼び出してキューのデータを読み取ります。</span><span class="sxs-lookup"><span data-stu-id="514ee-228">Create a new **DataReader** to read the cue data by calling [**DataReader.FromBuffer**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datareader.FromBuffer).</span></span>  <span data-ttu-id="514ee-229">この例では、ID3 タグのヘッダー値が、キュー データから読み取られ、デバッグ出力に書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="514ee-229">In this example, the header values from the ID3 tag are read from the cue data and written to the debug output.</span></span>

[!code-cs[ID3CueEntered](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetID3CueEntered)]

## <a name="fragmented-mp4-emsg-boxes"></a><span data-ttu-id="514ee-230">Fragmented mp4 emsg ボックス</span><span class="sxs-lookup"><span data-stu-id="514ee-230">Fragmented mp4 emsg boxes</span></span>
<span data-ttu-id="514ee-231">Windows 10 Version 1703 以降では、UWP アプリは、Fragmented mp4 ストリームの emsg ボックスに対応するキューに登録できます。</span><span class="sxs-lookup"><span data-stu-id="514ee-231">Starting with Windows 10, version 1703, UWP apps can register for cues that correspond to emsg boxes within fragmented mp4 streams.</span></span> <span data-ttu-id="514ee-232">この種類のメタデータの使用例として、コンテンツのライブ ストリーミング中に広告を再生することをクライアント アプリケーションに通知するコンテンツ プロバイダーがあります。</span><span class="sxs-lookup"><span data-stu-id="514ee-232">An example usage of this type of metadata is for content providers to signal client applications to play an ad during live streaming content.</span></span> <span data-ttu-id="514ee-233">この例では、[**AdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource) を使用してメディア コンテンツを再生します。</span><span class="sxs-lookup"><span data-stu-id="514ee-233">This example uses [**AdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource) to play the media content.</span></span> <span data-ttu-id="514ee-234">詳しくは、「[アダプティブ ストリーミング](adaptive-streaming.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="514ee-234">For more information, see [Adaptive Streaming](adaptive-streaming.md).</span></span> <span data-ttu-id="514ee-235">[**CreateFromUriAsync**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.CreateFromUriAsync) または [**CreateFromStreamAsync**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.CreateFromStreamAsync) を呼び出すことによって、コンテンツの **AdaptiveMediaSource** を作成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-235">Create an **AdaptiveMediaSource** for the content by calling [**CreateFromUriAsync**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.CreateFromUriAsync) or [**CreateFromStreamAsync**](https://docs.microsoft.com/uwp/api/windows.media.streaming.adaptive.adaptivemediasource.CreateFromStreamAsync).</span></span> <span data-ttu-id="514ee-236">[**CreateFromAdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.CreateFromAdaptiveMediaSource) を呼び出して [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) オブジェクトを作成し、**MediaSource** から [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) を作成します。</span><span class="sxs-lookup"><span data-stu-id="514ee-236">Create a  [**MediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource) object by calling [**CreateFromAdaptiveMediaSource**](https://docs.microsoft.com/uwp/api/windows.media.core.mediasource.CreateFromAdaptiveMediaSource) and then create a [**MediaPlaybackItem**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem) from the **MediaSource**.</span></span>

[!code-cs[EmsgLoadContent](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetEmsgLoadContent)]

<span data-ttu-id="514ee-237">前の手順で作成された **MediaPlaybackItem** オブジェクトを使用して、emsg ボックス イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-237">Register for the emsg box events using the **MediaPlaybackItem** object created in the previous step.</span></span> <span data-ttu-id="514ee-238">この例では、ヘルパー メソッド **RegisterMetadataHandlerForEmsgCues** を使用して、イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-238">This example uses a helper method, **RegisterMetadataHandlerForEmsgCues**, to register for the events.</span></span> <span data-ttu-id="514ee-239">ラムダ式を使用して、[**TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) イベントのハンドラーを実装します。このイベントは、システムが **MediaPlaybackItem** に関連付けられたメタデータ トラック内の変更を検出したときに発生します。</span><span class="sxs-lookup"><span data-stu-id="514ee-239">A lambda expression is used to implement a handler for the [**TimedMetadataTracksChanged**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybackitem.TimedMetadataTracksChanged) event, which occurs when the system detects a change in the metadata tracks associated with a **MediaPlaybackItem**.</span></span> <span data-ttu-id="514ee-240">状況によっては、再生項目が最初に解決されたときにメタデータ トラックが利用可能な場合があるため、**TimedMetadataTracksChanged** ハンドラーの外部でも、利用可能なメタデータ トラックをループ処理し、**RegisterMetadataHandlerForEmsgCues** を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="514ee-240">In some cases, the metadata tracks may be available when the playback item is initially resolved, so outside of the **TimedMetadataTracksChanged** handler, we also loop through the available metadata tracks and call **RegisterMetadataHandlerForEmsgCues**.</span></span>

[!code-cs[ID3LoadContent](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetID3LoadContent)]

<span data-ttu-id="514ee-241">emsg ボックス メタデータ イベントに登録した後、[**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement) 内で再生するために、**MediaItem** が [**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) に割り当てられます。</span><span class="sxs-lookup"><span data-stu-id="514ee-241">After registering for the emsg box metadata events, the **MediaItem** is assigned to a [**MediaPlayer**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplayer) for playback within a [**MediaPlayerElement**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.controls.mediaplayerelement).</span></span>

[!code-cs[EmsgCuePlay](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetEmsgCuePlay)]


<span data-ttu-id="514ee-242">**RegisterMetadataHandlerForEmsgCues** ヘルパー メソッドで、**MediaPlaybackItem** の **TimedMetadataTracks** コレクション内のインデックスを指定して、[**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) クラスのインスタンスを取得します。</span><span class="sxs-lookup"><span data-stu-id="514ee-242">In the **RegisterMetadataHandlerForEmsgCues** helper method, get an instance of the [**TimedMetadataTrack**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack) class by indexing into the **TimedMetadataTracks** collection of the **MediaPlaybackItem**.</span></span> <span data-ttu-id="514ee-243">メタデータ トラックの DispatchType プロパティを確認します。トラックが emsg ボックスを表す場合、この値は "emsg:mp4" になります。</span><span class="sxs-lookup"><span data-stu-id="514ee-243">Check the DispatchType property of the metadata track, which will have a value of "emsg:mp4" if the track represents emsg boxes.</span></span> <span data-ttu-id="514ee-244">[**CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) イベントと [**CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) イベントに登録します。</span><span class="sxs-lookup"><span data-stu-id="514ee-244">Register for the [**CueEntered**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueEntered) event and the [**CueExited**](https://docs.microsoft.com/uwp/api/windows.media.core.timedmetadatatrack.CueExited) event.</span></span> <span data-ttu-id="514ee-245">次に、再生項目の **TimedMetadataTracks** コレクションで [**SetPresentationMode**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacktimedmetadatatracklist.SetPresentationMode) を呼び出して、アプリでこの再生項目のメタデータ キュー イベントを受信する必要があることをシステムに指示します。</span><span class="sxs-lookup"><span data-stu-id="514ee-245">Then, you must call [**SetPresentationMode**](https://docs.microsoft.com/uwp/api/windows.media.playback.mediaplaybacktimedmetadatatracklist.SetPresentationMode) on the playback item's **TimedMetadataTracks** collection, to instruct the system that the app wants to receive metadata cue events for this playback item.</span></span>


[!code-cs[RegisterMetadataHandlerForEmsgCues](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetRegisterMetadataHandlerForEmsgCues)]


<span data-ttu-id="514ee-246">**CueEntered** イベントのハンドラーで、[**MediaCueEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.core.mediacueeventargs) の **Cue** プロパティに含まれるデータ キューを、[**DataCue**](https://docs.microsoft.com/uwp/api/windows.media.core.datacue) にキャストします。</span><span class="sxs-lookup"><span data-stu-id="514ee-246">In the handler for the **CueEntered** event, cast the data cue contained in the **Cue** property of the [**MediaCueEventArgs**](https://docs.microsoft.com/uwp/api/windows.media.core.mediacueeventargs) to an [**DataCue**](https://docs.microsoft.com/uwp/api/windows.media.core.datacue).</span></span>  <span data-ttu-id="514ee-247">**DataCue** オブジェクトが null でないことを確認します。</span><span class="sxs-lookup"><span data-stu-id="514ee-247">Check to make sure the **DataCue** object is not null.</span></span> <span data-ttu-id="514ee-248">emsg ボックスのプロパティは、メディア パイプラインによって、DataCue オブジェクトの [**Properties**](https://docs.microsoft.com/uwp/api/windows.media.core.datacue.Properties) コレクション内のカスタム プロパティとして提供されます。</span><span class="sxs-lookup"><span data-stu-id="514ee-248">The properies of the emsg box are provided by the media pipeline as custom properties in the DataCue object's [**Properties**](https://docs.microsoft.com/uwp/api/windows.media.core.datacue.Properties) collection.</span></span> <span data-ttu-id="514ee-249">この例では、**[TryGetValue](https://docs.microsoft.com/uwp/api/windows.foundation.collections.propertyset.trygetvalue)** メソッドを使用して、複数の異なるプロパティ値の抽出を試行します。</span><span class="sxs-lookup"><span data-stu-id="514ee-249">This example attempts to extract several different property values using the **[TryGetValue](https://docs.microsoft.com/uwp/api/windows.foundation.collections.propertyset.trygetvalue)** method.</span></span> <span data-ttu-id="514ee-250">このメソッドが null を返す場合、要求したプロパティが emsg ボックス内に存在しないことを意味するため、代わりに既定値が設定されます。</span><span class="sxs-lookup"><span data-stu-id="514ee-250">If this method returns null, it means the requested propery is not present in the emsg box, so a default value is set instead.</span></span>

<span data-ttu-id="514ee-251">この例の次の部分は、広告の再生がトリガーされるがシナリオを示しています。これに該当するのは、前の手順で取得した *scheme_id_uri* プロパティの値が "urn:scte:scte35:2013:xml" である場合です ([http://dashif.org/identifiers/event-schemes/](http://dashif.org/identifiers/event-schemes/) をご覧ください)。</span><span class="sxs-lookup"><span data-stu-id="514ee-251">The next part of the example illustrates the scenario where ad playback is triggered, which is the case when the *scheme_id_uri* property, obtained in the previous step, has a value of "urn:scte:scte35:2013:xml" (see [http://dashif.org/identifiers/event-schemes/](http://dashif.org/identifiers/event-schemes/)).</span></span> <span data-ttu-id="514ee-252">標準では、冗長性のために、この emsg を複数回送信することを推奨しているため、この例では、処理済みの emsg ID のリストを保持し、新しいメッセージのみを処理していることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="514ee-252">Note that the standard recommends sending this emsg multiple times for redundancy, so this example maintains a list of the emsg IDs that have already been processed and only processes new messages.</span></span> <span data-ttu-id="514ee-253">[**DataReader.FromBuffer**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datareader.FromBuffer) を呼び出してキュー データを読み取る新しい **DataReader** を作成し、[**UnicodeEncoding**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datareader.UnicodeEncoding) プロパティを設定してエンコードを UTF-8 に設定した後、データを読み取ります。</span><span class="sxs-lookup"><span data-stu-id="514ee-253">Create a new **DataReader** to read the cue data by calling [**DataReader.FromBuffer**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datareader.FromBuffer) and set the encoding to UTF-8 by setting the [**UnicodeEncoding**](https://docs.microsoft.com/uwp/api/windows.storage.streams.datareader.UnicodeEncoding) property, then read the data.</span></span> <span data-ttu-id="514ee-254">この例では、メッセージ ペイロードがデバッグ出力に書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="514ee-254">In this example, the message payload is written to the debug output.</span></span> <span data-ttu-id="514ee-255">実際のアプリは、ペイロード データを使用して広告の再生をスケジュールします。</span><span class="sxs-lookup"><span data-stu-id="514ee-255">A real app would use the payload data to schedule the playback of an ad.</span></span>

[!code-cs[EmsgCueEntered](./code/MediaSource_RS1/cs/MainPage_Cues.xaml.cs#SnippetEmsgCueEntered)]


## <a name="related-topics"></a><span data-ttu-id="514ee-256">関連トピック</span><span class="sxs-lookup"><span data-stu-id="514ee-256">Related topics</span></span>

* [<span data-ttu-id="514ee-257">メディア再生</span><span class="sxs-lookup"><span data-stu-id="514ee-257">Media playback</span></span>](media-playback.md)
* [<span data-ttu-id="514ee-258">メディア項目、プレイリスト、トラック</span><span class="sxs-lookup"><span data-stu-id="514ee-258">Media items, playlists, and tracks</span></span>](media-playback-with-mediasource.md)


 




