---
ms.assetid: af3941c0-3508-4ba2-a79e-fc71657c605f
description: この記事では、写真とビデオをキャプチャするときに、ヘルパー クラスを使ってデバイスの向きを処理する方法について説明します。
title: MediaCapture を使ってデバイスの向きを処理する
ms.date: 02/08/2017
ms.topic: article
keywords: windows 10, uwp
ms.localizationpriority: medium
ms.openlocfilehash: 8554a50a7bca54aa2acca5129dc140995d7b3527
ms.sourcegitcommit: ac7f3422f8d83618f9b6b5615a37f8e5c115b3c4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/29/2019
ms.locfileid: "66361749"
---
# <a name="handle-device-orientation-with-mediacapture"></a><span data-ttu-id="38583-104">MediaCapture を使ってデバイスの向きを処理する</span><span class="sxs-lookup"><span data-stu-id="38583-104">Handle device orientation with MediaCapture</span></span>
<span data-ttu-id="38583-105">アプリ外での表示を目的とする写真やビデオ (ユーザーのデバイスにファイルを保存する場合や、オンラインで共有する場合など) をアプリでキャプチャする際は、別のアプリやデバイスで画像を表示するときに正しい向きで表示されるよう、適切な向きのメタデータを使って画像をエンコーディングすることが重要です。</span><span class="sxs-lookup"><span data-stu-id="38583-105">When your app captures a photo or video that is intended to be viewed outside of your app, such as saving to a file on the user's device or sharing online, it's important that you encode the image with the proper orientation metadata so that when another app or device displays the image, it is oriented correctly.</span></span> <span data-ttu-id="38583-106">メディア ファイルにどの向きのデータを含めれば良いか特定するのは複雑な作業です。これは、デバイス シャーシの向き、ディスプレイの向き、シャーシ上のカメラの位置 (全面カメラか背面カメラか) など、考慮すべき変数が複数あるためです。</span><span class="sxs-lookup"><span data-stu-id="38583-106">Determining the correct orientation data to include in a media file can be a complex task because there are several variables to consider, including the orientation of the device chassis, the orientation of the display, and the placement of the camera on the chassis (whether it is a front or back-facing camera).</span></span> 

<span data-ttu-id="38583-107">そこで、向きの処理のプロセスを簡略化するために、**CameraRotationHelper** というヘルパー クラスを使うことをお勧めします。完全な定義についてはこの記事の最後に記載しています。</span><span class="sxs-lookup"><span data-stu-id="38583-107">To simplify the process of handling orientation, we recommend using a helper class, **CameraRotationHelper**, for which the full definition is provided at the end of this article.</span></span> <span data-ttu-id="38583-108">このクラスをプロジェクトに追加し、本記事の手順に従えば、カメラ アプリに向きのサポートを追加することができます。</span><span class="sxs-lookup"><span data-stu-id="38583-108">You can add this class to your project and then follow the steps in this article to add orientation support to your camera app.</span></span> <span data-ttu-id="38583-109">また、このヘルパー クラスによって、カメラ UI のコントロールの回転が容易になり、ユーザーの視点から正しくレンダリングされるようになります。</span><span class="sxs-lookup"><span data-stu-id="38583-109">The helper class also makes it easier for you to rotate the controls in your camera UI so that they are rendered correctly from the user's point of view.</span></span>

> [!NOTE] 
> <span data-ttu-id="38583-110">この記事の内容は、「[**MediaCapture を使った基本的な写真、ビデオ、およびオーディオのキャプチャ**](basic-photo-video-and-audio-capture-with-mediacapture.md)」で取り上げたコードや概念に基づいています。</span><span class="sxs-lookup"><span data-stu-id="38583-110">This article builds on the code and concepts discussed in the article [**Basic photo, video, and audio capture with MediaCapture**](basic-photo-video-and-audio-capture-with-mediacapture.md).</span></span> <span data-ttu-id="38583-111">**MediaCapture** クラスの使用についての基本概念を理解してから、向きのサポートをアプリに追加することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="38583-111">We recommend that you familiarize yourself with the basic concepts of using the **MediaCapture** class before adding orientation support to your app.</span></span>

## <a name="namespaces-used-in-this-article"></a><span data-ttu-id="38583-112">この記事で使われている名前空間</span><span class="sxs-lookup"><span data-stu-id="38583-112">Namespaces used in this article</span></span>
<span data-ttu-id="38583-113">この記事のコード例では、次の名前空間の API を使っています。自分でコードを記述する際はこれらを含める必要があります。</span><span class="sxs-lookup"><span data-stu-id="38583-113">The example code in this article uses APIs from the following namespaces that you should include in your code.</span></span> 

[!code-cs[OrientationUsing](./code/SimpleCameraPreview_Win10/cs/MainPage.xaml.cs#SnippetOrientationUsing)]

<span data-ttu-id="38583-114">アプリに向きのサポートを追加するにはまず、ディスプレイをロックして、デバイスの回転時にディスプレイが自動的に回転しないようにします。</span><span class="sxs-lookup"><span data-stu-id="38583-114">The first step in adding orientation support to your app is to lock the display so that it doesn't automatically rotate when the device is rotated.</span></span> <span data-ttu-id="38583-115">UI の自動回転はほとんどの種類のアプリに適していますが、カメラ プレビューについては、回転するとユーザーが操作しにくくなります。</span><span class="sxs-lookup"><span data-stu-id="38583-115">Automatic UI rotation works well for most types of apps, but it is unintuitive for users when the camera preview rotates.</span></span> <span data-ttu-id="38583-116">[  **DisplayInformation.AutoRotationPreferences**](https://docs.microsoft.com/uwp/api/windows.graphics.display.displayinformation.autorotationpreferences) プロパティを [**DisplayOrientations.Landscape**](https://docs.microsoft.com/uwp/api/Windows.Graphics.Display.DisplayOrientations) に設定してディスプレイの向きをロックします。</span><span class="sxs-lookup"><span data-stu-id="38583-116">Lock the display orientation by setting the [**DisplayInformation.AutoRotationPreferences**](https://docs.microsoft.com/uwp/api/windows.graphics.display.displayinformation.autorotationpreferences) property to [**DisplayOrientations.Landscape**](https://docs.microsoft.com/uwp/api/Windows.Graphics.Display.DisplayOrientations).</span></span> 

[!code-cs[AutoRotationPreference](./code/SimpleCameraPreview_Win10/cs/MainPage.xaml.cs#SnippetAutoRotationPreference)]

## <a name="tracking-the-camera-device-location"></a><span data-ttu-id="38583-117">カメラ デバイスの位置情報を追跡する</span><span class="sxs-lookup"><span data-stu-id="38583-117">Tracking the camera device location</span></span>
<span data-ttu-id="38583-118">キャプチャしたメディアの正しい向きを計算するには、シャーシ上のカメラ デバイスの位置情報をアプリで特定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="38583-118">To calculate the correct orientation for captured media, you app must determine the location of the camera device on the chassis.</span></span> <span data-ttu-id="38583-119">ブール値メンバー変数を追加して、(USB 接続型 Web カメラなどのように) カメラがデバイスの外部にあるかどうかを追跡します。</span><span class="sxs-lookup"><span data-stu-id="38583-119">Add a boolean member variable to track whether the camera is external to the device, such as a USB web cam.</span></span> <span data-ttu-id="38583-120">プレビューを左右反転すべきかどうかを追跡するための別のブール変数を追加します。左右反転は、正面カメラが使われている場合に必要になります。</span><span class="sxs-lookup"><span data-stu-id="38583-120">Add another boolean variable to track whether the preview should be mirrored, which is the case if a front-facing camera is used.</span></span> <span data-ttu-id="38583-121">また、選択されたカメラを表す **DeviceInformation** オブジェクトを格納するための変数を追加します。</span><span class="sxs-lookup"><span data-stu-id="38583-121">Also, add a variable for storing a **DeviceInformation** object that represents the selected camera.</span></span>

[!code-cs[CameraDeviceLocationBools](./code/SimpleCameraPreview_Win10/cs/MainPage.xaml.cs#SnippetCameraDeviceLocationBools)]
[!code-cs[DeclareCameraDevice](./code/SimpleCameraPreview_Win10/cs/MainPage.xaml.cs#SnippetDeclareCameraDevice)]

## <a name="select-a-camera-device-and-initialize-the-mediacapture-object"></a><span data-ttu-id="38583-122">カメラ デバイスを選択し MediaCapture オブジェクトを初期化する</span><span class="sxs-lookup"><span data-stu-id="38583-122">Select a camera device and initialize the MediaCapture object</span></span>
<span data-ttu-id="38583-123">「[**MediaCapture を使った基本的な写真、ビデオ、およびオーディオのキャプチャ**](basic-photo-video-and-audio-capture-with-mediacapture.md)」では、数行のコードで **MediaCapture** オブジェクトを初期化する方法について説明しています。</span><span class="sxs-lookup"><span data-stu-id="38583-123">The article [**Basic photo, video, and audio capture with MediaCapture**](basic-photo-video-and-audio-capture-with-mediacapture.md) shows you how to initialize the **MediaCapture** object with just a couple of lines of code.</span></span> <span data-ttu-id="38583-124">カメラの向きをサポートするために、少しだけこの初期化プロセスに手順を追加します。</span><span class="sxs-lookup"><span data-stu-id="38583-124">To support camera orientation, we will add a few more steps to the initialization process.</span></span>

<span data-ttu-id="38583-125">まず、[**DeviceClass.VideoCapture**](https://docs.microsoft.com/uwp/api/Windows.Devices.Enumeration.DeviceClass) というデバイス セレクターを渡して [**DeviceInformation.FindAllAsync**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.deviceinformation.findallasync) を呼び出し、利用可能なすべてのビデオ キャプチャ デバイスの一覧を取得します。</span><span class="sxs-lookup"><span data-stu-id="38583-125">First, call [**DeviceInformation.FindAllAsync**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.deviceinformation.findallasync) passing in the device selector [**DeviceClass.VideoCapture**](https://docs.microsoft.com/uwp/api/Windows.Devices.Enumeration.DeviceClass) to get a list of all available video capture devices.</span></span> <span data-ttu-id="38583-126">次に、カメラのパネル位置が認識されていて、かつ、指定した値とそのパネル位置が一致するものの中で、一覧の最も上にあるデバイスを選択します。この例では、正面カメラになります。</span><span class="sxs-lookup"><span data-stu-id="38583-126">Next, select the first device in the list where the panel location of the camera is known and where it matches the supplied value, which in this example is a front-facing camera.</span></span> <span data-ttu-id="38583-127">目的のパネルでカメラが見つからない場合は、先頭にあるカメラか、既定の利用可能なカメラが使用されます。</span><span class="sxs-lookup"><span data-stu-id="38583-127">If no camera is found on the desired panel, the first or default available camera is used.</span></span>

<span data-ttu-id="38583-128">カメラ デバイスが見つかった場合、新しい [**MediaCaptureInitializationSettings**](https://docs.microsoft.com/uwp/api/Windows.Media.Capture.MediaCaptureInitializationSettings) オブジェクトを作成し、選択したデバイスに [**VideoDeviceId**](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacaptureinitializationsettings.videodeviceid) プロパティを設定します。</span><span class="sxs-lookup"><span data-stu-id="38583-128">If a camera device is found, a new [**MediaCaptureInitializationSettings**](https://docs.microsoft.com/uwp/api/Windows.Media.Capture.MediaCaptureInitializationSettings) object is created and the [**VideoDeviceId**](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacaptureinitializationsettings.videodeviceid) property is set to the selected device.</span></span> <span data-ttu-id="38583-129">次に、MediaCapture オブジェクトを作成し、設定オブジェクトを渡して [**InitializeAsync**](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacapture.initializeasync) を呼び出し、選択したカメラを使うようシステムに指示します。</span><span class="sxs-lookup"><span data-stu-id="38583-129">Next, create the MediaCapture object and call [**InitializeAsync**](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacapture.initializeasync), passing in the settings object to tell the system to use the selected camera.</span></span>

<span data-ttu-id="38583-130">最後に、選択したデバイスのパネルが null または unknown になっているかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="38583-130">Finally, check to see if the selected device panel is null or unknown.</span></span> <span data-ttu-id="38583-131">このいずれかであれば、カメラは外付けのものなので、カメラの回転はデバイスの回転とは無関係ということになります。</span><span class="sxs-lookup"><span data-stu-id="38583-131">If so, the camera is external, which means that its rotation is unrelated to the rotation of the device.</span></span> <span data-ttu-id="38583-132">パネルが認識されていてデバイス シャーシの全面にある場合は、プレビューを左右反転する必要があるため、プレビューを追跡する変数を設定します。</span><span class="sxs-lookup"><span data-stu-id="38583-132">If the panel is known and is on the front of the device chassis, we know the preview should be mirrored, so the variable tracking this is set.</span></span>

[!code-cs[InitMediaCaptureWithOrientation](./code/SimpleCameraPreview_Win10/cs/MainPage.xaml.cs#SnippetInitMediaCaptureWithOrientation)]
## <a name="initialize-the-camerarotationhelper-class"></a><span data-ttu-id="38583-133">CameraRotationHelper クラスを初期化する</span><span class="sxs-lookup"><span data-stu-id="38583-133">Initialize the CameraRotationHelper class</span></span>

<span data-ttu-id="38583-134">ここから **CameraRotationHelper** クラスを使い始めます。</span><span class="sxs-lookup"><span data-stu-id="38583-134">Now we begin using the **CameraRotationHelper** class.</span></span> <span data-ttu-id="38583-135">オブジェクトを格納するためのクラス メンバー変数を宣言し、</span><span class="sxs-lookup"><span data-stu-id="38583-135">Declare a class member variable to store the object.</span></span> <span data-ttu-id="38583-136">選択されたカメラの筐体の位置を渡して、コンストラクターを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="38583-136">Call the constructor, passing in the enclosure location of the selected camera.</span></span> <span data-ttu-id="38583-137">このヘルパー クラスでは、この情報を使用して、キャプチャしたメディア、プレビュー ストリーム、および UI の正しい向きを計算します。</span><span class="sxs-lookup"><span data-stu-id="38583-137">The helper class uses this information to calculate the correct orientation for captured media, the preview stream, and the UI.</span></span> <span data-ttu-id="38583-138">そして、このヘルパー クラスの **OrientationChanged** イベントのハンドラーを登録します。このイベントは、UI やプレビュー ストリームの向きを更新する必要がある場合に発生します。</span><span class="sxs-lookup"><span data-stu-id="38583-138">Register a handler for the helper class's **OrientationChanged** event, which will be raised when we need to update the orientation of the UI or the preview stream.</span></span>

[!code-cs[DeclareRotationHelper](./code/SimpleCameraPreview_Win10/cs/MainPage.xaml.cs#SnippetDeclareRotationHelper)]

[!code-cs[InitRotationHelper](./code/SimpleCameraPreview_Win10/cs/MainPage.xaml.cs#SnippetInitRotationHelper)]

## <a name="add-orientation-data-to-the-camera-preview-stream"></a><span data-ttu-id="38583-139">カメラのプレビュー ストリームに向きのデータを追加する</span><span class="sxs-lookup"><span data-stu-id="38583-139">Add orientation data to the camera preview stream</span></span>
<span data-ttu-id="38583-140">プレビュー ストリームのメタデータに正しい向きを追加しても、ユーザーに表示されるプレビューには影響しませんが、プレビュー ストリームからキャプチャされるフレームをシステムが正しくエンコーディングしやすくなります。</span><span class="sxs-lookup"><span data-stu-id="38583-140">Adding the correct orientation to the metadata of the preview stream does not affect how the preview appears to the user, but it helps the system encode any frames captured from the preview stream correctly.</span></span>

<span data-ttu-id="38583-141">[  **MediaCapture.StartPreviewAsync**](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacapture.startpreviewasync) を呼び出してカメラ プレビューを開始します。</span><span class="sxs-lookup"><span data-stu-id="38583-141">You start the camera preview by calling [**MediaCapture.StartPreviewAsync**](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacapture.startpreviewasync).</span></span> <span data-ttu-id="38583-142">その前に、(正面カメラのために) プレビューを左右反転する必要があるかどうか、メンバー変数を確認してください。</span><span class="sxs-lookup"><span data-stu-id="38583-142">Before you do this, check the member variable to see if the preview should be mirrored (for a front-facing camera).</span></span> <span data-ttu-id="38583-143">左右反転する必要があれば、[**CaptureElement**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.Controls.CaptureElement) の [**FlowDirection**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.frameworkelement.flowdirection) プロパティ (この例では *PreviewControl* という名前になっています) を [**FlowDirection.RightToLeft**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.FlowDirection) に設定します。</span><span class="sxs-lookup"><span data-stu-id="38583-143">If so, set the [**FlowDirection**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.frameworkelement.flowdirection) property of the [**CaptureElement**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.Controls.CaptureElement), named *PreviewControl* in this example, to [**FlowDirection.RightToLeft**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.FlowDirection).</span></span> <span data-ttu-id="38583-144">プレビューを開始したら、**SetPreviewRotationAsync** というヘルパー メソッドを呼び出してプレビューの回転を設定します。</span><span class="sxs-lookup"><span data-stu-id="38583-144">After starting the preview, call the helper method **SetPreviewRotationAsync** to set the preview rotation.</span></span> <span data-ttu-id="38583-145">以下に、このメソッドの実装を示します。</span><span class="sxs-lookup"><span data-stu-id="38583-145">Following is the implementation of this method.</span></span>

[!code-cs[StartPreviewWithRotationAsync](./code/SimpleCameraPreview_Win10/cs/MainPage.xaml.cs#SnippetStartPreviewWithRotationAsync)]

<span data-ttu-id="38583-146">スマートフォンの向きが変わったときプレビュー ストリームを再初期化することなく更新できるように、プレビューの回転を別個のメソッドに設定します。</span><span class="sxs-lookup"><span data-stu-id="38583-146">We set the preview rotation in a separate method so that it can be updated when the phone orientation changes without reinitializing the preview stream.</span></span> <span data-ttu-id="38583-147">外付けのカメラの場合、処理は行われませんが、</span><span class="sxs-lookup"><span data-stu-id="38583-147">If the camera is external to the device, no action is taken.</span></span> <span data-ttu-id="38583-148">それ以外の場合は **CameraRotationHelper** メソッドの **GetCameraPreviewOrientation** が呼び出され、プレビュー ストリームの正しい向きが返されます。</span><span class="sxs-lookup"><span data-stu-id="38583-148">Otherwise, the **CameraRotationHelper** method **GetCameraPreviewOrientation** is called and returns the proper orientation for the preview stream.</span></span> 

<span data-ttu-id="38583-149">メタデータを設定するには [**VideoDeviceController.GetMediaStreamProperties**](https://docs.microsoft.com/uwp/api/windows.media.devices.videodevicecontroller.getmediastreamproperties) を呼び出して、プレビュー ストリームのプロパティを取得します。</span><span class="sxs-lookup"><span data-stu-id="38583-149">To set the metadata, the preview stream properties are retrieved by calling [**VideoDeviceController.GetMediaStreamProperties**](https://docs.microsoft.com/uwp/api/windows.media.devices.videodevicecontroller.getmediastreamproperties).</span></span> <span data-ttu-id="38583-150">次に、ビデオ ストリームの回転状態のメディア ファンデーション トランスフォーム (MFT) 属性を表す GUID を作成します。</span><span class="sxs-lookup"><span data-stu-id="38583-150">Next, create the GUID representing the Media Foundation Transform (MFT) attribute for video stream rotation.</span></span> <span data-ttu-id="38583-151">C++ では [**MF_MT_VIDEO_ROTATION**](https://docs.microsoft.com/windows/desktop/medfound/mf-mt-video-rotation) 定数を使用できますが、C# では GUID 値を手動で指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="38583-151">In C++ you can use the constant [**MF_MT_VIDEO_ROTATION**](https://docs.microsoft.com/windows/desktop/medfound/mf-mt-video-rotation), but in C# you must manually specify the GUID value.</span></span> 

<span data-ttu-id="38583-152">キーに GUID を、値にプレビューの回転を指定して、ストリーム プロパティ オブジェクトにプロパティ値を追加します。</span><span class="sxs-lookup"><span data-stu-id="38583-152">Add a property value to the stream properties object, specifying the GUID as the key and the preview rotation as the value.</span></span> <span data-ttu-id="38583-153">このプロパティは、値が反時計回りの角度の単位であることを想定しているため、単なる向きの値を変換するのに **CameraRotationHelper** メソッドの **ConvertSimpleOrientationToClockwiseDegrees** を使用します。</span><span class="sxs-lookup"><span data-stu-id="38583-153">This property expects values to be in units of counterclockwise degrees, so the **CameraRotationHelper** method **ConvertSimpleOrientationToClockwiseDegrees** is used to convert the simple orientation value.</span></span> <span data-ttu-id="38583-154">最後に、[**SetEncodingPropertiesAsync**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCapture.SetEncodingPropertiesAsync(Windows.Media.Capture.MediaStreamType,Windows.Media.MediaProperties.IMediaEncodingProperties,Windows.Media.MediaProperties.MediaPropertySet)) を呼び出して新しい回転プロパティをストリームに適用します。</span><span class="sxs-lookup"><span data-stu-id="38583-154">Finally, call [**SetEncodingPropertiesAsync**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCapture.SetEncodingPropertiesAsync(Windows.Media.Capture.MediaStreamType,Windows.Media.MediaProperties.IMediaEncodingProperties,Windows.Media.MediaProperties.MediaPropertySet)) to apply the new rotation property to the stream.</span></span>

[!code-cs[SetPreviewRotationAsync](./code/SimpleCameraPreview_Win10/cs/MainPage.xaml.cs#SnippetSetPreviewRotationAsync)]

<span data-ttu-id="38583-155">次に、**CameraRotationHelper.OrientationChanged** イベントのハンドラーを追加します。</span><span class="sxs-lookup"><span data-stu-id="38583-155">Next, add the handler for the **CameraRotationHelper.OrientationChanged** event.</span></span> <span data-ttu-id="38583-156">このイベントは、プレビュー ストリームが回転する必要があるかどうかを通知する引数を渡します。</span><span class="sxs-lookup"><span data-stu-id="38583-156">This event passes in an argument that lets you know whether the preview stream needs to be rotated.</span></span> <span data-ttu-id="38583-157">デバイスの向きが表向きまたは裏向きに変わった場合、この値は false になります。</span><span class="sxs-lookup"><span data-stu-id="38583-157">If the orientation of the device was changed to face up or face down, this value will be false.</span></span> <span data-ttu-id="38583-158">プレビューを回転する必要がある場合は、先ほど定義した **SetPreviewRotationAsync** を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="38583-158">If the preview does need to be rotated, call **SetPreviewRotationAsync** which was defined previously.</span></span>

<span data-ttu-id="38583-159">次に、**OrientationChanged** イベント ハンドラーで、必要に応じて UI を更新します。</span><span class="sxs-lookup"><span data-stu-id="38583-159">Next, in the **OrientationChanged** event handler, update your UI if needed.</span></span> <span data-ttu-id="38583-160">**GetUIOrientation** を呼び出して、現在推奨される UI の向きをヘルパー クラスから取得し、値を時計回りに変換します。この値は XAML の変換に使われます。</span><span class="sxs-lookup"><span data-stu-id="38583-160">Get the current recommended UI orientation from the helper class by calling **GetUIOrientation** and convert the value to clockwise degrees, which is used for XAML transforms.</span></span> <span data-ttu-id="38583-161">向きの値から [**RotateTransform**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.Media.RotateTransform) を作成し、XAML コントロールの [**RenderTransform**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.uielement.rendertransform) プロパティを設定します。</span><span class="sxs-lookup"><span data-stu-id="38583-161">Create a [**RotateTransform**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.Media.RotateTransform) from the orientation value and set the [**RenderTransform**](https://docs.microsoft.com/uwp/api/windows.ui.xaml.uielement.rendertransform) property of your XAML controls.</span></span> <span data-ttu-id="38583-162">UI レイアウトによっては、単なるコントロールの回転に加え、追加の調整が必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="38583-162">Depending on your UI layout, you may need to make additional adjustments here in addition to simply rotating the controls.</span></span> <span data-ttu-id="38583-163">また、UI へのすべての更新は UI スレッドで実行される必要があるため、このコードを [**RunAsync**](https://msdn.microsoft.com/library/windows/apps/Windows.UI.Core.CoreDispatcher.RunAsync(Windows.UI.Core.CoreDispatcherPriority,Windows.UI.Core.DispatchedHandler)) の呼び出しの中に配置する必要があることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="38583-163">Also, remember that all updates to your UI must be made on the UI thread, so you should place this code inside a call to [**RunAsync**](https://msdn.microsoft.com/library/windows/apps/Windows.UI.Core.CoreDispatcher.RunAsync(Windows.UI.Core.CoreDispatcherPriority,Windows.UI.Core.DispatchedHandler)).</span></span>  

[!code-cs[HelperOrientationChanged](./code/SimpleCameraPreview_Win10/cs/MainPage.xaml.cs#SnippetHelperOrientationChanged)]

## <a name="capture-a-photo-with-orientation-data"></a><span data-ttu-id="38583-164">向きのデータを使って写真をキャプチャする</span><span class="sxs-lookup"><span data-stu-id="38583-164">Capture a photo with orientation data</span></span>
<span data-ttu-id="38583-165">「[**MediaCapture を使った基本的な写真、ビデオ、およびオーディオのキャプチャ**](basic-photo-video-and-audio-capture-with-mediacapture.md)」では、写真をファイルにキャプチャする方法について説明しています。このためには、まず写真をインメモリ ストリームにキャプチャしたら、デコーダーを使ってストリームから画像データを読み取り、エンコーダーを使って画像データをファイルにコード変換します。</span><span class="sxs-lookup"><span data-stu-id="38583-165">The article [**Basic photo, video, and audio capture with MediaCapture**](basic-photo-video-and-audio-capture-with-mediacapture.md) shows you how to capture a photo to a file by capturing first to an in-memory stream and then using a decoder to read the image data from the stream and an encoder to transcode the image data to a file.</span></span> <span data-ttu-id="38583-166">**CameraRotationHelper** クラスから取得した向きのデータを、変換操作中に画像ファイルに追加することができます。</span><span class="sxs-lookup"><span data-stu-id="38583-166">Orientation data, obtained from the **CameraRotationHelper** class, can be added to the image file during the transcoding operation.</span></span>

<span data-ttu-id="38583-167">次の例では、[**CapturePhotoToStreamAsync**](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacapture.capturephototostreamasync) を呼び出すことで写真を [**InMemoryRandomAccessStream**](https://docs.microsoft.com/uwp/api/Windows.Storage.Streams.InMemoryRandomAccessStream) にキャプチャし、ストリームから [**BitmapDecoder**](https://docs.microsoft.com/uwp/api/Windows.Graphics.Imaging.BitmapDecoder) を作成しています。</span><span class="sxs-lookup"><span data-stu-id="38583-167">In the following example, a photo is captured to an [**InMemoryRandomAccessStream**](https://docs.microsoft.com/uwp/api/Windows.Storage.Streams.InMemoryRandomAccessStream) with a call to [**CapturePhotoToStreamAsync**](https://docs.microsoft.com/uwp/api/windows.media.capture.mediacapture.capturephototostreamasync) and a [**BitmapDecoder**](https://docs.microsoft.com/uwp/api/Windows.Graphics.Imaging.BitmapDecoder) is created from the stream.</span></span> <span data-ttu-id="38583-168">次に、[**StorageFile**](https://docs.microsoft.com/uwp/api/Windows.Storage.StorageFile) を作成して、ファイルに書き込む [**IRandomAccessStream**](https://docs.microsoft.com/uwp/api/Windows.Storage.Streams.IRandomAccessStream) を取得するために開きます。</span><span class="sxs-lookup"><span data-stu-id="38583-168">Next a [**StorageFile**](https://docs.microsoft.com/uwp/api/Windows.Storage.StorageFile) is created and opened to retreive an [**IRandomAccessStream**](https://docs.microsoft.com/uwp/api/Windows.Storage.Streams.IRandomAccessStream) for writing to the file.</span></span> 

<span data-ttu-id="38583-169">ファイルをコード変換する前に、**GetCameraCaptureOrientation** というヘルパー クラス メソッドから写真の向きを取得します。</span><span class="sxs-lookup"><span data-stu-id="38583-169">Before transcoding the file, the photo's orientation is retrieved from the helper class method **GetCameraCaptureOrientation**.</span></span> <span data-ttu-id="38583-170">このメソッドは、**ConvertSimpleOrientationToPhotoOrientation** というヘルパー メソッドによって [**PhotoOrientation**](https://docs.microsoft.com/uwp/api/Windows.Storage.FileProperties.PhotoOrientation) オブジェクトに変換される [**SimpleOrientation**](https://docs.microsoft.com/uwp/api/Windows.Devices.Sensors.SimpleOrientation) オブジェクトを返します。</span><span class="sxs-lookup"><span data-stu-id="38583-170">This method returns a [**SimpleOrientation**](https://docs.microsoft.com/uwp/api/Windows.Devices.Sensors.SimpleOrientation) object which is converted to a [**PhotoOrientation**](https://docs.microsoft.com/uwp/api/Windows.Storage.FileProperties.PhotoOrientation) object with the helper method **ConvertSimpleOrientationToPhotoOrientation**.</span></span> <span data-ttu-id="38583-171">次に、新しい **BitmapPropertySet** オブジェクトを作成し、キーが "System.Photo.Orientation" で、値が (**BitmapTypedValue** として表される) 写真の向きであるプロパティを追加します。</span><span class="sxs-lookup"><span data-stu-id="38583-171">Next, a new **BitmapPropertySet** object is created and a property is added where the key is "System.Photo.Orientation" and the value is the photo orientation, expressed as a **BitmapTypedValue**.</span></span> <span data-ttu-id="38583-172">"System.Photo.Orientation" は、メタデータとして画像ファイルに追加できる多くの Windows プロパティのうちの 1 つです。</span><span class="sxs-lookup"><span data-stu-id="38583-172">"System.Photo.Orientation" is one of many Windows properties that can be added as metadata to an image file.</span></span> <span data-ttu-id="38583-173">写真に関連するプロパティの全一覧については、「[**Windows プロパティ - 写真**](https://docs.microsoft.com/previous-versions//ff516600(v=vs.85))」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="38583-173">For a list of all of the photo-related properties, see [**Windows Properties - Photo**](https://docs.microsoft.com/previous-versions//ff516600(v=vs.85)).</span></span> <span data-ttu-id="38583-174">画像のメタデータの使い方について詳しくは、「[**画像のメタデータ**](image-metadata.md)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="38583-174">For more information about workine with metadata in images, see [**Image metadata**](image-metadata.md).</span></span>

<span data-ttu-id="38583-175">最後に、[**SetPropertiesAsync**](https://developer.microsoft.com/windows/apps/develop) を呼び出すことで、向きのデータを含むプロパティ セットをエンコーダーに設定し、[**FlushAsync**](https://docs.microsoft.com/uwp/api/windows.graphics.imaging.bitmapencoder.flushasync) を呼び出すことで、画像をコード変換します。</span><span class="sxs-lookup"><span data-stu-id="38583-175">Finally, the property set which includes the orientation data is set for the encoder by with a call to [**SetPropertiesAsync**](https://developer.microsoft.com/windows/apps/develop) and the image is transcoded with a call to [**FlushAsync**](https://docs.microsoft.com/uwp/api/windows.graphics.imaging.bitmapencoder.flushasync).</span></span>

[!code-cs[CapturePhotoWithOrientation](./code/SimpleCameraPreview_Win10/cs/MainPage.xaml.cs#SnippetCapturePhotoWithOrientation)]

## <a name="capture-a-video-with-orientation-data"></a><span data-ttu-id="38583-176">向きのデータを使ってビデオをキャプチャする</span><span class="sxs-lookup"><span data-stu-id="38583-176">Capture a video with orientation data</span></span>
<span data-ttu-id="38583-177">基本的なビデオ キャプチャについては、「[**MediaCapture を使った基本的な写真、ビデオ、およびオーディオのキャプチャ**](basic-photo-video-and-audio-capture-with-mediacapture.md)」で説明しています。</span><span class="sxs-lookup"><span data-stu-id="38583-177">Basic video capture is described in the article [**Basic photo, video, and audio capture with MediaCapture**](basic-photo-video-and-audio-capture-with-mediacapture.md).</span></span> <span data-ttu-id="38583-178">キャプチャしたビデオのエンコーディングに向きのデータを追加するには、向きのデータをプレビュー ストリームに追加するセクションで説明したのと同じ手法を用います。</span><span class="sxs-lookup"><span data-stu-id="38583-178">Adding orientation data to the encoding of the captured video is done using the same technique as described earlier in the section about adding orientation data to the preview stream.</span></span>

<span data-ttu-id="38583-179">次の例では、キャプチャしたビデオを書き込むファイルを作成します。</span><span class="sxs-lookup"><span data-stu-id="38583-179">In the following example, a file is created to which the captured video will be written.</span></span> <span data-ttu-id="38583-180">[  **CreateMp4**](https://docs.microsoft.com/uwp/api/windows.media.mediaproperties.mediaencodingprofile.createmp4) という静的メソッドを使用して、MP4 エンコード プロファイルを作成します。</span><span class="sxs-lookup"><span data-stu-id="38583-180">An MP4 encoding profile is create using the static method [**CreateMp4**](https://docs.microsoft.com/uwp/api/windows.media.mediaproperties.mediaencodingprofile.createmp4).</span></span> <span data-ttu-id="38583-181">ビデオの正しい向きは、**GetCameraCaptureOrientation** を呼び出すことで **CameraRotationHelper** クラスから取得します。回転プロパティでは、向きを反時計回りの角度で表す必要があるため、**ConvertSimpleOrientationToClockwiseDegrees** ヘルパー メソッドを呼び出して向きの値を変換します。</span><span class="sxs-lookup"><span data-stu-id="38583-181">The proper orientation for the video is obtained from the **CameraRotationHelper** class with a call to **GetCameraCaptureOrientation** Because the rotation property requires the orientation to be expressed in counterclockwise degrees, the **ConvertSimpleOrientationToClockwiseDegrees** helper method is called to convert the orientation value.</span></span> <span data-ttu-id="38583-182">次に、ビデオ ストリームの回転状態のメディア ファンデーション トランスフォーム (MFT) 属性を表す GUID を作成します。</span><span class="sxs-lookup"><span data-stu-id="38583-182">Next, create the GUID representing the Media Foundation Transform (MFT) attribute for video stream rotation.</span></span> <span data-ttu-id="38583-183">C++ では [**MF_MT_VIDEO_ROTATION**](https://docs.microsoft.com/windows/desktop/medfound/mf-mt-video-rotation) 定数を使用できますが、C# では GUID 値を手動で指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="38583-183">In C++ you can use the constant [**MF_MT_VIDEO_ROTATION**](https://docs.microsoft.com/windows/desktop/medfound/mf-mt-video-rotation), but in C# you must manually specify the GUID value.</span></span> <span data-ttu-id="38583-184">キーに GUID を、値に回転状態を指定して、ストリーム プロパティ オブジェクトにプロパティ値を追加します。</span><span class="sxs-lookup"><span data-stu-id="38583-184">Add a property value to the stream properties object, specifying the GUID as the key and the rotation as the value.</span></span> <span data-ttu-id="38583-185">最後に、[**StartRecordToStorageFileAsync**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCapture.StartRecordToStorageFileAsync(Windows.Media.MediaProperties.MediaEncodingProfile,Windows.Storage.IStorageFile)) を呼び出して、向きのデータによってエンコーディングされたビデオの録画を開始します。</span><span class="sxs-lookup"><span data-stu-id="38583-185">Finally call [**StartRecordToStorageFileAsync**](https://msdn.microsoft.com/library/windows/apps/Windows.Media.Capture.MediaCapture.StartRecordToStorageFileAsync(Windows.Media.MediaProperties.MediaEncodingProfile,Windows.Storage.IStorageFile)) to begin recording video encoded with orientation data.</span></span>

[!code-cs[StartRecordingWithOrientationAsync](./code/SimpleCameraPreview_Win10/cs/MainPage.xaml.cs#SnippetStartRecordingWithOrientationAsync)]

## <a name="camerarotationhelper-full-code-listing"></a><span data-ttu-id="38583-186">CameraRotationHelper の完全なコード</span><span class="sxs-lookup"><span data-stu-id="38583-186">CameraRotationHelper full code listing</span></span>
<span data-ttu-id="38583-187">以下のコード スニペットに、**CameraRotationHelper** クラスの完全なコードを示します。このクラスは、ハードウェアの方位センサーを管理したり、写真やビデオの正しい向きの値を計算したりします。また、各種 Windows 機能で使われる、向きのさまざまな表示間で変換を実行するヘルパー メソッドを提供します。</span><span class="sxs-lookup"><span data-stu-id="38583-187">The following code snippet lists the full code for the **CameraRotationHelper** class that manages the hardware orientation sensors, calculates the proper orientation values for photos and videos, and provides helper methods to convert between the different representations of orientation that are used by different Windows features.</span></span> <span data-ttu-id="38583-188">上記の記事の手順に従えば、変更を加えることなくプロジェクトにこのクラスを追加することができます。</span><span class="sxs-lookup"><span data-stu-id="38583-188">If you follow the guidance shown in the article above, you can add this class to your project as-is without having to make any changes.</span></span> <span data-ttu-id="38583-189">もちろん、特定のシナリオに合わせて、以下のコードを自由にカスタマイズすることも可能です。</span><span class="sxs-lookup"><span data-stu-id="38583-189">Of course, you can feel free to customize the following code to meet the needs of your particular scenario.</span></span>

<span data-ttu-id="38583-190">このヘルパー クラスは、デバイスの [**SimpleOrientationSensor**](https://docs.microsoft.com/uwp/api/Windows.Devices.Sensors.SimpleOrientationSensor) を使用してデバイス シャーシの現在の向きを特定し、[**DisplayInformation**](https://docs.microsoft.com/uwp/api/Windows.Graphics.Display.DisplayInformation) クラスを使用してディスプレイの現在の向きを特定します。</span><span class="sxs-lookup"><span data-stu-id="38583-190">This helper class uses the device's [**SimpleOrientationSensor**](https://docs.microsoft.com/uwp/api/Windows.Devices.Sensors.SimpleOrientationSensor) to determine the current orientation of the device chassis and the [**DisplayInformation**](https://docs.microsoft.com/uwp/api/Windows.Graphics.Display.DisplayInformation) class to determine the current orientation of the display.</span></span> <span data-ttu-id="38583-191">これらの各クラスは、現在の向きが変更されたときに発生するイベントを提供します。</span><span class="sxs-lookup"><span data-stu-id="38583-191">Each of these classes provide events that are raised when the current orientation changes.</span></span> <span data-ttu-id="38583-192">キャプチャ デバイスが取り付けられている、正面、背面、または外部のパネルは、プレビュー ストリームを左右反転する必要があるかどうかを特定するために使われます。</span><span class="sxs-lookup"><span data-stu-id="38583-192">The panel on which the capture device is mounted - front-facing, back-facing, or external - is used to determine whether the preview stream should be mirrored.</span></span> <span data-ttu-id="38583-193">また、一部のデバイスでサポートされる [**EnclosureLocation.RotationAngleInDegreesClockwise**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.enclosurelocation.rotationangleindegreesclockwise) プロパティは、シャーシに取り付けられているカメラの向きを特定するために使われます。</span><span class="sxs-lookup"><span data-stu-id="38583-193">Also, the [**EnclosureLocation.RotationAngleInDegreesClockwise**](https://docs.microsoft.com/uwp/api/windows.devices.enumeration.enclosurelocation.rotationangleindegreesclockwise) property, supported by some devices, is used to determine the orientation in which the camera is mounted on the chasses.</span></span>

<span data-ttu-id="38583-194">以下のメソッドを使えば、特定のカメラ アプリのタスクに推奨される向きの値を取得することができます。</span><span class="sxs-lookup"><span data-stu-id="38583-194">The following methods can be used to get recommended orientation values for the specified camera app tasks:</span></span>

* <span data-ttu-id="38583-195">**GetUIOrientation** - カメラの UI 要素に対する向きの候補が返されます。</span><span class="sxs-lookup"><span data-stu-id="38583-195">**GetUIOrientation** - Returns the suggested orientation for camera UI elements.</span></span>
* <span data-ttu-id="38583-196">**GetCameraCaptureOrientation** - 画像のメタデータへのエンコーディングに対する向きの候補が返されます。</span><span class="sxs-lookup"><span data-stu-id="38583-196">**GetCameraCaptureOrientation** - Returns the suggested orientation for encoding into image metadata.</span></span>
* <span data-ttu-id="38583-197">**GetCameraPreviewOrientation** - 自然なユーザー エクスペリエンスを実現するための、プレビュー ストリームの向きの候補が返されます。</span><span class="sxs-lookup"><span data-stu-id="38583-197">**GetCameraPreviewOrientation** - Returns the suggested orientation for the preview stream to provide a natural user experience.</span></span>

[!code-cs[CameraRotationHelperFull](./code/SimpleCameraPreview_Win10/cs/CameraRotationHelper.cs#SnippetCameraRotationHelperFull)]



## <a name="related-topics"></a><span data-ttu-id="38583-198">関連トピック</span><span class="sxs-lookup"><span data-stu-id="38583-198">Related topics</span></span>

* [<span data-ttu-id="38583-199">カメラ</span><span class="sxs-lookup"><span data-stu-id="38583-199">Camera</span></span>](camera.md)
* [<span data-ttu-id="38583-200">MediaCapture で基本的な写真、ビデオ、およびオーディオのキャプチャします。</span><span class="sxs-lookup"><span data-stu-id="38583-200">Basic photo, video, and audio capture with MediaCapture</span></span>](basic-photo-video-and-audio-capture-with-MediaCapture.md)
 

 




