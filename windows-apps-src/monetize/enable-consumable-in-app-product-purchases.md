---
Description: 使用できるように、アプリ内製品を提供して &\#8212; 購入可能な項目が使用され、もう一度購入 &\#8212; ストアを通じて購入のお客様のエクスペリエンスが提供するコマース プラットフォームは両方の堅牢なと信頼性の高い。
title: コンシューマブルなアプリ内製品購入の有効化
ms.assetid: F79EE369-ACFC-4156-AF6A-72D1C7D3BDA4
keywords: UWP, コンシューマブル, アドオン, アプリ内購入, IAP, Windows.ApplicationModel.Store
ms.date: 08/25/2017
ms.topic: article
ms.localizationpriority: medium
ms.openlocfilehash: 5588558eff3e9c9b2954f0726995765a2862c43b
ms.sourcegitcommit: b034650b684a767274d5d88746faeea373c8e34f
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/06/2019
ms.locfileid: "57655647"
---
# <a name="enable-consumable-in-app-product-purchases"></a><span data-ttu-id="435ab-104">コンシューマブルなアプリ内製品購入の有効化</span><span class="sxs-lookup"><span data-stu-id="435ab-104">Enable consumable in-app product purchases</span></span>

<span data-ttu-id="435ab-105">ストアの商取引プラットフォームを使ってコンシューマブルなアプリ内製品 (購入、使用、再購入が可能なアイテム) をサポートすると、堅牢かつ信頼性の高いアプリ内購入エクスペリエンスを顧客に提供できます。</span><span class="sxs-lookup"><span data-stu-id="435ab-105">Offer consumable in-app products—items that can be purchased, used, and purchased again—through the Store commerce platform to provide your customers with a purchase experience that is both robust and reliable.</span></span> <span data-ttu-id="435ab-106">これは、購入して、特定のパワーアップを購入するために使うことができるゲーム内通貨 (ゴールド、コインなど) 用に特に便利です。</span><span class="sxs-lookup"><span data-stu-id="435ab-106">This is especially useful for things like in-game currency (gold, coins, etc.) that can be purchased and then used to purchase specific power-ups.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="435ab-107">この記事では、[Windows.ApplicationModel.Store](https://msdn.microsoft.com/library/windows/apps/windows.applicationmodel.store.aspx) 名前空間のメンバーを使って、コンシューマブルなアプリ内製品の購入を有効化する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="435ab-107">This article demonstrates how to use members of the [Windows.ApplicationModel.Store](https://msdn.microsoft.com/library/windows/apps/windows.applicationmodel.store.aspx) namespace to enable consumable in-app product purchases.</span></span> <span data-ttu-id="435ab-108">この名前空間は更新されなくなり、新機能も追加されないため、代わりに [Windows.Services.Store](https://msdn.microsoft.com/library/windows/apps/windows.services.store.aspx) 名前空間を使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="435ab-108">This namespace is no longer being updated with new features, and we recommend that you use the [Windows.Services.Store](https://msdn.microsoft.com/library/windows/apps/windows.services.store.aspx) namespace instead.</span></span> <span data-ttu-id="435ab-109">**Windows.Services.Store**名前空間が消耗アドオンの管理対象の Store や、サブスクリプションなど、最新のアドオン型をサポートしているしは将来の種類の製品とパートナーによってサポートされる機能に対応するように設計されていますCenter とストア。</span><span class="sxs-lookup"><span data-stu-id="435ab-109">The **Windows.Services.Store** namespace supports the latest add-on types, such as Store-managed consumable add-ons and subscriptions, and is designed to be compatible with future types of products and features supported by Partner Center and the Store.</span></span> <span data-ttu-id="435ab-110">**Windows.Services.Store** 名前空間は、Windows 10 バージョン 1607 で導入され、Visual Studio で、**Windows 10 Anniversary Edition (10.0、ビルド 14393)** 以降のリリースをターゲットとするプロジェクトでのみ使用できます。</span><span class="sxs-lookup"><span data-stu-id="435ab-110">The **Windows.Services.Store** namespace was introduced in Windows 10, version 1607, and it can only be used in projects that target **Windows 10 Anniversary Edition (10.0; Build 14393)** or a later release in Visual Studio.</span></span> <span data-ttu-id="435ab-111">**Windows.Services.Store** 名前空間を使用したコンシューマブルなアプリ内製品購入の有効化について詳しくは、[この記事](enable-consumable-add-on-purchases.md)をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="435ab-111">For more information about enabling consumable in-app product purchases using the **Windows.Services.Store** namespace, see [this article](enable-consumable-add-on-purchases.md).</span></span>

## <a name="prerequisites"></a><span data-ttu-id="435ab-112">前提条件</span><span class="sxs-lookup"><span data-stu-id="435ab-112">Prerequisites</span></span>

-   <span data-ttu-id="435ab-113">このトピックでは、コンシューマブルなアプリ内製品の購入とフルフィルメントの完了報告について説明します。</span><span class="sxs-lookup"><span data-stu-id="435ab-113">This topic covers the purchase and fulfillment reporting of consumable in-app products.</span></span> <span data-ttu-id="435ab-114">アプリ内製品に詳しくない場合は、「[アプリ内製品購入の有効化](enable-in-app-product-purchases.md)」を読んで、ライセンス情報と、ストアでアプリ内製品を適切に一覧表示する方法を確かめてください。</span><span class="sxs-lookup"><span data-stu-id="435ab-114">If you are unfamiliar with in-app products, please review [Enable in-app product purchases](enable-in-app-product-purchases.md) to learn about license information, and how to properly list in-app products in the Store.</span></span>
-   <span data-ttu-id="435ab-115">新しいアプリ内製品のコード記述やテストを初めて行うときは、[CurrentApp](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Store.CurrentApp) オブジェクトではなく、[CurrentAppSimulator](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Store.CurrentAppSimulator) オブジェクトを使う必要があります。</span><span class="sxs-lookup"><span data-stu-id="435ab-115">When you code and test new in-app products for the first time, you must use the [CurrentAppSimulator](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Store.CurrentAppSimulator) object instead of the [CurrentApp](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Store.CurrentApp) object.</span></span> <span data-ttu-id="435ab-116">そうすることで、実稼働サーバーを呼び出すのではなく、ライセンス サーバーへのシミュレートされた呼び出しを使って、ライセンス ロジックを検証できます。</span><span class="sxs-lookup"><span data-stu-id="435ab-116">This way you can verify your license logic using simulated calls to the license server instead of calling the live server.</span></span> <span data-ttu-id="435ab-117">これを行うには、%userprofile% WindowsStoreProxy.xml をという名前のファイルをカスタマイズする必要があります\\AppData\\ローカル\\パッケージ\\&lt;パッケージ名&gt;\\LocalState\\Microsoft\\Windows ストア\\ApiData します。</span><span class="sxs-lookup"><span data-stu-id="435ab-117">To do this, you need to customize the file named WindowsStoreProxy.xml in %userprofile%\\AppData\\local\\packages\\&lt;package name&gt;\\LocalState\\Microsoft\\Windows Store\\ApiData.</span></span> <span data-ttu-id="435ab-118">このファイルは、アプリを初めて実行するときに Microsoft Visual Studio シミュレーターによって作られます。カスタマイズされたファイルを実行時に読み込むこともできます。</span><span class="sxs-lookup"><span data-stu-id="435ab-118">The Microsoft Visual Studio simulator creates this file when you run your app for the first time—or you can also load a custom one at runtime.</span></span> <span data-ttu-id="435ab-119">詳しくは、「[CurrentAppSimulator での WindowsStoreProxy.xml ファイルの使用](in-app-purchases-and-trials-using-the-windows-applicationmodel-store-namespace.md#proxy)」をご覧ください。</span><span class="sxs-lookup"><span data-stu-id="435ab-119">For more info, see [Using the WindowsStoreProxy.xml file with CurrentAppSimulator](in-app-purchases-and-trials-using-the-windows-applicationmodel-store-namespace.md#proxy).</span></span>
-   <span data-ttu-id="435ab-120">このトピックでは、[ストア サンプル](https://github.com/Microsoft/Windows-universal-samples/tree/win10-1507/Samples/Store)で提供されているコード例も参照します。</span><span class="sxs-lookup"><span data-stu-id="435ab-120">This topic also references code examples provided in the [Store sample](https://github.com/Microsoft/Windows-universal-samples/tree/win10-1507/Samples/Store).</span></span> <span data-ttu-id="435ab-121">このサンプルを利用すると、ユニバーサル Windows プラットフォーム (UWP) アプリに提供されるさまざまな収益化オプションを体験できます。</span><span class="sxs-lookup"><span data-stu-id="435ab-121">This sample is a great way to get hands-on experience with the different monetization options provided for Universal Windows Platform (UWP) apps.</span></span>

## <a name="step-1-making-the-purchase-request"></a><span data-ttu-id="435ab-122">手順 1:購入要求を行う</span><span class="sxs-lookup"><span data-stu-id="435ab-122">Step 1: Making the purchase request</span></span>

<span data-ttu-id="435ab-123">最初の購買要求は、ストアを通じて行われた他の購入と同様に、[RequestProductPurchaseAsync](https://docs.microsoft.com/uwp/api/windows.applicationmodel.store.currentapp.requestproductpurchaseasync) を使って行います。</span><span class="sxs-lookup"><span data-stu-id="435ab-123">The initial purchase request is made with [RequestProductPurchaseAsync](https://docs.microsoft.com/uwp/api/windows.applicationmodel.store.currentapp.requestproductpurchaseasync) like any other purchase made through the Store.</span></span> <span data-ttu-id="435ab-124">コンシューマブルなアプリ内製品に関する違いとして、購入が成功した後、その購入に対するフルフィルメントが正常に完了したことをアプリがストアに通知するまで、顧客は同じ製品をもう一度購入することができません。</span><span class="sxs-lookup"><span data-stu-id="435ab-124">The difference for consumable in-app products is that after a successful purchase, a customer cannot purchase the same product again until the app has notified the Store that the previous purchase was successfully fulfilled.</span></span> <span data-ttu-id="435ab-125">アプリは、購入されたコンシューマブルのフルフィルメントを処理し、ストアにフルフィルメントの完了を通知する責任を負います。</span><span class="sxs-lookup"><span data-stu-id="435ab-125">It's your app's responsibility to fulfill purchased consumables and notify the Store of the fulfillment.</span></span>

<span data-ttu-id="435ab-126">次の例は、コンシューマブルなアプリ内製品の購入要求を示しています。</span><span class="sxs-lookup"><span data-stu-id="435ab-126">The following example shows a consumable in-app product purchase request.</span></span> <span data-ttu-id="435ab-127">コードのコメントに、購入要求が成功した場合と同じ製品の購入のフルフィルメントが完了していないことが原因で購入要求が成功しなかった場合の 2 つの異なるシナリオについて、アプリがコンシューマブルなアプリ内製品のローカル フルフィルメントをいつ完了する必要があるかが示されています。</span><span class="sxs-lookup"><span data-stu-id="435ab-127">You'll notice code comments indicating when your app should conduct its local fulfillment of the consumable in-app product for two different scenarios—when the request is successful, and when the request is not successful because of an unfulfilled purchase of that same product.</span></span>

> [!div class="tabbedCodeSnippets"]
[!code-cs[EnableConsumablePurchases](./code/InAppPurchasesAndLicenses/cs/EnableConsumablePurchases.cs#MakePurchaseRequest)]

## <a name="step-2-tracking-local-fulfillment-of-the-consumable"></a><span data-ttu-id="435ab-128">手順 2:ローカルの調達、消耗品の追跡</span><span class="sxs-lookup"><span data-stu-id="435ab-128">Step 2: Tracking local fulfillment of the consumable</span></span>

<span data-ttu-id="435ab-129">コンシューマブルなアプリ内製品へのアクセスを顧客に許可するとき、フルフィルメントの対象になっている製品 (*productId*) と、フルフィルメントが関連付けられているトランザクション (*transactionId*) を追跡することが重要です。</span><span class="sxs-lookup"><span data-stu-id="435ab-129">When granting your customer access to the consumable in-app product, it's important to keep track of which product is fulfilled (*productId*), and which transaction that fulfillment is associated with (*transactionId*).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="435ab-130">アプリは、ストアにフルフィルメントの完了を正確に報告する必要があります。</span><span class="sxs-lookup"><span data-stu-id="435ab-130">Your app is responsible for the accurately reporting fulfillment to the Store.</span></span> <span data-ttu-id="435ab-131">この手順は、顧客が体験する公正で信頼できる購入エクスペリエンスを維持するために必要です。</span><span class="sxs-lookup"><span data-stu-id="435ab-131">This step is essential to maintaining a fair and reliable purchase experience for your customers.</span></span>

<span data-ttu-id="435ab-132">次の例では、前の手順の [RequestProductPurchaseAsync](https://docs.microsoft.com/uwp/api/windows.applicationmodel.store.currentapp.requestproductpurchaseasync) 呼び出しの [PurchaseResults](https://msdn.microsoft.com/library/windows/apps/dn263392)プロパティを使って、フルフィルメントの対象となる、購入された製品を識別しています。</span><span class="sxs-lookup"><span data-stu-id="435ab-132">The following example demonstrates use of the [PurchaseResults](https://msdn.microsoft.com/library/windows/apps/dn263392) properties from the [RequestProductPurchaseAsync](https://docs.microsoft.com/uwp/api/windows.applicationmodel.store.currentapp.requestproductpurchaseasync) call in the previous step to identify the purchased product for fulfillment.</span></span> <span data-ttu-id="435ab-133">ローカル フルフィルメントが成功したことを確かめるために、コレクションを使って後で参照できる場所に製品情報が保存されます。</span><span class="sxs-lookup"><span data-stu-id="435ab-133">A collection is used to store the product information in a location that can later be referenced to confirm that local fulfillment was successful.</span></span>

> [!div class="tabbedCodeSnippets"]
[!code-cs[EnableConsumablePurchases](./code/InAppPurchasesAndLicenses/cs/EnableConsumablePurchases.cs#GrantFeatureLocally)]

<span data-ttu-id="435ab-134">次の例では、前の例の配列を使って、後でストアにフルフィルメントを報告するときに使われる製品 ID とトランザクション ID のペアにアクセスする方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="435ab-134">This next example shows how to use the array from the previous example to access product ID/transaction ID pairs that are later used when reporting fulfillment to the Store.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="435ab-135">フルフィルメントの追跡と確認のために使っている方法を問わず、アプリは、顧客が受け取っていないアイテムに対して課金されることのないように適正評価を行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="435ab-135">Whatever methodology your app uses to track and confirm fulfillment, your app must demonstrate due diligence to ensure that your customers are not charged for items they haven't received.</span></span>

> [!div class="tabbedCodeSnippets"]
[!code-cs[EnableConsumablePurchases](./code/InAppPurchasesAndLicenses/cs/EnableConsumablePurchases.cs#IsLocallyFulfilled)]

## <a name="step-3-reporting-product-fulfillment-to-the-store"></a><span data-ttu-id="435ab-136">手順 3:ストアへのレポート製品フルフィルメント</span><span class="sxs-lookup"><span data-stu-id="435ab-136">Step 3: Reporting product fulfillment to the Store</span></span>

<span data-ttu-id="435ab-137">ローカル フルフィルメントが完了した後、アプリは、*productId* と製品購入が含まれるトランザクションを含む [ReportConsumableFulfillmentAsync](https://docs.microsoft.com/uwp/api/windows.applicationmodel.store.currentapp.reportconsumablefulfillmentasync) 呼び出しを行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="435ab-137">After local fulfillment is completed, your app must make a [ReportConsumableFulfillmentAsync](https://docs.microsoft.com/uwp/api/windows.applicationmodel.store.currentapp.reportconsumablefulfillmentasync) call that includes the *productId* and the transaction the product purchase is included in.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="435ab-138">フルフィルメントが完了したコンシューマブルなアプリ内製品をストアに報告しなかった場合、ユーザーは、前回の購入のフルフィルメントが報告されるまで、その製品をもう一度購入することができなくなります。</span><span class="sxs-lookup"><span data-stu-id="435ab-138">Failure to report fulfilled consumable in-app products to the Store will result in the user being unable to purchase that product again until fulfillment for the previous purchase is reported.</span></span>

> [!div class="tabbedCodeSnippets"]
[!code-cs[EnableConsumablePurchases](./code/InAppPurchasesAndLicenses/cs/EnableConsumablePurchases.cs#ReportFulfillment)]

## <a name="step-4-identifying-unfulfilled-purchases"></a><span data-ttu-id="435ab-139">手順 4:条件を満たさなく購入を識別します。</span><span class="sxs-lookup"><span data-stu-id="435ab-139">Step 4: Identifying unfulfilled purchases</span></span>

<span data-ttu-id="435ab-140">アプリでは、[GetUnfulfilledConsumablesAsync](https://docs.microsoft.com/uwp/api/windows.applicationmodel.store.currentapp.getunfulfilledconsumablesasync) メソッドを使って、コンシューマブルなアプリ内製品に対するフルフィルメントの未完了をいつでも確認することができます。</span><span class="sxs-lookup"><span data-stu-id="435ab-140">Your app can use the [GetUnfulfilledConsumablesAsync](https://docs.microsoft.com/uwp/api/windows.applicationmodel.store.currentapp.getunfulfilledconsumablesasync) method to check for unfulfilled consumable in-app products at any time.</span></span> <span data-ttu-id="435ab-141">このメソッドは、ネットワーク接続の中断やアプリの終了など、予期しないアプリのイベントが原因でフルフィルメントが完了していないコンシューマブルを調べるために、定期的に呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="435ab-141">This method should be called on a regular basis to check for unfulfilled consumables that exist due to unanticipated app events like an interruption in network connectivity or app termination.</span></span>

<span data-ttu-id="435ab-142">次の例に、[GetUnfulfilledConsumablesAsync](https://docs.microsoft.com/uwp/api/windows.applicationmodel.store.currentapp.getunfulfilledconsumablesasync) を使ってフルフィルメントが未完了のコンシューマブルを列挙する方法と、アプリでこの一覧を反復処理してローカル フルフィルメントを完了する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="435ab-142">The following example demonstrates how [GetUnfulfilledConsumablesAsync](https://docs.microsoft.com/uwp/api/windows.applicationmodel.store.currentapp.getunfulfilledconsumablesasync) can be used to enumerate unfulfilled consumables, and how your app can iterate through this list to complete local fulfillment.</span></span>

> [!div class="tabbedCodeSnippets"]
[!code-cs[EnableConsumablePurchases](./code/InAppPurchasesAndLicenses/cs/EnableConsumablePurchases.cs#GetUnfulfilledConsumables)]

## <a name="related-topics"></a><span data-ttu-id="435ab-143">関連トピック</span><span class="sxs-lookup"><span data-stu-id="435ab-143">Related topics</span></span>

* [<span data-ttu-id="435ab-144">アプリ内製品購入を有効にする</span><span class="sxs-lookup"><span data-stu-id="435ab-144">Enable in-app product purchases</span></span>](enable-in-app-product-purchases.md)
* [<span data-ttu-id="435ab-145">ストアのサンプル (試用版とアプリ内購入のデモンストレーション)</span><span class="sxs-lookup"><span data-stu-id="435ab-145">Store sample (demonstrates trials and in-app purchases)</span></span>](https://github.com/Microsoft/Windows-universal-samples/tree/win10-1507/Samples/Store)
* [<span data-ttu-id="435ab-146">Windows.ApplicationModel.Store</span><span class="sxs-lookup"><span data-stu-id="435ab-146">Windows.ApplicationModel.Store</span></span>](https://msdn.microsoft.com/library/windows/apps/br225197)
 

 
